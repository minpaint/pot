# Generated by Django 5.0.14 on 2025-12-12 07:11

import django.db.models.deletion
from django.db import migrations, models
from django.utils.text import slugify
import re


def simplify_categories_forward(apps, schema_editor):
    """
    –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Å—Ç–∞—Ä–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –≤ –Ω–æ–≤—É—é:
    1. –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–¥–æ–±–∞–≤–ª—è–µ–º code, —É–±–∏—Ä–∞–µ–º organization)
    2. –ü–µ—Ä–µ–Ω–æ—Å–∏–º organization –æ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∫ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è–º
    3. –û–±—ä–µ–¥–∏–Ω—è–µ–º –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    """
    KeyDeadlineCategory = apps.get_model('deadline_control', 'KeyDeadlineCategory')
    KeyDeadlineItem = apps.get_model('deadline_control', 'KeyDeadlineItem')

    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    all_categories = list(KeyDeadlineCategory.objects.all().order_by('id'))

    if not all_categories:
        print("[INFO] –ù–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏")
        return

    print(f"[INFO] –ù–∞–π–¥–µ–Ω–æ {len(all_categories)} –∫–∞—Ç–µ–≥–æ—Ä–∏–π")

    # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ –∏–º–µ–Ω–∏
    categories_by_name = {}
    for cat in all_categories:
        if cat.name not in categories_by_name:
            categories_by_name[cat.name] = []
        categories_by_name[cat.name].append(cat)

    print(f"[INFO] –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π: {len(categories_by_name)}")

    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é –≥—Ä—É–ø–ø—É
    category_mapping = {}  # {old_cat_id: primary_cat_id}

    for idx, (cat_name, cat_group) in enumerate(categories_by_name.items(), start=1):
        # –ë–µ—Ä—ë–º –ø–µ—Ä–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω—É—é
        primary_cat = cat_group[0]

        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥
        base_code = re.sub(r'[^a-zA-Z0-9_]', '', slugify(cat_name, allow_unicode=True))
        if not base_code:
            base_code = f'category_{idx}'
        code = base_code[:50]

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –∫–æ–¥–∞
        counter = 1
        while KeyDeadlineCategory.objects.filter(code=code).exclude(id=primary_cat.id).exists():
            code = f'{base_code[:45]}_{counter}'
            counter += 1

        # –û–±–Ω–æ–≤–ª—è–µ–º primary –∫–∞—Ç–µ–≥–æ—Ä–∏—é
        primary_cat.code = code
        primary_cat.icon = 'üìã'
        primary_cat.sort_order = idx * 10
        primary_cat.organization = None  # –£–±–∏—Ä–∞–µ–º –ø—Ä–∏–≤—è–∑–∫—É –∫ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
        primary_cat.save()

        print(f"[OK] –û–±–Ω–æ–≤–ª–µ–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è: {cat_name} (–∫–æ–¥: {code}, ID: {primary_cat.id})")

        # –ü–µ—Ä–µ–Ω–æ—Å–∏–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –∏–∑ –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        for cat in cat_group:
            category_mapping[cat.id] = primary_cat.id

            # –ü–æ–ª—É—á–∞–µ–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            items = KeyDeadlineItem.objects.filter(category_id=cat.id)

            for item in items:
                # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º organization –∏–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                item.organization_id = cat.organization_id
                # –ü–µ—Ä–µ–Ω–∞—Ü–µ–ª–∏–≤–∞–µ–º –Ω–∞ primary –∫–∞—Ç–µ–≥–æ—Ä–∏—é
                item.category_id = primary_cat.id
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º is_active –æ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                if hasattr(cat, 'is_active') and not cat.is_active:
                    item.is_active = False
                item.save()

        print(f"   - –ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π: {sum(KeyDeadlineItem.objects.filter(category_id=c.id).count() for c in cat_group)}")

    # –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    to_delete = []
    for cat_name, cat_group in categories_by_name.items():
        if len(cat_group) > 1:
            # –£–¥–∞–ª—è–µ–º –≤—Å–µ –∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–π
            to_delete.extend(cat_group[1:])

    if to_delete:
        deleted_ids = [cat.id for cat in to_delete]
        KeyDeadlineCategory.objects.filter(id__in=deleted_ids).delete()
        print(f"[OK] –£–¥–∞–ª–µ–Ω–æ –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π: {len(to_delete)}")


def simplify_categories_backward(apps, schema_editor):
    """
    –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ - –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
    """
    KeyDeadlineCategory = apps.get_model('deadline_control', 'KeyDeadlineCategory')
    KeyDeadlineItem = apps.get_model('deadline_control', 'KeyDeadlineItem')

    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
    items = KeyDeadlineItem.objects.all().select_related('category', 'organization')

    # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ (category, organization)
    category_org_map = {}
    for item in items:
        key = (item.category.name, item.organization_id)
        if key not in category_org_map:
            # –°–æ–∑–¥–∞—ë–º —Å—Ç–∞—Ä—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é (—Å organization)
            old_category = KeyDeadlineCategory.objects.create(
                name=item.category.name,
                organization_id=item.organization_id,
                description=item.category.description,
                is_active=True
            )
            category_org_map[key] = old_category

        # –û–±–Ω–æ–≤–ª—è–µ–º item
        item.category = category_org_map[key]
        item.organization = None
        item.save()

    print(f"[OK] –û—Ç–∫–∞—Ç –∑–∞–≤–µ—Ä—à–µ–Ω, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ {len(category_org_map)} —Å—Ç–∞—Ä—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π")


class Migration(migrations.Migration):

    dependencies = [
        ('deadline_control', '0023_convert_email_template_to_reference_pattern'),
        ('directory', '0049_add_email_recipient_system'),
    ]

    operations = [
        migrations.AlterModelOptions(
            name='keydeadlinecategory',
            options={'ordering': ['sort_order', 'name'], 'verbose_name': '–ö–∞—Ç–µ–≥–æ—Ä–∏—è –∫–ª—é—á–µ–≤—ã—Ö —Å—Ä–æ–∫–æ–≤', 'verbose_name_plural': '–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∫–ª—é—á–µ–≤—ã—Ö —Å—Ä–æ–∫–æ–≤'},
        ),
        migrations.AlterUniqueTogether(
            name='keydeadlinecategory',
            unique_together=set(),
        ),

        # –®–ê–ì 1: –°–¥–µ–ª–∞—Ç—å —Å—Ç–∞—Ä—ã–µ –ø–æ–ª—è nullable –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏
        migrations.AlterField(
            model_name='keydeadlinecategory',
            name='organization',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, related_name='key_deadline_categories', to='directory.organization', verbose_name='–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è'),
        ),

        # –®–ê–ì 2: –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –ø–æ–ª—è
        migrations.AddField(
            model_name='keydeadlinecategory',
            name='code',
            field=models.CharField(default='temp', help_text="–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∫–æ–¥–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 'training_ot')", max_length=50, unique=True, verbose_name='–ö–æ–¥ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'),
        ),
        migrations.AddField(
            model_name='keydeadlinecategory',
            name='icon',
            field=models.CharField(default='üìã', help_text='Emoji –∏–∫–æ–Ω–∫–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ', max_length=10, verbose_name='–ò–∫–æ–Ω–∫–∞'),
        ),
        migrations.AddField(
            model_name='keydeadlinecategory',
            name='sort_order',
            field=models.PositiveIntegerField(default=0, help_text='–ü–æ—Ä—è–¥–æ–∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Å–ø–∏—Å–∫–∞—Ö (–º–µ–Ω—å—à–µ = –≤—ã—à–µ)', verbose_name='–ü–æ—Ä—è–¥–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏'),
        ),
        migrations.AddField(
            model_name='keydeadlineitem',
            name='is_active',
            field=models.BooleanField(default=True, help_text='–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –Ω–µ —É—á–∞—Å—Ç–≤—É—é—Ç –≤ —Ä–∞—Å—Å—ã–ª–∫–∞—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π', verbose_name='–ê–∫—Ç–∏–≤–Ω–æ'),
        ),
        migrations.AddField(
            model_name='keydeadlineitem',
            name='organization',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, related_name='key_deadline_items', to='directory.organization', verbose_name='–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è'),
        ),
        migrations.AlterField(
            model_name='keydeadlinecategory',
            name='name',
            field=models.CharField(help_text="–ù–∞–ø—Ä–∏–º–µ—Ä: '–û–±—É—á–µ–Ω–∏–µ –ø–æ –û–¢', '–ò–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–∏'", max_length=255, unique=True, verbose_name='–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'),
        ),
        migrations.AlterField(
            model_name='keydeadlineitem',
            name='category',
            field=models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, related_name='items', to='deadline_control.keydeadlinecategory', verbose_name='–ö–∞—Ç–µ–≥–æ—Ä–∏—è'),
        ),

        # –®–ê–ì 3: –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
        migrations.RunPython(simplify_categories_forward, simplify_categories_backward),

        # –®–ê–ì 4: –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –ø–æ–ª—è
        migrations.RemoveField(
            model_name='keydeadlinecategory',
            name='email_template',
        ),
        migrations.RemoveField(
            model_name='keydeadlinecategory',
            name='is_active',
        ),
        migrations.RemoveField(
            model_name='keydeadlinecategory',
            name='organization',
        ),
    ]
