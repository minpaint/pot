# Generated by Django 5.0.14 on 2025-12-12 12:54

import django.db.models.deletion
from django.db import migrations, models


def migrate_data_forward(apps, schema_editor):
    """
    –ü–µ—Ä–µ–Ω–æ—Å–∏–º –¥–∞–Ω–Ω—ã–µ:
    1. organization –∏–∑ category –≤ item
    2. –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –æ—Å—Ç–∞–≤–ª—è—è –ø–æ –æ–¥–Ω–æ–π
    """
    KeyDeadlineCategory = apps.get_model('deadline_control', 'KeyDeadlineCategory')
    KeyDeadlineItem = apps.get_model('deadline_control', 'KeyDeadlineItem')

    print("[INFO] –ù–∞—á–∏–Ω–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏—é –∫ —Å–ø—Ä–∞–≤–æ—á–Ω—ã–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º...")

    # 1. –ü–µ—Ä–µ–Ω–æ—Å–∏–º organization –≤ items
    items = KeyDeadlineItem.objects.all().select_related('category')
    for item in items:
        if item.category and hasattr(item.category, 'organization_id'):
            item.organization_id = item.category.organization_id
            item.save()
            print(f"[OK] –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ '{item.name}' -> –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è ID {item.organization_id}")

    # 2. –û–±—ä–µ–¥–∏–Ω—è–µ–º –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    category_map = {}  # name -> –ø–µ—Ä–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º
    categories_to_delete = []

    for category in KeyDeadlineCategory.objects.all():
        if category.name not in category_map:
            # –ü–µ—Ä–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º - –æ—Å—Ç–∞–≤–ª—è–µ–º
            category_map[category.name] = category
            print(f"[OK] –û—Å—Ç–∞–≤–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é: {category.name}")
        else:
            # –î—É–±–ª–∏–∫–∞—Ç - –ø–µ—Ä–µ–Ω–æ—Å–∏–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –Ω–∞ –ø–µ—Ä–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
            canonical_category = category_map[category.name]
            items_to_update = KeyDeadlineItem.objects.filter(category=category)
            count = items_to_update.count()
            if count > 0:
                items_to_update.update(category=canonical_category)
                print(f"[OK] –ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ {count} –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π —Å –¥—É–±–ª–∏–∫–∞—Ç–∞ '{category.name}' –Ω–∞ –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫—É—é")
            categories_to_delete.append(category.id)

    # –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
    if categories_to_delete:
        KeyDeadlineCategory.objects.filter(id__in=categories_to_delete).delete()
        print(f"[OK] –£–¥–∞–ª–µ–Ω–æ {len(categories_to_delete)} –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π")

    print(f"[OK] –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –û—Å—Ç–∞–ª–æ—Å—å {len(category_map)} —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π")


def migrate_data_backward(apps, schema_editor):
    """–û—Ç–∫–∞—Ç –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω"""
    print("[INFO] –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω")


class Migration(migrations.Migration):

    dependencies = [
        ('deadline_control', '0027_update_verbose_names'),
        ('directory', '0049_add_email_recipient_system'),
    ]

    operations = [
        migrations.AlterModelOptions(
            name='keydeadlinecategory',
            options={'ordering': ['name'], 'verbose_name': '–ö–∞—Ç–µ–≥–æ—Ä–∏—è', 'verbose_name_plural': 'üìã –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ (—Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫)'},
        ),
        migrations.AlterUniqueTogether(
            name='keydeadlinecategory',
            unique_together=set(),
        ),
        migrations.AddField(
            model_name='keydeadlineitem',
            name='organization',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, related_name='key_deadline_items', to='directory.organization', verbose_name='–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è'),
        ),
        migrations.AddField(
            model_name='keydeadlineitem',
            name='periodicity_months',
            field=models.PositiveIntegerField(blank=True, help_text='–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å –∏–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏. –ï—Å–ª–∏ –ø—É—Å—Ç–æ - –±–µ—Ä–µ—Ç—Å—è –∏–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏', null=True, verbose_name='–°—Ä–æ–∫ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è (–º–µ—Å—è—Ü–µ–≤)'),
        ),
        migrations.AlterField(
            model_name='keydeadlinecategory',
            name='name',
            field=models.CharField(help_text="–ù–∞–ø—Ä–∏–º–µ—Ä: '–ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂', '–ê—Ç—Ç–µ—Å—Ç–∞—Ü–∏—è —Ä–∞–±–æ—á–∏—Ö –º–µ—Å—Ç'", max_length=255, verbose_name='–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'),
        ),
        migrations.AlterField(
            model_name='keydeadlinecategory',
            name='periodicity_months',
            field=models.PositiveIntegerField(blank=True, help_text='–ü–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏', null=True, verbose_name='–ü–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å (–º–µ—Å—è—Ü–µ–≤)'),
        ),
        migrations.AlterField(
            model_name='keydeadlineitem',
            name='next_date',
            field=models.DateField(blank=True, editable=False, help_text='–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞—Ç—ã –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –∏ –ø–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç–∏', null=True, verbose_name='–î–∞—Ç–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è'),
        ),

        # –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
        migrations.RunPython(migrate_data_forward, migrate_data_backward),

        migrations.RemoveField(
            model_name='keydeadlinecategory',
            name='organization',
        ),

        # –î–æ–±–∞–≤–ª—è–µ–º unique constraint –ü–û–°–õ–ï —É–¥–∞–ª–µ–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
        migrations.AlterField(
            model_name='keydeadlinecategory',
            name='name',
            field=models.CharField(help_text="–ù–∞–ø—Ä–∏–º–µ—Ä: '–ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂', '–ê—Ç—Ç–µ—Å—Ç–∞—Ü–∏—è —Ä–∞–±–æ—á–∏—Ö –º–µ—Å—Ç'", max_length=255, unique=True, verbose_name='–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'),
        ),
    ]
