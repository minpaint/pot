{% extends "base.html" %}
{% load static %}
{% load medical_filters %}

{% block title %}üè• –ú–µ–¥–æ—Å–º–æ—Ç—Ä—ã - {{ employee.full_name_nominative }}{% endblock %}

{% block extra_css %}
<style>
    .medical-card {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        padding: 20px;
        margin-bottom: 20px;
    }
    .status-badge {
        display: inline-block;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
        margin-bottom: 10px;
    }
    .status-no-date { background-color: #ffc107; color: #000; }
    .status-expired { background-color: #dc3545; color: #fff; }
    .status-upcoming { background-color: #fd7e14; color: #fff; }
    .status-normal { background-color: #28a745; color: #fff; }

    .factor-card {
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 15px;
        background: #f8f9fa;
    }
    .factor-card.expired {
        border-color: #dc3545;
        background: #f8d7da;
    }
    .factor-card.upcoming {
        border-color: #fd7e14;
        background: #fff3cd;
    }
    .factor-card.normal {
        border-color: #28a745;
        background: #d4edda;
    }
    .factor-card.disabled {
        border-color: #6c757d;
        background: #e9ecef;
        opacity: 0.6;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>üè• –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –æ—Å–º–æ—Ç—Ä—ã</h2>
            <p class="text-muted mb-0">{{ employee.full_name_nominative }}</p>
            <small class="text-muted">{{ employee.position.position_name }} ‚Ä¢ {{ employee.organization.short_name_ru }}</small>
        </div>
        <div>
            <a href="{% url 'deadline_control:medical:list' %}" class="btn btn-secondary">
                ‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É
            </a>
            <a href="{% url 'deadline_control:medical:referral_existing_employee' employee.id %}" class="btn btn-primary">
                üè• –í—ã–¥–∞—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            </a>
        </div>
    </div>

    <!-- –û–±—â–∏–π —Å—Ç–∞—Ç—É—Å -->
    {% if medical_status %}
    <div class="medical-card">
        <h4>–û–±—â–∏–π —Å—Ç–∞—Ç—É—Å –º–µ–¥–æ—Å–º–æ—Ç—Ä–æ–≤</h4>

        {% if medical_status.status == 'no_date' %}
            <span class="status-badge status-no-date">üìã –¢—Ä–µ–±—É–µ—Ç—Å—è –≤–Ω–µ—Å—Ç–∏ –¥–∞—Ç—É –º–µ–¥–æ—Å–º–æ—Ç—Ä–∞</span>
        {% elif medical_status.status == 'expired' %}
            <span class="status-badge status-expired">üö® –ú–µ–¥–æ—Å–º–æ—Ç—Ä –ø—Ä–æ—Å—Ä–æ—á–µ–Ω</span>
        {% elif medical_status.status == 'upcoming' %}
            <span class="status-badge status-upcoming">‚ö†Ô∏è –°–∫–æ—Ä–æ –∏—Å—Ç–µ–∫–∞–µ—Ç —Å—Ä–æ–∫</span>
        {% else %}
            <span class="status-badge status-normal">‚úÖ –ú–µ–¥–æ—Å–º–æ—Ç—Ä –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω</span>
        {% endif %}

        <div class="row mt-3">
            <div class="col-md-3">
                <strong>–î–∞—Ç–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è:</strong><br>
                {{ medical_status.date_completed|date:"d.m.Y"|default:"<span class='text-muted'>–ù–µ —É–∫–∞–∑–∞–Ω–∞</span>" }}
            </div>
            <div class="col-md-3">
                <strong>–°–ª–µ–¥—É—é—â–∏–π –º–µ–¥–æ—Å–º–æ—Ç—Ä:</strong><br>
                {{ medical_status.next_date|date:"d.m.Y"|default:"<span class='text-muted'>–ù–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞</span>" }}
            </div>
            <div class="col-md-3">
                <strong>–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å:</strong><br>
                {{ medical_status.min_periodicity }} –º–µ—Å.
            </div>
            <div class="col-md-3">
                <strong>–î–Ω–µ–π –¥–æ –º–µ–¥–æ—Å–º–æ—Ç—Ä–∞:</strong><br>
                {% if medical_status.days_until < 0 %}
                    <span class="text-danger fw-bold">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ {{ medical_status.days_until|abs_value }} –¥–Ω–µ–π</span>
                {% elif medical_status.days_until <= 30 %}
                    <span class="text-warning fw-bold">–û—Å—Ç–∞–ª–æ—Å—å {{ medical_status.days_until }} –¥–Ω–µ–π</span>
                {% else %}
                    <span class="text-success">–û—Å—Ç–∞–ª–æ—Å—å {{ medical_status.days_until }} –¥–Ω–µ–π</span>
                {% endif %}
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞—Ç—ã -->
        <div class="mt-3">
            <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#updateDateModal">
                üìÖ –ò–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—É –º–µ–¥–æ—Å–º–æ—Ç—Ä–∞
            </button>
        </div>
    </div>
    {% endif %}

    <!-- –°–ø–∏—Å–æ–∫ –≤—Ä–µ–¥–Ω—ã—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤ -->
    <div class="medical-card">
        <h4>–í—Ä–µ–¥–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã ({{ examinations|length }})</h4>

        {% if examinations %}
            {% for exam in examinations %}
            <div class="factor-card {% if exam.is_disabled %}disabled{% elif exam.is_expired %}expired{% elif exam.days_remaining and exam.days_remaining <= 30 %}upcoming{% elif exam.date_completed %}normal{% endif %}">
                <div class="row">
                    <div class="col-md-4">
                        <strong>{{ exam.harmful_factor.short_name }}</strong> - {{ exam.harmful_factor.full_name }}
                        {% if exam.is_disabled %}<span class="badge bg-secondary ms-2">–ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è</span>{% endif %}
                        <br>
                        <small class="text-muted">–ü–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å: {{ exam.harmful_factor.periodicity }} –º–µ—Å.</small>
                    </div>
                    <div class="col-md-3">
                        <strong>–î–∞—Ç–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è:</strong><br>
                        {{ exam.date_completed|date:"d.m.Y"|default:"<span class='text-muted'>–ù–µ —É–∫–∞–∑–∞–Ω–∞</span>" }}
                    </div>
                    <div class="col-md-3">
                        <strong>–°–ª–µ–¥—É—é—â–∏–π –æ—Å–º–æ—Ç—Ä:</strong><br>
                        {{ exam.next_date|date:"d.m.Y"|default:"<span class='text-muted'>–ù–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞</span>" }}
                    </div>
                    <div class="col-md-2">
                        {% if exam.is_expired %}
                            <span class="badge bg-danger">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</span>
                        {% elif exam.days_remaining and exam.days_remaining <= 30 %}
                            <span class="badge bg-warning text-dark">–°–∫–æ—Ä–æ –∏—Å—Ç–µ–∫–∞–µ—Ç</span>
                        {% elif exam.date_completed %}
                            <span class="badge bg-success">–î–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω</span>
                        {% else %}
                            <span class="badge bg-secondary">–ù–µ—Ç –¥–∞—Ç—ã</span>
                        {% endif %}
                    </div>
                </div>

                {% if exam.medical_certificate %}
                <div class="mt-2">
                    <a href="{{ exam.medical_certificate.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                        üìÑ –°–∫–∞–Ω —Å–ø—Ä–∞–≤–∫–∏
                    </a>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        {% else %}
            <div class="alert alert-info">
                –î–ª—è –¥–∞–Ω–Ω–æ–π –¥–æ–ª–∂–Ω–æ—Å—Ç–∏ –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –æ—Å–º–æ—Ç—Ä—ã –∏–ª–∏ –≤—Ä–µ–¥–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã.
            </div>
        {% endif %}
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞—Ç—ã -->
<div class="modal fade" id="updateDateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üìÖ –ò–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—É –º–µ–¥–æ—Å–º–æ—Ç—Ä–∞</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'deadline_control:medical:update_employee_examinations' employee.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="alert alert-info">
                        <strong>–í–Ω–∏–º–∞–Ω–∏–µ:</strong> –£–∫–∞–∑–∞–Ω–Ω–∞—è –¥–∞—Ç–∞ –±—É–¥–µ—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –∫–æ –≤—Å–µ–º –º–µ–¥–æ—Å–º–æ—Ç—Ä–∞–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞. –°–ª–µ–¥—É—é—â–∞—è –¥–∞—Ç–∞ –±—É–¥–µ—Ç —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç–∏ –∫–∞–∂–¥–æ–≥–æ –≤—Ä–µ–¥–Ω–æ–≥–æ —Ñ–∞–∫—Ç–æ—Ä–∞.
                    </div>
                    <div class="mb-3">
                        <label for="examination_date" class="form-label">–î–∞—Ç–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –º–µ–¥–æ—Å–º–æ—Ç—Ä–∞</label>
                        <input type="date" class="form-control" id="examination_date" name="examination_date"
                               value="{{ medical_status.date_completed|date:'Y-m-d'|default:'' }}" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ –Ω–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –¥–∞—Ç—ã
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('examination_date');
    if (!dateInput.value) {
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
    }
});
</script>
{% endblock %}
