# Generated by Django 5.0.14 on 2026-01-03 15:50

from django.db import migrations


def migrate_siz_norms_to_profession(apps, schema_editor):
    """
    –ú–∏–≥—Ä–∞—Ü–∏—è —ç—Ç–∞–ª–æ–Ω–Ω—ã—Ö –Ω–æ—Ä–º –°–ò–ó –∏–∑ –¥–æ–ª–∂–Ω–æ—Å—Ç–µ–π –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ø—Ä–æ—Ñ–µ—Å—Å–∏–π.

    –î–ª—è –∫–∞–∂–¥–æ–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏ (—É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ position_name):
    1. –ù–∞—Ö–æ–¥–∏—Ç –¥–æ–ª–∂–Ω–æ—Å—Ç—å —Å –Ω–æ—Ä–º–∞–º–∏ (–ø–µ—Ä–≤—É—é –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π)
    2. –ö–æ–ø–∏—Ä—É–µ—Ç –µ—ë –Ω–æ—Ä–º—ã –≤ ProfessionSIZNorm
    3. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, —É—Å–ª–æ–≤–∏–µ –∏ –ø–æ—Ä—è–¥–æ–∫
    """
    Position = apps.get_model('directory', 'Position')
    SIZNorm = apps.get_model('directory', 'SIZNorm')
    ProfessionSIZNorm = apps.get_model('directory', 'ProfessionSIZNorm')

    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–π, —É –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å –Ω–æ—Ä–º—ã –°–ò–ó
    position_names = SIZNorm.objects.values_list(
        'position__position_name', flat=True
    ).distinct()

    migrated_count = 0
    skipped_count = 0

    for position_name in position_names:
        if not position_name:
            skipped_count += 1
            continue

        # –ù–∞—Ö–æ–¥–∏–º —ç—Ç–∞–ª–æ–Ω–Ω—É—é –¥–æ–ª–∂–Ω–æ—Å—Ç—å (–ø–µ—Ä–≤—É—é –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π)
        reference_position = Position.objects.filter(
            position_name=position_name,
            siz_norms__isnull=False
        ).order_by('organization__full_name_ru').first()

        if not reference_position:
            skipped_count += 1
            continue

        # –ü–æ–ª—É—á–∞–µ–º –Ω–æ—Ä–º—ã —ç—Ç–∞–ª–æ–Ω–Ω–æ–π –¥–æ–ª–∂–Ω–æ—Å—Ç–∏
        norms = SIZNorm.objects.filter(position=reference_position).order_by('order')

        # –ö–æ–ø–∏—Ä—É–µ–º –Ω–æ—Ä–º—ã –≤ ProfessionSIZNorm
        for norm in norms:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–∞—è –Ω–æ—Ä–º–∞
            existing = ProfessionSIZNorm.objects.filter(
                profession_name=position_name,
                siz=norm.siz,
                condition=norm.condition
            ).first()

            if not existing:
                ProfessionSIZNorm.objects.create(
                    profession_name=position_name,
                    siz=norm.siz,
                    quantity=norm.quantity,
                    condition=norm.condition,
                    order=norm.order
                )
                migrated_count += 1

    print(f"‚úÖ –ú–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ {migrated_count} —ç—Ç–∞–ª–æ–Ω–Ω—ã—Ö –Ω–æ—Ä–º –°–ò–ó")
    print(f"‚è©  –ü—Ä–æ–ø—É—â–µ–Ω–æ {skipped_count} –ø—Ä–æ—Ñ–µ—Å—Å–∏–π –±–µ–∑ –Ω–æ—Ä–º")


def reverse_migration(apps, schema_editor):
    """
    –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ - —É–¥–∞–ª—è–µ—Ç –≤—Å–µ –∑–∞–ø–∏—Å–∏ –∏–∑ ProfessionSIZNorm
    """
    ProfessionSIZNorm = apps.get_model('directory', 'ProfessionSIZNorm')
    count = ProfessionSIZNorm.objects.count()
    ProfessionSIZNorm.objects.all().delete()
    print(f"üîÑ –£–¥–∞–ª–µ–Ω–æ {count} —ç—Ç–∞–ª–æ–Ω–Ω—ã—Ö –Ω–æ—Ä–º –ø—Ä–∏ –æ—Ç–∫–∞—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏")


class Migration(migrations.Migration):

    dependencies = [
        ('directory', '0062_add_profession_siz_norm'),
    ]

    operations = [
        migrations.RunPython(migrate_siz_norms_to_profession, reverse_migration),
    ]
