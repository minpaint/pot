{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container-fluid">
    <h1>{{ title }}</h1>

    <!-- Фильтры -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">
                <i class="fas fa-filter"></i> Фильтры
            </h5>
        </div>
        <div class="card-body">
            <form method="get" class="form-inline">
                <div class="row">
                    {% if org_options|length >= 1 %}
                    <div class="col-md-3 mb-2">
                        <label for="org">Организация:</label>
                        <select name="org" id="org" class="form-control" {% if org_options|length == 1 %}disabled{% endif %}>
                            {% if org_options|length > 1 %}
                            <option value="">Все организации</option>
                            {% endif %}
                            {% for org in org_options %}
                                <option value="{{ org.id }}" {% if org.id == selected_org_id %}selected{% endif %}>
                                    {{ org.short_name_ru }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                    <div class="col-md-3 mb-2">
                        <label for="position">Должность:</label>
                        <select name="position" id="position" class="form-control">
                            <option value="">Все должности</option>
                            {% for position in positions %}
                                <option value="{{ position.id }}" {% if current_position == position.id|stringformat:"s" %}selected{% endif %}>
                                    {{ position.position_name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3 mb-2">
                        <label for="search">Поиск:</label>
                        <input type="text" name="search" id="search" class="form-control" value="{{ search_query }}" placeholder="ФИО сотрудника...">
                    </div>
                    <div class="col-md-3 mb-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary mr-2">
                            <i class="fas fa-search"></i> Применить
                        </button>
                        <a href="{% url 'directory:employees:employee_list' %}" class="btn btn-secondary">
                            <i class="fas fa-undo"></i> Сбросить
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Кнопки действий -->
    <div class="mb-3">
        <a href="{% url 'directory:employees:employee_create' %}" class="btn btn-primary">
            <i class="fas fa-user-plus"></i> Добавить сотрудника
        </a>
        <a href="{% url 'directory:employees:employee_hire' %}" class="btn btn-success">
            <i class="fas fa-briefcase"></i> Принять на работу
        </a>
        <a href="{% url 'directory:employees:employee_list_table' %}" class="btn btn-info">
            <i class="fas fa-table"></i> Табличное представление
        </a>
    </div>

    <!-- Древовидная структура -->
    <div class="card">
        <div class="card-header bg-light">
            <h5 class="mb-0">
                <i class="fas fa-sitemap"></i> Структура сотрудников
            </h5>
        </div>
        <div class="card-body p-0">
            {% if tree_data %}
                <div class="tree-container" data-tree-children-url="{% url 'directory:employees:employee_tree_children' 'org' 0 %}">
                    <ul class="tree">
                        {% for org in tree_data %}
                            <li>
                                <span class="tree-toggle collapsed" data-toggle="collapse" data-target="#org-{{ org.id }}" data-parent-type="org" data-parent-id="{{ org.id }}">
                                    <i class="fas fa-building text-primary"></i> {{ org.name }}
                                </span>
                                <div id="org-{{ org.id }}" class="collapse" data-lazy-container="true"></div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            {% else %}
                <div class="alert alert-info m-3">
                    <i class="fas fa-info-circle"></i> Нет данных для отображения или все записи отфильтрованы.
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .tree {
        list-style: none;
        padding-left: 0;
    }

    .tree ul {
        list-style: none;
        padding-left: 30px;
    }

    .tree-toggle {
        cursor: pointer;
        font-weight: bold;
        display: inline-block;
        padding: 8px 12px;
        margin: 4px 0;
        border-radius: 6px;
        transition: all 0.2s;
        position: relative;
        padding-left: 30px;
    }

    .tree-toggle:hover {
        background-color: #e9ecef;
    }

    .tree-toggle i {
        margin-right: 8px;
    }

    /* Кнопка сворачивания/разворачивания */
    .tree-toggle::before {
        content: '−';
        position: absolute;
        left: 8px;
        top: 50%;
        transform: translateY(-50%);
        width: 18px;
        height: 18px;
        border: 2px solid #dc3545;
        color: #dc3545;
        border-radius: 3px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        font-weight: bold;
        line-height: 1;
    }

    .tree-toggle.collapsed::before {
        content: '+';
        border-color: #0d6efd;
        color: #0d6efd;
    }

    .employee-items {
        margin-top: 10px;
        margin-bottom: 10px;
    }

    .employee-item {
        display: flex;
        align-items: center;
        padding: 10px 15px;
        margin-bottom: 8px;
        border-radius: 6px;
        background-color: #f8f9fa;
        border-left: 3px solid #0d6efd;
        transition: all 0.2s;
    }

    .employee-item:hover {
        background-color: #e9ecef;
        transform: translateX(5px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .employee-date {
        font-weight: 600;
        color: #6c757d;
        min-width: 85px;
        margin-right: 15px;
        font-size: 0.9rem;
    }

    .employee-name {
        font-weight: 500;
        color: #212529;
        text-decoration: none;
        margin-right: 10px;
    }

    .employee-name:hover {
        color: #0d6efd;
        text-decoration: underline;
    }

    .employee-actions {
        margin-left: auto;
        display: flex;
        gap: 5px;
    }

    .employee-actions .btn {
        padding: 4px 8px;
    }

    .tree-container {
        padding: 20px;
    }

    .tree-container .collapse {
        display: none;
    }

    .tree-container .collapse.show {
        display: block;
    }

    /* Анимация collapse */
    .collapse {
        transition: height 0.3s ease;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        $('.tree-toggle').addClass('collapsed');

        if ($.fn.collapse) {
            $('.tree-container .collapse').collapse('hide');
        }

        function buildChildrenUrl(parentType, parentId) {
            var baseUrl = $('.tree-container').data('tree-children-url');
            if (!baseUrl) {
                return null;
            }
            var url = baseUrl.replace('/org/0/', '/' + parentType + '/' + parentId + '/');
            if (window.location.search) {
                url += window.location.search;
            }
            return url;
        }

        function loadChildren(toggle) {
            var $toggle = $(toggle);
            var target = $toggle.data('target');
            if (!target) {
                return;
            }
            var $target = $(target);
            if (!$target.length || $target.data('loaded') || $target.data('loading')) {
                return;
            }

            var parentType = $toggle.data('parent-type');
            var parentId = $toggle.data('parent-id');
            var url = buildChildrenUrl(parentType, parentId);
            if (!url) {
                return;
            }

            $target.data('loading', true);
            $target.html('<div class="text-muted p-2">Загрузка...</div>');

            $.getJSON(url)
                .done(function(data) {
                    if (data && data.success) {
                        $target.html(data.html);
                        $target.data('loaded', true);
                    } else {
                        $target.html('<div class="text-danger p-2">Не удалось загрузить данные.</div>');
                    }
                })
                .fail(function() {
                    $target.html('<div class="text-danger p-2">Не удалось загрузить данные.</div>');
                })
                .always(function() {
                    $target.data('loading', false);
                });
        }

        // Переключение вложенных элементов + подгрузка
        $('.tree-container').on('click', '.tree-toggle', function() {
            var toggle = $(this);
            var target = $(this).data('target');

            loadChildren(this);
            $(target).collapse('toggle');
            toggle.toggleClass('collapsed');
        });
    });
</script>
{% endblock %}
