{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –≤–Ω–µ—à–Ω–∏–π CSS —Ñ–∞–π–ª –¥–ª—è —Å—Ç–∏–ª–µ–π –¥—Ä–µ–≤–æ–≤–∏–¥–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã -->
<link rel="stylesheet" href="{% static 'directory/css/frontend_tree_view.css' %}?v=3">
<style>
 /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ */
 #generateDocumentsBtn {
transition: all 0.3s ease;
}

#generateDocumentsBtn:hover {
transform: scale(1.05);
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ –∫–Ω–æ–ø–∫–∏ */
 @keyframes fadeIn {
from { opacity: 0; }
to { opacity: 1; }
}

#generateDocumentsBtn {
animation: fadeIn 0.3s ease-in-out;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ç—Ä–æ–∫ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ */
.candidate-row td {
background: #f0f2f8;
}

/* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
 @media (max-width: 768px) {
.actions-bar {
flex-wrap: wrap;
}

#generateDocumentsBtn {
margin-top: 0.5rem;
width: 100%;
}
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–∞—à–±–æ—Ä–¥–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
@media (max-width: 991.98px) {
    .deadline-dashboard .col-lg-4 {
        flex: 0 0 50%;
        max-width: 50%;
    }
}

@media (max-width: 767.98px) {
    .deadline-dashboard .col-md-6 {
        flex: 0 0 100%;
        max-width: 100%;
    }

    .deadline-dashboard .card-header {
        font-size: 0.9rem;
    }

    .deadline-dashboard .card-body {
        font-size: 0.85rem;
    }

    .deadline-dashboard .badge {
        font-size: 0.7rem;
    }
}

@media (max-width: 575.98px) {
    .deadline-dashboard h6 {
        font-size: 1rem;
    }

    .deadline-dashboard .card {
        margin-bottom: 0.5rem;
    }

    .deadline-dashboard .btn-sm {
        font-size: 0.7rem;
        padding: 0.2rem 0.4rem;
    }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ –±—ã—Å—Ç—Ä—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π */
.quick-actions-card {
margin-bottom: 1.5rem;
}

.quick-actions-card .card-header {
background-color: #007bff;
color: white;
font-weight: bold;
}

.quick-action-btn {
margin-bottom: 0.5rem;
transition: all 0.2s ease;
}

.quick-action-btn:hover {
transform: translateY(-2px);
box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.wizard-btn {
background-color: #6f42c1;
border-color: #6f42c1;
}

.wizard-btn:hover {
background-color: #5a32a3;
border-color: #5a32a3;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –¥–∞—à–±–æ—Ä–¥–∞ –∫–æ–Ω—Ç—Ä–æ–ª—è —Å—Ä–æ–∫–æ–≤ */
.deadline-dashboard {
margin-bottom: 1.5rem;
}

.deadline-dashboard .card-header {
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
color: white;
font-weight: bold;
}

.deadline-dashboard .card-body {
/* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—ã–ø–∏—Ä–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ */
word-wrap: break-word;
overflow-wrap: break-word;
hyphens: auto;
}

.deadline-dashboard .card-body > div > div {
/* –î–ª—è –¥–ª–∏–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫ —Ç–∏–ø–∞ "–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ: 5 –µ–¥. –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ" */
overflow: hidden;
text-overflow: ellipsis;
display: -webkit-box;
-webkit-line-clamp: 2; /* –ú–∞–∫—Å–∏–º—É–º 2 —Å—Ç—Ä–æ–∫–∏ */
-webkit-box-orient: vertical;
line-height: 1.4;
margin-bottom: 0.25rem;
}

.deadline-org-card {
border-left: 4px solid #667eea;
transition: all 0.3s ease;
}

.deadline-org-card:hover {
box-shadow: 0 4px 12px rgba(0,0,0,0.15);
transform: translateY(-2px);
}

.deadline-stat {
text-align: center;
padding: 0.5rem;
}

.deadline-stat .stat-number {
font-size: 1.8rem;
font-weight: bold;
line-height: 1;
}

.deadline-stat .stat-label {
font-size: 0.75rem;
color: #6c757d;
margin-top: 0.25rem;
}

.stat-overdue {
color: #dc3545;
}

.stat-warning {
color: #ffc107;
}

.stat-ok {
color: #28a745;
}

.org-name {
font-weight: 600;
color: #495057;
border-bottom: 2px solid #667eea;
padding-bottom: 0.5rem;
margin-bottom: 1rem;
}

/* Dropdown –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
.quick-actions-dropdown {
display: none;
}

@media (max-width: 767px) {
/* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º dropdown –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
.quick-actions-dropdown {
    display: inline-block;
}

/* –°–∫—Ä—ã–≤–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ */
.actions-bar .expand-all,
.actions-bar .collapse-all {
    display: none !important;
}
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">

<!-- ‚è∞ –î–∞—à–±–æ—Ä–¥ –∫–æ–Ω—Ç—Ä–æ–ª—è —Å—Ä–æ–∫–æ–≤ -->
<div class="mb-3 deadline-dashboard">
    <h6 class="mb-2">‚è∞ –ö–æ–Ω—Ç—Ä–æ–ª—å —Å—Ä–æ–∫–æ–≤</h6>
    {% if deadline_dashboard.per_org %}
        <div class="row g-2">
            {% for item in deadline_dashboard.per_org %}
            <div class="col-md-6 col-lg-4">
                <div class="card h-100 {% if item.overdue_total > 0 %}border-danger{% elif item.upcoming_total > 0 %}border-warning{% else %}border-success{% endif %}">
                    <div class="card-header py-2 d-flex justify-content-between align-items-center">
                        <strong class="small">üè¢ {{ item.org.short_name_ru }}</strong>
                        <span class="small">
                            {% if item.overdue_total > 0 %}
                            <span class="badge bg-danger">üö® {{ item.overdue_total }}</span>
                            {% endif %}
                            {% if item.upcoming_total > 0 %}
                            <span class="badge bg-warning text-dark">‚ö†Ô∏è {{ item.upcoming_total }}</span>
                            {% endif %}
                            {% if item.overdue_total == 0 and item.upcoming_total == 0 %}
                            <span class="badge bg-success">‚úÖ</span>
                            {% endif %}
                        </span>
                    </div>
                    <div class="card-body py-2">
                        {% if item.overdue_total > 0 or item.upcoming_total > 0 %}
                        <div class="small">
                            {% if item.equipment.overdue > 0 %}
                            <div class="text-danger">üîß –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ: <strong>{{ item.equipment.overdue }}</strong> –µ–¥. –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</div>
                            {% endif %}
                            {% if item.equipment.upcoming > 0 %}
                            <div class="text-warning">üîß –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ: <strong>{{ item.equipment.upcoming }}</strong> –µ–¥. —Å–∫–æ—Ä–æ</div>
                            {% endif %}
                            {% if item.deadlines.overdue > 0 %}
                            <div class="text-danger">üìÖ –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è: <strong>{{ item.deadlines.overdue }}</strong> –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</div>
                            {% endif %}
                            {% if item.deadlines.upcoming > 0 %}
                            <div class="text-warning">üìÖ –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è: <strong>{{ item.deadlines.upcoming }}</strong> —Å–∫–æ—Ä–æ</div>
                            {% endif %}
                            {% if item.medical.overdue > 0 %}
                            <div class="text-danger">üè• –ú–µ–¥–æ—Å–º–æ—Ç—Ä—ã: <strong>{{ item.medical.overdue }}</strong> —Å–æ—Ç—Ä. –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</div>
                            {% endif %}
                            {% if item.medical.upcoming > 0 %}
                            <div class="text-warning">üè• –ú–µ–¥–æ—Å–º–æ—Ç—Ä—ã: <strong>{{ item.medical.upcoming }}</strong> —Å–æ—Ç—Ä. —Å–∫–æ—Ä–æ</div>
                            {% endif %}
                        </div>
                        {% else %}
                        <div class="text-success small text-center">
                            ‚úÖ –í—Å–µ —Å—Ä–æ–∫–∏ –ø–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º
                        </div>
                        {% endif %}
                    </div>
                    <div class="card-footer py-2 text-center">
                        <a href="{% url 'deadline_control:dashboard' %}?org={{ item.org.id }}" class="btn btn-sm btn-outline-primary">
                            üìä –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="card">
            <div class="card-body text-muted small text-center py-3">
                ‚úÖ –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            </div>
        </div>
    {% endif %}
</div>

 <!-- üéØ –ü–∞–Ω–µ–ª—å —Å –¥–µ–π—Å—Ç–≤–∏—è–º–∏ -->
 <div class="actions-bar">
 <!-- –ü–æ–∏—Å–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ -->
 <div class="input-group me-2" style="max-width: 300px; min-width: 200px;">
 <input type="text" id="globalSearchInput" class="form-control form-control-sm" placeholder="üîç –ü–æ–∏—Å–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤...">
 <button type="button" class="btn btn-sm btn-outline-secondary" id="globalClearBtn" title="–û—á–∏—Å—Ç–∏—Ç—å">
 ‚úï
 </button>
 </div>

 <!-- –í—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é "–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è" –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö -->
 <div class="dropdown d-md-none me-2 quick-actions-dropdown">
     <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="quickActionsDropdown"
             data-bs-toggle="dropdown" aria-expanded="false">
         ‚ö° –î–µ–π—Å—Ç–≤–∏—è
     </button>
     <ul class="dropdown-menu" aria-labelledby="quickActionsDropdown">
         <li><a class="dropdown-item" href="#" onclick="document.getElementById('btnExpandAll').click(); return false;">
             <i class="fas fa-expand-alt"></i> –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å—ë
         </a></li>
         <li><a class="dropdown-item" href="#" onclick="document.getElementById('btnCollapseAll').click(); return false;">
             <i class="fas fa-compress-alt"></i> –°–≤–µ—Ä–Ω—É—Ç—å –≤—Å—ë
         </a></li>
     </ul>
 </div>

 <!-- –û—Ç–¥–µ–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞ -->
 <button id="btnExpandAll" class="btn btn-sm btn-outline-secondary me-1 expand-all d-none d-md-inline-block">
 <i class="fas fa-expand-alt"></i> <span class="d-none d-lg-inline">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å</span>
</button>
 <button id="btnCollapseAll" class="btn btn-sm btn-outline-secondary me-2 collapse-all d-none d-md-inline-block">
 <i class="fas fa-compress-alt"></i> <span class="d-none d-lg-inline">–°–≤–µ—Ä–Ω—É—Ç—å</span>
</button>
 <div class="dropdown d-inline-block me-2">
 <button class="btn btn-primary btn-sm dropdown-toggle" type="button" id="actionsDropdown"
 data-bs-toggle="dropdown" aria-expanded="false" disabled>
 –î–µ–π—Å—Ç–≤–∏—è <span id="selectedCount" class="badge bg-light text-dark ms-1">0</span>
 </button>
 <ul class="dropdown-menu" aria-labelledby="actionsDropdown">
 <li><a class="dropdown-item" href="#" id="btnIssueSIZ">
 <i class="fas fa-hard-hat"></i> –í—ã–¥–∞—Ç—å –°–ò–ó
</a></li>
 <li><a class="dropdown-item" href="#" id="btnMedicalReferralDropdown">
 <i class="fas fa-stethoscope"></i> –í—ã–¥–∞—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
</a></li>
 <!-- –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –ø—É–Ω–∫—Ç –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ –º–µ–Ω—é -->
 <li><a class="dropdown-item" href="#" id="btnGenerateDocuments">
 <i class="fas fa-file-alt"></i> –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã
</a></li>
 </ul>
 </div>

 <!-- –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ -->
 <button id="generateDocumentsBtn" class="btn btn-danger btn-sm me-1" style="display: none;">
 <i class="fas fa-file-alt"></i> <span class="d-none d-md-inline">–î–æ–∫—É–º–µ–Ω—Ç—ã</span>
</button>

 <!-- –ö–Ω–æ–ø–∫–∞ –≤—ã–¥–∞—á–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞ –º–µ–¥–æ—Å–º–æ—Ç—Ä -->
 <button id="btnMedicalReferral" class="btn btn-info btn-sm" style="display: none;" data-bs-toggle="modal" data-bs-target="#medicalReferralModal">
 <i class="fas fa-stethoscope"></i> <span class="d-none d-md-inline">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</span>
</button>

 <div id="selectedCounter" class="select-count text-muted ms-2" style="display: none;">
 <span id="counterValue">0</span> –≤—ã–±—Ä.
 </div>
 </div>

 <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è URL (–≤–º–µ—Å—Ç–æ Django-—Ç–µ–≥–æ–≤ –≤–Ω—É—Ç—Ä–∏ JS) -->
 <div hidden>
 <span data-siz-personal-card-url="{% url 'directory:siz:siz_personal_card' 0 %}"></span>
 <span data-siz-issue-url="{% url 'directory:siz:siz_issue_for_employee' 0 %}"></span>
 <span data-employee-update-url="{% url 'directory:employees:employee_update' 0 %}"></span>
 <!-- –î–æ–±–∞–≤–ª—è–µ–º URL –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ -->
 <span data-document-selection-url="{% url 'directory:documents:document_selection' 0 %}"></span>
 <!-- –î–æ–±–∞–≤–ª—è–µ–º URL –¥–ª—è –º–Ω–æ–≥–æ—à–∞–≥–æ–≤–æ–π —Ñ–æ—Ä–º—ã -->
 <span data-hiring-wizard-url="{% url 'directory:employees:employee_hire' %}"></span>
 </div>

 <!-- üìã –¢–∞–±–ª–∏—Ü–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ -->
 <div class="table-responsive mt-2">
 <table class="tree-table table table-hover" id="employeeTree">
 <thead>
 <tr>
 <th style="width: 40px;">
 <input type="checkbox" class="custom-checkbox" id="select-all">
 </th>
 <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
 <th>–î–µ–π—Å—Ç–≤–∏—è</th>
 </tr>
 </thead>
 <tbody>
 {# ----- –ë–ª–æ–∫ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ ----- #}
 {% if candidate_employees %}
 <tr class="table-secondary">
 <td></td>
 <td colspan="2"><strong>–ö–∞–Ω–¥–∏–¥–∞—Ç—ã</strong></td>
 </tr>
 {% for employee in candidate_employees %}
 <tr class="tree-row candidate-row" data-level="0">
 <td>
 <input type="checkbox" class="custom-checkbox employee-checkbox"
 data-id="{{ employee.id }}" data-type="employee">
 </td>
 <td class="field-name">
 <span class="tree-icon">üìù</span>
 {{ employee.full_name_nominative }} - {{ employee.position.position_name }}
 </td>
 <td>
 <div class="btn-group btn-group-sm">
 <button type="button" class="btn btn-outline-info btn-medical-referral" data-employee-id="{{ employee.id }}" title="–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –ú–û">
 <i class="fas fa-stethoscope"></i>
 </button>
 <a href="{% url 'directory:documents:document_selection' employee.id %}"
 class="btn btn-outline-danger" title="–°–æ–∑–¥–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã">
 <i class="fas fa-file-alt"></i>
 </a>
 <a href="{% url 'directory:siz:siz_personal_card' employee.id %}"
 class="btn btn-outline-success" title="–í—ã–¥–∞—Ç—å –°–ò–ó">
 <i class="fas fa-hard-hat"></i>
 </a>
 </div>
 </td>
 </tr>
 {% endfor %}
 {% endif %}
 {# ----- –ö–æ–Ω–µ—Ü –±–ª–æ–∫–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ ----- #}

 {% for organization in organizations %}
<!-- üè¢ –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è -->
 <tr class="tree-row organization-row" data-level="0" data-node-id="org-{{ organization.id }}">
 <td>
 <!-- –£–±—Ä–∞–Ω —á–µ–∫–±–æ–∫—Å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ -->
 </td>
 <td class="field-name">
 <span class="tree-toggle" data-node="org-{{ organization.id }}">-</span>
 <span class="tree-icon">üè¢</span> <strong>{{ organization.short_name }}</strong>
 </td>
 <td></td>
 </tr>

 <!-- üë§ –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ (–±–µ–∑ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è) -->
 {% for employee in organization.employees %}
<tr class="tree-row" data-level="1" data-parent="org-{{ organization.id }}">
 <td>
 <input type="checkbox" class="custom-checkbox employee-checkbox"
 data-id="{{ employee.id }}" data-type="employee">
 </td>
 <td class="field-name">
 <div class="tree-level">
 <span class="tree-icon">üë§</span> {{ employee.full_name_nominative }} - {{ employee.position.position_name }}
</div>
 </td>
 <td>
 <div class="btn-group btn-group-sm">
 <button type="button" class="btn btn-outline-info btn-medical-referral" data-employee-id="{{ employee.id }}" title="–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –ú–û">
 <i class="fas fa-stethoscope"></i>
 </button>
 <!-- –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ —Å—Ç—Ä–æ–∫–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ -->
 <a href="{% url 'directory:documents:document_selection' employee.id %}"
 class="btn btn-outline-danger" title="–°–æ–∑–¥–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã">
 <i class="fas fa-file-alt"></i>
 </a>
 <a href="{% url 'directory:siz:siz_personal_card' employee.id %}"
 class="btn btn-outline-success" title="–í—ã–¥–∞—Ç—å –°–ò–ó">
 <i class="fas fa-hard-hat"></i>
 </a>
 </div>
 </td>
 </tr>
 {% endfor %}

<!-- üè≠ –ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è -->
 {% for subdivision in organization.subdivisions %}
<tr class="tree-row subdivision-row" data-level="1"
 data-parent="org-{{ organization.id }}"
 data-node-id="sub-{{ subdivision.id }}">
 <td>
 <!-- –£–±—Ä–∞–Ω —á–µ–∫–±–æ–∫—Å –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è -->
 </td>
 <td class="field-name">
 <div class="tree-level">
 <span class="tree-toggle" data-node="sub-{{ subdivision.id }}">-</span>
 <span class="tree-icon">üè≠</span> <strong>{{ subdivision.name }}</strong>
 </div>
 </td>
 <td></td>
 </tr>

 <!-- üë§ –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è (–±–µ–∑ –æ—Ç–¥–µ–ª–∞) -->
 {% for employee in subdivision.employees %}
<tr class="tree-row" data-level="2" data-parent="sub-{{ subdivision.id }}">
 <td>
 <input type="checkbox" class="custom-checkbox employee-checkbox"
 data-id="{{ employee.id }}" data-type="employee">
 </td>
 <td class="field-name">
 <div class="tree-level tree-level-2">
 <span class="tree-icon">üë§</span> {{ employee.full_name_nominative }} - {{ employee.position.position_name }}
</div>
 </td>
 <td>
 <div class="btn-group btn-group-sm">
 <button type="button" class="btn btn-outline-info btn-medical-referral" data-employee-id="{{ employee.id }}" title="–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –ú–û">
 <i class="fas fa-stethoscope"></i>
 </button>
 <!-- –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ —Å—Ç—Ä–æ–∫–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ -->
 <a href="{% url 'directory:documents:document_selection' employee.id %}"
 class="btn btn-outline-danger" title="–°–æ–∑–¥–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã">
 <i class="fas fa-file-alt"></i>
 </a>
 <a href="{% url 'directory:siz:siz_personal_card' employee.id %}"
 class="btn btn-outline-success" title="–í—ã–¥–∞—Ç—å –°–ò–ó">
 <i class="fas fa-hard-hat"></i>
 </a>
 </div>
 </td>
 </tr>
 {% endfor %}

<!-- üìÇ –û—Ç–¥–µ–ª—ã -->
 {% for department in subdivision.departments %}
<tr class="tree-row department-row" data-level="2"
 data-parent="sub-{{ subdivision.id }}"
 data-node-id="dept-{{ department.id }}">
 <td>
 <!-- –£–±—Ä–∞–Ω —á–µ–∫–±–æ–∫—Å –æ—Ç–¥–µ–ª–∞ -->
 </td>
 <td class="field-name">
 <div class="tree-level tree-level-2">
 <span class="tree-toggle" data-node="dept-{{ department.id }}">-</span>
 <span class="tree-icon">üìÇ</span> <strong>{{ department.name }}</strong>
 </div>
 </td>
 <td></td>
 </tr>

 <!-- üë§ –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –æ—Ç–¥–µ–ª–∞ -->
 {% for employee in department.employees %}
<tr class="tree-row" data-level="3" data-parent="dept-{{ department.id }}">
 <td>
 <input type="checkbox" class="custom-checkbox employee-checkbox"
 data-id="{{ employee.id }}" data-type="employee">
 </td>
 <td class="field-name">
 <div class="tree-level tree-level-3">
 <span class="tree-icon">üë§</span> {{ employee.full_name_nominative }} - {{ employee.position.position_name }}
</div>
 </td>
 <td>
 <div class="btn-group btn-group-sm">
 <button type="button" class="btn btn-outline-info btn-medical-referral" data-employee-id="{{ employee.id }}" title="–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –ú–û">
 <i class="fas fa-stethoscope"></i>
 </button>
 <!-- –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ —Å—Ç—Ä–æ–∫–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ -->
 <a href="{% url 'directory:documents:document_selection' employee.id %}"
 class="btn btn-outline-danger" title="–°–æ–∑–¥–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã">
 <i class="fas fa-file-alt"></i>
 </a>
 <a href="{% url 'directory:siz:siz_personal_card' employee.id %}"
 class="btn btn-outline-success" title="–í—ã–¥–∞—Ç—å –°–ò–ó">
 <i class="fas fa-hard-hat"></i>
 </a>
 </div>
 </td>
 </tr>
 {% endfor %}
{% endfor %} <!-- –∫–æ–Ω–µ—Ü —Ü–∏–∫–ª–∞ –ø–æ –æ—Ç–¥–µ–ª–∞–º -->
 {% endfor %} <!-- –∫–æ–Ω–µ—Ü —Ü–∏–∫–ª–∞ –ø–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è–º -->
 {% endfor %} <!-- –∫–æ–Ω–µ—Ü —Ü–∏–∫–ª–∞ –ø–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è–º -->
 </tbody>
 </table>
 </div>

 <!-- üìÑ –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
 {% if is_paginated %}
<nav aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º" class="mt-3">
 <ul class="pagination">
 {% if organizations.has_previous %}
<li class="page-item">
 <a class="page-link" href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}" aria-label="–ü–µ—Ä–≤–∞—è">
 <span aria-hidden="true">&laquo;&laquo;</span>
 </a>
 </li>
 <li class="page-item">
 <a class="page-link" href="?page={{ organizations.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∞—è">
 <span aria-hidden="true">&laquo;</span>
 </a>
 </li>
 {% else %}
<li class="page-item disabled">
 <span class="page-link">&laquo;&laquo;</span>
 </li>
 <li class="page-item disabled">
 <span class="page-link">&laquo;</span>
 </li>
 {% endif %}

{% for num in paginator.page_range %}
{% if organizations.number == num %}
<li class="page-item active">
 <span class="page-link">{{ num }}</span>
 </li>
 {% elif num > organizations.number|add:'-3' and num < organizations.number|add:'3' %}
<li class="page-item">
 <a class="page-link" href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}">{{ num }}</a>
 </li>
 {% endif %}
{% endfor %}

{% if organizations.has_next %}
<li class="page-item">
 <a class="page-link" href="?page={{ organizations.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}" aria-label="–°–ª–µ–¥—É—é—â–∞—è">
 <span aria-hidden="true">&raquo;</span>
 </a>
 </li>
 <li class="page-item">
 <a class="page-link" href="?page={{ paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}" aria-label="–ü–æ—Å–ª–µ–¥–Ω—è—è">
 <span aria-hidden="true">&raquo;&raquo;</span>
 </a>
 </li>
 {% else %}
<li class="page-item disabled">
 <span class="page-link">&raquo;</span>
 </li>
 <li class="page-item disabled">
 <span class="page-link">&raquo;&raquo;</span>
 </li>
 {% endif %}
</ul>
 </nav>
 {% endif %}
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–¥–∞—á–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞ –º–µ–¥–æ—Å–º–æ—Ç—Ä -->
<div class="modal fade" id="medicalReferralModal" tabindex="-1" aria-labelledby="medicalReferralModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="medicalReferralModalLabel">
                    <i class="fas fa-stethoscope"></i> –í—ã–¥–∞—á–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞ –º–µ–¥–æ—Å–º–æ—Ç—Ä
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="referralForm">
                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ (–Ω–µ–∏–∑–º–µ–Ω—è–µ–º—ã–µ –ø–æ–ª—è) -->
                    <div class="card mb-3 bg-light">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="d-flex align-items-start">
                                        <i class="fas fa-user text-primary me-2 mt-1"></i>
                                        <div>
                                            <small class="text-muted d-block">–§–ò–û</small>
                                            <span id="refEmployeeNameDisplay" class="fw-bold fs-5">-</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex align-items-start">
                                        <i class="fas fa-building text-primary me-2 mt-1"></i>
                                        <div>
                                            <small class="text-muted d-block">–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</small>
                                            <span id="refOrganization" class="fw-bold">-</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex align-items-start">
                                        <i class="fas fa-briefcase text-primary me-2 mt-1"></i>
                                        <div>
                                            <small class="text-muted d-block">–ü—Ä–æ—Ñ–µ—Å—Å–∏—è (–¥–æ–ª–∂–Ω–æ—Å—Ç—å)</small>
                                            <span id="refPosition" class="fw-bold">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è (—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–µ) -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-calendar-alt"></i> –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è <span class="text-danger">*</span>
                        </label>
                        <input type="date" class="form-control" id="refBirthDate" required>
                        <div class="form-text">–ú–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ —É—Å—Ç–∞—Ä–µ–ª–∏. –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –∫–∞—Ä—Ç–æ—á–∫–µ.</div>
                    </div>

                    <!-- –ú–µ—Å—Ç–æ –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è (—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–µ) -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-home"></i> –ú–µ—Å—Ç–æ –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control" id="refAddress" rows="2" required placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞"></textarea>
                        <div class="form-text">–ú–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å, –µ—Å–ª–∏ –∞–¥—Ä–µ—Å –∏–∑–º–µ–Ω–∏–ª—Å—è. –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –∫–∞—Ä—Ç–æ—á–∫–µ.</div>
                    </div>

                    <!-- –í—Ä–µ–¥–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã (–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ –ø–æ–ª–µ) -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-exclamation-triangle text-warning"></i> –í—Ä–µ–¥–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã
                        </label>
                        <div id="refHarmfulFactors" class="border rounded p-2 bg-light">
                            <span class="text-muted">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                        <div class="form-text">–§–∞–∫—Ç–æ—Ä—ã –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –¥–ª—è –¥–æ–ª–∂–Ω–æ—Å—Ç–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</div>
                    </div>

                    <input type="hidden" id="refEmployeeId">
                    <input type="hidden" id="refEmployeeName">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
                </button>
                <button type="button" class="btn btn-info" id="btnGenerateReferral">
                    <i class="fas fa-file-medical"></i> –í—ã–¥–∞—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º JavaScript —Ñ–∞–π–ª—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–µ—Ä–µ–≤–æ–º -->
<script src="{% static 'directory/js/frontend_tree_view.js' %}?v=2"></script>
<script src="{% static 'directory/js/frontend_tree_search.js' %}?v=2"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
// –ü–æ–ª—É—á–∞–µ–º URL –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
 const documentSelectionUrl = document.querySelector('[data-document-selection-url]').getAttribute('data-document-selection-url');
const sizPersonalCardUrl = document.querySelector('[data-siz-personal-card-url]').getAttribute('data-siz-personal-card-url');
const sizIssueUrl = document.querySelector('[data-siz-issue-url]').getAttribute('data-siz-issue-url');
const employeeUpdateUrl = document.querySelector('[data-employee-update-url]').getAttribute('data-employee-update-url');
const hiringWizardUrl = document.querySelector('[data-hiring-wizard-url]').getAttribute('data-hiring-wizard-url');

// –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
 const checkboxes = document.querySelectorAll('.employee-checkbox');
const selectAllCheckbox = document.getElementById('select-all');
const actionsDropdown = document.getElementById('actionsDropdown');
const generateDocumentsBtn = document.getElementById('generateDocumentsBtn');
const btnGenerateDocuments = document.getElementById('btnGenerateDocuments');
const btnIssueSIZ = document.getElementById('btnIssueSIZ');
const btnMedicalReferralDropdown = document.getElementById('btnMedicalReferralDropdown');
const btnMedicalReferral = document.getElementById('btnMedicalReferral');
const rowMedicalButtons = document.querySelectorAll('.btn-medical-referral');

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–æ–∫
 function updateButtonsState() {
const selectedEmployees = Array.from(document.querySelectorAll('.employee-checkbox:checked'));
const selectedCount = selectedEmployees.length;

// –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
 document.getElementById('selectedCount').textContent = selectedCount;
document.getElementById('counterValue').textContent = selectedCount;

// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –∏ —Å—á–µ—Ç—á–∏–∫–∏
 document.getElementById('selectedCounter').style.display = selectedCount > 0 ? 'inline-block' : 'none';
actionsDropdown.disabled = selectedCount === 0;
generateDocumentsBtn.style.display = selectedCount === 1 ? 'inline-block' : 'none';
btnMedicalReferral.style.display = selectedCount === 1 ? 'inline-block' : 'none';
}

// ÔøΩÔøΩÔøΩÔøΩÔøΩÎ¢†ÔøΩÔøΩ ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ ÔøΩÔøΩÔøΩÔøΩÔøΩ ÔøΩÔøΩÔøΩ„§≠ÔøΩÔøΩÔøΩ ÔøΩÔøΩ ÔøΩÔøΩ ID
 function selectSingleEmployee(employeeId) {
checkboxes.forEach(checkbox => {
checkbox.checked = checkbox.dataset.id === employeeId;
});
updateButtonsState();
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —á–µ–∫–±–æ–∫—Å–æ–≤ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
 checkboxes.forEach(checkbox => {
checkbox.addEventListener('change', updateButtonsState);
});
 // ÔøΩÔøΩ‡†°ÔøΩÔøΩÁ®™ ÔøΩÔøΩÔøΩ ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ ÔøΩ„≠™ÔøΩ ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ ÔøΩÔøΩ ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ
 if (rowMedicalButtons.length && btnMedicalReferral) {
rowMedicalButtons.forEach(button => {
button.addEventListener('click', function(e) {
e.preventDefault();
const employeeId = this.dataset.employeeId;
if (!employeeId) {
return;
}
selectSingleEmployee(employeeId);
btnMedicalReferral.click();
});
});
}


// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤—ã–±–æ—Ä–∞ –≤—Å–µ—Ö/—Å–Ω—è—Ç–∏—è –≤—ã–¥–µ–ª–µ–Ω–∏—è —Å–æ –≤—Å–µ—Ö
 if (selectAllCheckbox) {
selectAllCheckbox.addEventListener('change', function() {
const isChecked = this.checked;
checkboxes.forEach(checkbox => {
checkbox.checked = isChecked;
});
updateButtonsState();
});
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (–æ—Ç–¥–µ–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞)
 if (generateDocumentsBtn) {
generateDocumentsBtn.addEventListener('click', function() {
const selectedEmployee = document.querySelector('.employee-checkbox:checked');
if (selectedEmployee) {
const employeeId = selectedEmployee.dataset.id;
window.location.href = documentSelectionUrl.replace('0', employeeId);
}
});
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø—É–Ω–∫—Ç–∞ –º–µ–Ω—é "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã"
 if (btnGenerateDocuments) {
btnGenerateDocuments.addEventListener('click', function(e) {
e.preventDefault();
const selectedEmployee = document.querySelector('.employee-checkbox:checked');
if (selectedEmployee) {
const employeeId = selectedEmployee.dataset.id;
window.location.href = documentSelectionUrl.replace('0', employeeId);
}
});
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø—É–Ω–∫—Ç–∞ –º–µ–Ω—é "–í—ã–¥–∞—Ç—å –°–ò–ó" (—Ç–µ–ø–µ—Ä—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –∫–∞—Ä—Ç–æ—á–∫—É —É—á–µ—Ç–∞)
 if (btnIssueSIZ) {
btnIssueSIZ.addEventListener('click', function(e) {
e.preventDefault();
const selectedEmployee = document.querySelector('.employee-checkbox:checked');
if (selectedEmployee) {
const employeeId = selectedEmployee.dataset.id;
window.location.href = sizPersonalCardUrl.replace('0', employeeId);
}
});
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø—É–Ω–∫—Ç–∞ –º–µ–Ω—é "–í—ã–¥–∞—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ"
 if (btnMedicalReferralDropdown) {
btnMedicalReferralDropdown.addEventListener('click', function(e) {
e.preventDefault();
const selectedEmployee = document.querySelector('.employee-checkbox:checked');
if (selectedEmployee) {
// –ò–º–∏—Ç–∏—Ä—É–µ–º –∫–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ"
if (btnMedicalReferral) {
btnMedicalReferral.click();
}
}
});
}

// === –õ–æ–≥–∏–∫–∞ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞ –º–µ–¥–æ—Å–º–æ—Ç—Ä ===
const medicalReferralModal = document.getElementById('medicalReferralModal');
const btnGenerateReferral = document.getElementById('btnGenerateReferral');

// –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
if (medicalReferralModal) {
    medicalReferralModal.addEventListener('show.bs.modal', function() {
        const selectedEmployee = document.querySelector('.employee-checkbox:checked');
        if (selectedEmployee) {
            const employeeId = selectedEmployee.dataset.id;
            loadEmployeeDataForReferral(employeeId);
        }
    });
}

// –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –¥–ª—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
function loadEmployeeDataForReferral(employeeId) {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    document.getElementById('refHarmfulFactors').innerHTML = '<span class="text-muted"><i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</span>';

    fetch(`/deadline-control/medical/referral/api/employee/${employeeId}/`)
        .then(response => {
            if (!response.ok) {
                throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
            }
            return response.json();
        })
        .then(data => {
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏
            document.getElementById('refEmployeeId').value = data.id;
            document.getElementById('refEmployeeName').value = data.full_name;
            document.getElementById('refEmployeeNameDisplay').textContent = data.full_name; // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ
            document.getElementById('refPosition').textContent = data.position;
            document.getElementById('refOrganization').textContent = data.organization;
            document.getElementById('refBirthDate').value = data.birth_date || '';
            document.getElementById('refAddress').value = data.address || '';

            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤—Ä–µ–¥–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã
            const factorsContainer = document.getElementById('refHarmfulFactors');
            if (data.harmful_factors && data.harmful_factors.length > 0) {
                let factorsHtml = '<div class="row g-2">';
                data.harmful_factors.forEach(factor => {
                    factorsHtml += `
                        <div class="col-12">
                            <div class="d-flex align-items-center">
                                <span class="badge bg-warning text-dark me-2">${factor.short_name}</span>
                                <small>${factor.full_name}</small>
                            </div>
                        </div>
                    `;
                });
                factorsHtml += '</div>';
                factorsContainer.innerHTML = factorsHtml;
            } else {
                factorsContainer.innerHTML = '<span class="text-warning"><i class="fas fa-exclamation-triangle"></i> –í—Ä–µ–¥–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –¥–ª—è –¥–æ–ª–∂–Ω–æ—Å—Ç–∏</span>';
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            document.getElementById('refHarmfulFactors').innerHTML = '<span class="text-danger"><i class="fas fa-exclamation-circle"></i> –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</span>';
        });
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–í—ã–¥–∞—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ"
if (btnGenerateReferral) {
    btnGenerateReferral.addEventListener('click', function() {
        const employeeId = document.getElementById('refEmployeeId').value;
        const fullName = document.getElementById('refEmployeeName').value;
        const birthDate = document.getElementById('refBirthDate').value;
        const address = document.getElementById('refAddress').value;

        if (!fullName) {
            alert('–£–∫–∞–∂–∏—Ç–µ –§–ò–û —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞');
            return;
        }

        if (!birthDate) {
            alert('–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞');
            return;
        }

        if (!address) {
            alert('–£–∫–∞–∂–∏—Ç–µ –º–µ—Å—Ç–æ –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞');
            return;
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –∫–Ω–æ–ø–∫–µ
        const originalText = this.innerHTML;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ì–µ–Ω–µ—Ä–∞—Ü–∏—è...';
        this.disabled = true;

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        fetch('/deadline-control/medical/referral/generate/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                employee_id: employeeId,
                full_name: fullName,
                birth_date: birthDate,
                address: address
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // –°–∫–∞—á–∏–≤–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç
                if (data.document_url) {
                    window.location.href = data.document_url;
                }
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                bootstrap.Modal.getInstance(medicalReferralModal).hide();
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                alert('–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ!');
            } else {
                alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è');
        })
        .finally(() => {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            this.innerHTML = originalText;
            this.disabled = false;
        });
    });
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞ –∏–∑ –∫—É–∫–∏
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–æ–∫
 updateButtonsState();
});
</script>
{% endblock %}
