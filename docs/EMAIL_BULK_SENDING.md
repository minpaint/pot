# –ú–∞—Å—Å–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ email - –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

## üìã –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ OT_online –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º–∞—Å—Å–æ–≤—É—é –æ—Ç–ø—Ä–∞–≤–∫—É email —Å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –ª—É—á—à–∏—Ö –ø—Ä–∞–∫—Ç–∏–∫:

- **Connection Pooling** - –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ–¥–Ω–æ–≥–æ SMTP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö –ø–∏—Å–µ–º
- **Rate Limiting** - –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–∏—Å—å–º–∞–º–∏ –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –±–∞–Ω–∞
- **Retry –º–µ—Ö–∞–Ω–∏–∑–º** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –ø—Ä–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö
- **–î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –ø–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –∞—É–¥–∏—Ç–∞

## üéØ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:
- –ú–∞—Å—Å–æ–≤–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ–±—Ä–∞–∑—Ü–æ–≤ –∂—É—Ä–Ω–∞–ª–æ–≤ –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–µ–π
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –º–µ–¥–æ—Å–º–æ—Ç—Ä–∞—Ö
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ–± –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–∏

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ EmailSettings

–ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –≤ –º–æ–¥–µ–ª–∏ `EmailSettings` –ø–æ—è–≤–∏–ª–∏—Å—å —Ç—Ä–∏ –Ω–æ–≤—ã—Ö –ø–æ–ª—è –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–∞—Å—Å–æ–≤–æ–π —Ä–∞—Å—Å—ã–ª–∫–æ–π:

### 1. –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–∏—Å—å–º–∞–º–∏ (email_delay_seconds)
- **–¢–∏–ø:** Decimal (0.0 - 60.0 —Å–µ–∫—É–Ω–¥)
- **–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é:** 1.0 —Å–µ–∫—É–Ω–¥–∞
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü–∞—É–∑–∞ –º–µ–∂–¥—É –æ—Ç–ø—Ä–∞–≤–∫–æ–π –∫–∞–∂–¥–æ–≥–æ –ø–∏—Å—å–º–∞
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
  - Gmail: 1-2 —Å–µ–∫—É–Ω–¥—ã (–ª–∏–º–∏—Ç 500 –ø–∏—Å–µ–º/–¥–µ–Ω—å)
  - Yandex: 1-2 —Å–µ–∫—É–Ω–¥—ã (–ª–∏–º–∏—Ç 500 –ø–∏—Å–µ–º/–¥–µ–Ω—å)
  - –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π SMTP: 0.5-1 —Å–µ–∫—É–Ω–¥–∞

### 2. –ú–∞–∫—Å–∏–º—É–º –ø–æ–ø—ã—Ç–æ–∫ –ø–æ–≤—Ç–æ—Ä–∞ (max_retry_attempts)
- **–¢–∏–ø:** Integer (0 - 10)
- **–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é:** 3 –ø–æ–ø—ã—Ç–∫–∏
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –ø—Ä–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
  - –î–ª—è —Å—Ç–∞–±–∏–ª—å–Ω—ã—Ö SMTP: 2-3 –ø–æ–ø—ã—Ç–∫–∏
  - –î–ª—è –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π: 3-5 –ø–æ–ø—ã—Ç–æ–∫
  - –ï—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω—ã –ø–æ–≤—Ç–æ—Ä—ã: 0

### 3. –¢–∞–π–º–∞—É—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (connection_timeout)
- **–¢–∏–ø:** Integer (5 - 300 —Å–µ–∫—É–Ω–¥)
- **–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é:** 30 —Å–µ–∫—É–Ω–¥
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç SMTP —Å–µ—Ä–≤–µ—Ä–∞
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
  - –õ–æ–∫–∞–ª—å–Ω—ã–π SMTP: 10-15 —Å–µ–∫—É–Ω–¥
  - –í–Ω–µ—à–Ω–∏–π SMTP (Gmail, Yandex): 30 —Å–µ–∫—É–Ω–¥
  - –ú–µ–¥–ª–µ–Ω–Ω—ã–µ —Å–µ—Ç–∏: 60 —Å–µ–∫—É–Ω–¥

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### BulkEmailSender

–ö–ª–∞—Å—Å `BulkEmailSender` (—Ñ–∞–π–ª: `directory/utils/bulk_email_sender.py`) –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É:

```python
from directory.utils.bulk_email_sender import BulkEmailSender

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
sender = BulkEmailSender(
    email_settings=email_settings,
    delay_seconds=1.0,
    max_retries=3,
    connection_timeout=30
)

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å context manager
with sender:
    for recipient_data in recipients_list:
        success, error = sender.send_email(
            subject="–¢–µ–º–∞ –ø–∏—Å—å–º–∞",
            body_text="–¢–µ–∫—Å—Ç–æ–≤–∞—è –≤–µ—Ä—Å–∏—è",
            to_emails=["user@example.com"],
            body_html="<html>HTML –≤–µ—Ä—Å–∏—è</html>",
            attachment_name="file.docx",
            attachment_content=doc_bytes,
            attachment_mimetype="application/vnd.openxmlformats..."
        )

        if not success:
            logger.error(f"–û—à–∏–±–∫–∞: {error}")
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

#### 1. Connection Pooling
- **–ü—Ä–æ–±–ª–µ–º–∞:** –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ SMTP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–∏—Å—å–º–∞ –∑–∞–Ω–∏–º–∞–µ—Ç ~2-3 —Å–µ–∫—É–Ω–¥—ã
- **–†–µ—à–µ–Ω–∏–µ:** –û–¥–Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤—Å–µ—Ö –ø–∏—Å–µ–º
- **–í—ã–≥–æ–¥–∞:** –ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ 100 –ø–∏—Å–µ–º —ç–∫–æ–Ω–æ–º–∏—è ~200-300 —Å–µ–∫—É–Ω–¥ (3-5 –º–∏–Ω—É—Ç)

#### 2. Rate Limiting
- **–ü—Ä–æ–±–ª–µ–º–∞:** –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–∏—Å–µ–º –±—ã—Å—Ç—Ä–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –±–∞–Ω—É SMTP –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
- **–†–µ—à–µ–Ω–∏–µ:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–∏—Å—å–º–∞–º–∏
- **–í—ã–≥–æ–¥–∞:** –ó–∞—â–∏—Ç–∞ –æ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞

–ü—Ä–∏–º–µ—Ä:
```
–ë–µ–∑ rate limiting:  100 –ø–∏—Å–µ–º –∑–∞ ~10 —Å–µ–∫—É–Ω–¥  ‚Üí –ë–ê–ù
–° rate limiting:    100 –ø–∏—Å–µ–º –∑–∞ ~100 —Å–µ–∫—É–Ω–¥ ‚Üí –û–ö
```

#### 3. Retry –º–µ—Ö–∞–Ω–∏–∑–º
- **–ü—Ä–æ–±–ª–µ–º–∞:** –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏ –ø—Ä–∏–≤–æ–¥—è—Ç –∫ –ø–æ—Ç–µ—Ä–µ –ø–∏—Å–µ–º
- **–†–µ—à–µ–Ω–∏–µ:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
- **–í—ã–≥–æ–¥–∞:** –ù–∞–¥—ë–∂–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ –ø—Ä–∏ –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Å–µ—Ç–∏

–ê–ª–≥–æ—Ä–∏—Ç–º retry:
```
–ü–æ–ø—ã—Ç–∫–∞ 1: –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
–ü–æ–ø—ã—Ç–∫–∞ 2: —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã  (2^1)
–ü–æ–ø—ã—Ç–∫–∞ 3: —á–µ—Ä–µ–∑ 4 —Å–µ–∫—É–Ω–¥—ã  (2^2)
–ü–æ–ø—ã—Ç–∫–∞ 4: —á–µ—Ä–µ–∑ 8 —Å–µ–∫—É–Ω–¥   (2^3)
```

#### 4. –£–º–Ω–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—à–∏–±–æ–∫

–°–∏—Å—Ç–µ–º–∞ —Ä–∞–∑–ª–∏—á–∞–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏:

**–í—Ä–µ–º–µ–Ω–Ω—ã–µ (retry –≤–æ–∑–º–æ–∂–µ–Ω):**
- Timeout
- Connection refused
- Server busy
- Too many connections

**–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ (retry –±–µ—Å–ø–æ–ª–µ–∑–µ–Ω):**
- Authentication failed
- Invalid credentials
- Mailbox unavailable
- Relay access denied

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### –õ–æ–≥–∏ BulkEmailSender

```
INFO: BulkEmailSender –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω: delay=1.0s, max_retries=3, timeout=30s
INFO: ‚úÖ SMTP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç–æ
DEBUG: ‚è±Ô∏è Rate limiting: –ø–∞—É–∑–∞ 0.85s
INFO: ‚úÖ –û–±—Ä–∞–∑–µ—Ü –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –¥–ª—è –ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ 1
WARNING: ‚ö†Ô∏è –í—Ä–µ–º–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ (–ø–æ–ø—ã—Ç–∫–∞ 1/4): Timeout
INFO: üîÑ –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ #1 —á–µ—Ä–µ–∑ 2s
INFO: ‚úÖ –£—Å–ø–µ—Ö –ø–æ—Å–ª–µ 1 –ø–æ–≤—Ç–æ—Ä(–æ–≤)
ERROR: ‚ùå –§–∏–Ω–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞ –ø–æ—Å–ª–µ 4 –ø–æ–ø—ã—Ç–æ–∫: Authentication failed
INFO: ‚úÖ SMTP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ=28, –æ—à–∏–±–æ–∫=1, –ø–æ–≤—Ç–æ—Ä–æ–≤=5
```

### –ú–æ–¥–µ–ª–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

**InstructionJournalSendLog** - –æ–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞—Å—Å—ã–ª–∫–µ:
- `organization` - –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è
- `initiated_by` - –∫—Ç–æ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–ª
- `briefing_date`, `briefing_type`, `briefing_reason` - –¥–∞–Ω–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–∞
- `total_subdivisions` - –≤—Å–µ–≥–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π
- `successful_count` - —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
- `failed_count` - –æ—à–∏–±–æ–∫
- `skipped_count` - –ø—Ä–æ–ø—É—â–µ–Ω–æ
- `status` - —Å—Ç–∞—Ç—É—Å —Ä–∞—Å—Å—ã–ª–∫–∏ (in_progress, completed, partial, failed)

**InstructionJournalSendDetail** - –¥–µ—Ç–∞–ª–∏ –ø–æ –∫–∞–∂–¥–æ–º—É –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—é:
- `send_log` - —Å—Å—ã–ª–∫–∞ –Ω–∞ –æ–±—â–∏–π –ª–æ–≥
- `subdivision` - –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ
- `status` - —Å—Ç–∞—Ç—É—Å (success, failed, skipped)
- `skip_reason` - –ø—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ–ø—É—Å–∫–∞/–æ—à–∏–±–∫–∏
- `recipients` - JSON —Å–ø–∏—Å–æ–∫ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
- `recipients_count` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
- `employees_count` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
- `email_subject` - —Ç–µ–º–∞ –ø–∏—Å—å–º–∞
- `error_message` - —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ (–µ—Å–ª–∏ –µ—Å—Ç—å)
- `sent_at` - –≤—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ (–¥–ª—è —É—Å–ø–µ—à–Ω—ã—Ö)

## üöÄ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ: –¥–æ –∏ –ø–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

#### –°—Ç–∞—Ä–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (–±–µ–∑ BulkEmailSender):
```
100 –ø–∏—Å–µ–º:
- –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: 100 √ó 2 —Å–µ–∫ = 200 —Å–µ–∫
- –û—Ç–ø—Ä–∞–≤–∫–∞: 100 √ó 0.5 —Å–µ–∫ = 50 —Å–µ–∫
- –ë–µ–∑ rate limiting ‚Üí —Ä–∏—Å–∫ –±–∞–Ω–∞
- –ë–µ–∑ retry ‚Üí –ø–æ—Ç–µ—Ä—è –ø–∏—Å–µ–º –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
–ò–¢–û–ì–û: ~250 —Å–µ–∫—É–Ω–¥ (4 –º–∏–Ω—É—Ç—ã) + —Ä–∏—Å–∫ –±–∞–Ω–∞
```

#### –ù–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (—Å BulkEmailSender):
```
100 –ø–∏—Å–µ–º (delay=1.0 —Å–µ–∫, max_retries=3):
- –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: 1 √ó 2 —Å–µ–∫ = 2 —Å–µ–∫
- –û—Ç–ø—Ä–∞–≤–∫–∞ —Å rate limiting: 100 √ó 1 —Å–µ–∫ = 100 —Å–µ–∫
- Retry –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö: ~5 –ø–∏—Å–µ–º √ó 2-8 —Å–µ–∫ = 10-40 —Å–µ–∫
- –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: 0 —Å–µ–∫
–ò–¢–û–ì–û: ~102-142 —Å–µ–∫—É–Ω–¥—ã (1.7-2.4 –º–∏–Ω—É—Ç—ã) + –∑–∞—â–∏—Ç–∞ –æ—Ç –±–∞–Ω–∞
```

**–£—Å–∫–æ—Ä–µ–Ω–∏–µ: 1.76√ó - 2.45√ó**

## üìù –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä 1: –ú–∞—Å—Å–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ –∂—É—Ä–Ω–∞–ª–æ–≤ –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–µ–π

```python
def send_instruction_samples_for_organization(request, organization_id):
    # –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
    email_settings = EmailSettings.get_settings(organization)

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è BulkEmailSender
    bulk_sender = BulkEmailSender(
        email_settings=email_settings,
        delay_seconds=float(email_settings.email_delay_seconds),
        max_retries=email_settings.max_retry_attempts,
        connection_timeout=email_settings.connection_timeout
    )

    # –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ context manager
    with bulk_sender:
        for subdivision in subdivisions:
            # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞
            doc = generate_document(subdivision)

            # –û—Ç–ø—Ä–∞–≤–∫–∞ email
            success, error = bulk_sender.send_email(
                subject=f"–û–±—Ä–∞–∑–µ—Ü –∂—É—Ä–Ω–∞–ª–∞: {subdivision.name}",
                body_text="–¢–µ–∫—Å—Ç–æ–≤–∞—è –≤–µ—Ä—Å–∏—è",
                to_emails=recipients,
                body_html=html_message,
                attachment_name=doc['filename'],
                attachment_content=doc['content'],
                attachment_mimetype='application/vnd.openxmlformats...'
            )

            if success:
                logger.info(f"‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –¥–ª—è {subdivision.name}")
            else:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –¥–ª—è {subdivision.name}: {error}")

    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    stats = bulk_sender.get_stats()
    logger.info(f"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {stats['sent']}, –û—à–∏–±–æ–∫: {stats['failed']}, –ü–æ–≤—Ç–æ—Ä–æ–≤: {stats['retries']}")
```

### –ü—Ä–∏–º–µ—Ä 2: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏

```python
# –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç: utility_scripts/test_bulk_email.py
import os
import sys
import django

sys.path.insert(0, '/home/django/webapps/potby')
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'settings_prod')
django.setup()

from deadline_control.models import EmailSettings
from directory.models import Organization
from directory.utils.bulk_email_sender import BulkEmailSender

# –ü–æ–ª—É—á–∏—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é
org = Organization.objects.get(short_name_ru="–ú–∏–Ω—Å–∫–∞—è –≥–æ—Ä–æ–¥—Å–∫–∞—è –Ω–æ—Ç–∞—Ä–∏–∞–ª—å–Ω–∞—è –ø–∞–ª–∞—Ç–∞")
email_settings = EmailSettings.get_settings(org)

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
if not email_settings.is_active:
    print("Email –æ—Ç–∫–ª—é—á–µ–Ω –¥–ª—è —ç—Ç–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏")
    exit()

# –¢–µ—Å—Ç–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞
sender = BulkEmailSender(
    email_settings=email_settings,
    delay_seconds=1.0,
    max_retries=3
)

with sender:
    success, error = sender.send_email(
        subject="–¢–µ—Å—Ç –º–∞—Å—Å–æ–≤–æ–π —Ä–∞—Å—Å—ã–ª–∫–∏",
        body_text="–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ –ø–∏—Å—å–º–æ –æ—Ç BulkEmailSender",
        to_emails=["test@example.com"],
        body_html="<html><body><h1>–¢–µ—Å—Ç</h1></body></html>"
    )

    if success:
        print("‚úÖ –ü–∏—Å—å–º–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!")
    else:
        print(f"‚ùå –û—à–∏–±–∫–∞: {error}")

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
stats = sender.get_stats()
print(f"–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: {stats}")
```

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö SMTP –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤

### Gmail
```
SMTP: smtp.gmail.com:587
TLS: –î–∞
Delay: 1-2 —Å–µ–∫—É–Ω–¥—ã
Retry: 3 –ø–æ–ø—ã—Ç–∫–∏
Timeout: 30 —Å–µ–∫—É–Ω–¥
–õ–∏–º–∏—Ç: 500 –ø–∏—Å–µ–º/–¥–µ–Ω—å
```

### Yandex
```
SMTP: smtp.yandex.ru:587
TLS: –î–∞
Delay: 1-2 —Å–µ–∫—É–Ω–¥—ã
Retry: 3 –ø–æ–ø—ã—Ç–∫–∏
Timeout: 30 —Å–µ–∫—É–Ω–¥
–õ–∏–º–∏—Ç: 500 –ø–∏—Å–µ–º/–¥–µ–Ω—å
```

### –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π Exchange
```
SMTP: mail.company.com:587
TLS: –î–∞/–ù–µ—Ç (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫)
Delay: 0.5-1 —Å–µ–∫—É–Ω–¥–∞
Retry: 2 –ø–æ–ø—ã—Ç–∫–∏
Timeout: 15-30 —Å–µ–∫—É–Ω–¥
–õ–∏–º–∏—Ç: –æ–±—ã—á–Ω–æ –≤—ã—à–µ (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å —É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞)
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–ù–µ –ø—Ä–µ–≤—ã—à–∞—Ç—å –ª–∏–º–∏—Ç—ã SMTP –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞:**
   - Gmail/Yandex: –º–∞–∫—Å–∏–º—É–º 500 –ø–∏—Å–µ–º –≤ –¥–µ–Ω—å
   - –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –∞–∫–∫–∞—É–Ω—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –Ω–∞ 24 —á–∞—Å–∞

2. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤:**
   - –†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ª–æ–≥–∏ Gunicorn –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–¥–º–∏–Ω–∫—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ InstructionJournalSendLog

3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ –º–∞—Å—Å–æ–≤–æ–π —Ä–∞—Å—Å—ã–ª–∫–æ–π:**
   - –í—Å–µ–≥–¥–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –Ω–µ–±–æ–ª—å—à–æ–π –≤—ã–±–æ—Ä–∫–µ (2-3 –ø–∏—Å—å–º–∞)
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ email –¥–æ—Ö–æ–¥—è—Ç –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è

4. **Backup –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏:**
   - –ü–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º EmailSettings —Å–æ–∑–¥–∞–≤–∞—Ç—å backup –ë–î
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `./backup_db.sh`

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `directory/utils/bulk_email_sender.py` - –æ—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å BulkEmailSender
- `directory/views/documents/instruction_journal.py` - –ø—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- `deadline_control/models/email_settings.py` - –º–æ–¥–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ email
- `deadline_control/migrations/0034_add_bulk_email_settings.py` - –º–∏–≥—Ä–∞—Ü–∏—è –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π
- `directory/migrations/0065_fix_commission_type_max_length.py` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Commission

## üéì –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [Django Email Documentation](https://docs.djangoproject.com/en/5.0/topics/email/)
- [Gmail SMTP Limits](https://support.google.com/a/answer/166852)
- [Yandex SMTP Documentation](https://yandex.ru/support/mail/mail-clients/others.html)

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2026-01-04
**–í–µ—Ä—Å–∏—è:** 1.0
**–ê–≤—Ç–æ—Ä:** Claude Code Assistant
