# 📧 Система рассылки образцов журналов повторных инструктажей

## Оглавление
1. [Общее описание](#общее-описание)
2. [Требования](#требования)
3. [Архитектура системы](#архитектура-системы)
4. [Модели данных](#модели-данных)
5. [Логика сбора получателей](#логика-сбора-получателей)
6. [Интерфейс пользователя](#интерфейс-пользователя)
7. [Шаблоны email-писем](#шаблоны-email-писем)
8. [История рассылок](#история-рассылок)
9. [Последовательность реализации](#последовательность-реализации)
10. [Примеры использования](#примеры-использования)

---

## Общее описание

Система автоматической рассылки образцов журналов повторных инструктажей по охране труда предназначена для:
- Автоматической генерации образцов заполнения журналов инструктажей по подразделениям
- Формирования персонализированных email-писем с вложенными документами
- Рассылки писем ответственным за охрану труда в каждом подразделении
- Ведения истории всех отправленных рассылок

### Основные возможности
- ✅ Группировка сотрудников по структурным подразделениям
- ✅ Автоматический сбор получателей из трёх источников
- ✅ Редактируемые шаблоны писем с поддержкой динамических заглушек
- ✅ Прикрепление сгенерированных DOCX документов
- ✅ Полная история отправок с возможностью аудита
- ✅ Интеграция с существующей системой EmailSettings (SMTP)

---

## Требования

### Функциональные требования

1. **Хранение email-адресов** (комбинированный подход):
   - Email на уровне структурных подразделений (inline-модель)
   - Email сотрудников с должностью "Ответственный за ОТ"
   - Общие email организации из существующей EmailSettings

2. **Интерфейс рассылки**:
   - Отдельная страница для настройки и отправки
   - Редактируемое поле "Тема письма"
   - Редактируемое поле "Текст письма" с поддержкой заглушек
   - Пояснения доступных заглушек на странице
   - Выбор сотрудников через древовидный интерфейс
   - Параметры инструктажа (дата, вид, причина)

3. **Навигация**:
   - Пункт меню "Рассылка журналов инструктажей"
   - Кнопка "Перейти к рассылке" на странице формирования журналов
   - Пункт меню "История рассылок" (опционально)

4. **История отправок**:
   - Сохранение всех отправленных писем
   - Информация о получателях, датах, статусах
   - Возможность просмотра деталей рассылки
   - Фильтрация по организациям, подразделениям, датам

### Технические требования

- **Django версия:** 5.0+
- **Python версия:** 3.11+
- **Email backend:** Использование существующей EmailSettings
- **Формат документов:** DOCX (Microsoft Word)
- **База данных:** PostgreSQL (production) / SQLite (development)

---

## Архитектура системы

### Диаграмма компонентов

```
┌─────────────────────────────────────────────────────────────┐
│                    Пользовательский интерфейс                │
├─────────────────────────────────────────────────────────────┤
│  InstructionJournalMailingView  │  MailingHistoryView       │
│  (Страница рассылки)             │  (История отправок)       │
└─────────────────┬───────────────────────────────┬───────────┘
                  │                               │
                  ▼                               ▼
┌─────────────────────────────────┐   ┌──────────────────────┐
│   Утилиты сбора получателей     │   │  Модели истории      │
│   - collect_recipients()        │   │  - MailingHistory    │
│   - render_template()           │   └──────────────────────┘
└─────────────┬───────────────────┘
              │
              ▼
┌─────────────────────────────────────────────────────────────┐
│                        Модели данных                         │
├──────────────────┬──────────────────┬─────────────────────┬─┤
│ SubdivisionEmail │  EmailTemplate   │ MailingHistory      │ │
│ (Email подразд.) │ (Шаблоны писем)  │ (История отправок)  │ │
└──────────────────┴──────────────────┴─────────────────────┴─┘
              │
              ▼
┌─────────────────────────────────────────────────────────────┐
│              Генерация и отправка документов                 │
├──────────────────────────────────┬──────────────────────────┤
│  InstructionJournalGenerator     │  Django EmailMessage     │
│  (Генерация DOCX)                │  (Отправка email)        │
└──────────────────────────────────┴──────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────────────────────────┐
│                      SMTP (EmailSettings)                    │
│             Существующая система отправки email              │
└─────────────────────────────────────────────────────────────┘
```

### Поток данных

```
1. Пользователь → Открывает страницу рассылки
2. Система → Загружает дерево сотрудников с инструкциями
3. Пользователь → Выбирает сотрудников, заполняет форму
4. Система → Группирует сотрудников по подразделениям
5. Для каждого подразделения:
   5.1. Собирает список получателей (3 источника)
   5.2. Генерирует DOCX документ
   5.3. Заполняет заглушки в теме и тексте письма
   5.4. Создаёт запись в MailingHistory (status='sending')
   5.5. Отправляет email с вложением
   5.6. Обновляет статус в истории (sent/failed)
6. Система → Показывает результат пользователю
```

---

## Модели данных

### 1. SubdivisionEmail

**Файл:** `directory/models/subdivision_email.py`

Хранит email-адреса для уведомлений структурного подразделения.

```python
class SubdivisionEmail(models.Model):
    """Email-адреса для уведомлений структурного подразделения"""

    subdivision = models.ForeignKey(
        'directory.StructuralSubdivision',
        on_delete=models.CASCADE,
        related_name='notification_emails',
        verbose_name="Структурное подразделение"
    )

    email = models.EmailField(
        verbose_name="Email для уведомлений"
    )

    description = models.CharField(
        max_length=255,
        blank=True,
        verbose_name="Описание",
        help_text="Например: Главный инженер, Отдел кадров"
    )

    is_active = models.BooleanField(
        default=True,
        verbose_name="Активен"
    )

    class Meta:
        verbose_name = "Email для уведомлений"
        verbose_name_plural = "Email для уведомлений"
        ordering = ['email']
```

**Использование:**
- Inline в админке StructuralSubdivision
- Используется функцией `collect_recipients_for_subdivision()`

---

### 2. EmailTemplate

**Файл:** `directory/models/email_template.py`

Шаблоны email-писем для различных типов рассылок.

```python
class EmailTemplate(models.Model):
    """Шаблоны email-писем"""

    TEMPLATE_TYPE_CHOICES = [
        ('instruction_journal', 'Образец журнала инструктажей'),
        # Можно расширить для других типов
    ]

    organization = models.ForeignKey(
        'directory.Organization',
        on_delete=models.CASCADE,
        related_name='email_templates',
        verbose_name="Организация",
        null=True,
        blank=True,
        help_text="Если не указано - общий шаблон для всех"
    )

    template_type = models.CharField(
        max_length=50,
        choices=TEMPLATE_TYPE_CHOICES,
        verbose_name="Тип шаблона"
    )

    subject = models.CharField(
        max_length=255,
        verbose_name="Тема письма",
        help_text="Доступны заглушки: {{ organization }}, {{ date }}, {{ subdivision }}"
    )

    body = models.TextField(
        verbose_name="Текст письма",
        help_text="Доступны заглушки: {{ organization }}, {{ date }}, "
                  "{{ subdivision }}, {{ employee_count }}, {{ instruction_date }}"
    )

    is_default = models.BooleanField(
        default=False,
        verbose_name="Шаблон по умолчанию"
    )

    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        verbose_name = "Шаблон email-письма"
        verbose_name_plural = "Шаблоны email-писем"
        ordering = ['-is_default', 'organization__short_name_ru']

    def __str__(self):
        org_name = self.organization.short_name_ru if self.organization else "Общий"
        return f"{self.get_template_type_display()} - {org_name}"
```

**Поля:**
- `organization` — привязка к организации (NULL = общий шаблон)
- `template_type` — тип шаблона (instruction_journal)
- `subject` — тема письма с заглушками
- `body` — текст письма с заглушками
- `is_default` — флаг шаблона по умолчанию

**Доступные заглушки:**
- `{{ organization }}` — Название организации
- `{{ subdivision }}` — Название подразделения
- `{{ date }}` — Текущая дата (ДД.ММ.ГГГГ)
- `{{ employee_count }}` — Количество сотрудников
- `{{ instruction_date }}` — Дата инструктажа

**Пример шаблона:**
```
Тема: Образец журнала повторных инструктажей - {{ subdivision }} - {{ date }}

Текст:
Уважаемые коллеги!

Направляем образец заполнения журнала повторных инструктажей для подразделения "{{ subdivision }}".

Дата проведения инструктажа: {{ instruction_date }}
Количество сотрудников: {{ employee_count }} чел.

Пожалуйста, ознакомьтесь с прикреплённым документом и проведите инструктаж в установленный срок.

---
С уважением,
Служба охраны труда {{ organization }}
```

---

### 3. MailingHistory

**Файл:** `directory/models/mailing_history.py`

История отправленных рассылок.

```python
class MailingHistory(models.Model):
    """История отправленных рассылок образцов журналов"""

    STATUS_CHOICES = [
        ('pending', 'Ожидает отправки'),
        ('sending', 'Отправляется'),
        ('sent', 'Отправлено'),
        ('failed', 'Ошибка'),
        ('partial', 'Частично отправлено'),
    ]

    # Связи
    organization = models.ForeignKey(
        'directory.Organization',
        on_delete=models.CASCADE,
        related_name='mailing_history',
        verbose_name="Организация"
    )

    subdivision = models.ForeignKey(
        'directory.StructuralSubdivision',
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        verbose_name="Подразделение"
    )

    user = models.ForeignKey(
        'auth.User',
        on_delete=models.SET_NULL,
        null=True,
        verbose_name="Пользователь, отправивший"
    )

    # Параметры письма
    subject = models.CharField(
        max_length=255,
        verbose_name="Тема письма"
    )

    body = models.TextField(
        verbose_name="Текст письма"
    )

    recipients = models.TextField(
        verbose_name="Получатели",
        help_text="JSON список email-адресов"
    )

    # Параметры инструктажа
    instruction_date = models.DateField(
        verbose_name="Дата инструктажа"
    )

    instruction_type = models.CharField(
        max_length=50,
        default='Повторный',
        verbose_name="Вид инструктажа"
    )

    instruction_reason = models.CharField(
        max_length=255,
        blank=True,
        verbose_name="Причина проведения"
    )

    # Статистика
    employee_count = models.PositiveIntegerField(
        default=0,
        verbose_name="Количество сотрудников"
    )

    recipient_count = models.PositiveIntegerField(
        default=0,
        verbose_name="Количество получателей"
    )

    # Статус
    status = models.CharField(
        max_length=20,
        choices=STATUS_CHOICES,
        default='pending',
        verbose_name="Статус"
    )

    error_message = models.TextField(
        blank=True,
        verbose_name="Сообщение об ошибке"
    )

    # Файл
    attachment_filename = models.CharField(
        max_length=255,
        blank=True,
        verbose_name="Имя прикреплённого файла"
    )

    # Временные метки
    created_at = models.DateTimeField(
        auto_now_add=True,
        verbose_name="Дата создания"
    )

    sent_at = models.DateTimeField(
        null=True,
        blank=True,
        verbose_name="Дата отправки"
    )

    class Meta:
        verbose_name = "История рассылки"
        verbose_name_plural = "История рассылок"
        ordering = ['-created_at']
        indexes = [
            models.Index(fields=['-created_at']),
            models.Index(fields=['organization', '-created_at']),
            models.Index(fields=['status']),
        ]

    def __str__(self):
        return f"{self.subject} - {self.created_at.strftime('%d.%m.%Y %H:%M')}"

    def get_recipients_list(self):
        """Возвращает список получателей из JSON"""
        import json
        try:
            return json.loads(self.recipients)
        except:
            return []

    def set_recipients_list(self, recipients_list):
        """Сохраняет список получателей в JSON"""
        import json
        self.recipients = json.dumps(recipients_list, ensure_ascii=False)
        self.recipient_count = len(recipients_list)

    def get_status_badge(self):
        """Возвращает HTML-бейдж статуса"""
        badges = {
            'pending': '<span class="badge badge-secondary">Ожидает</span>',
            'sending': '<span class="badge badge-info">Отправляется</span>',
            'sent': '<span class="badge badge-success">Отправлено</span>',
            'failed': '<span class="badge badge-danger">Ошибка</span>',
            'partial': '<span class="badge badge-warning">Частично</span>',
        }
        return badges.get(self.status, self.status)
```

**Индексы:**
- `created_at` (DESC) — для быстрого получения последних рассылок
- `organization + created_at` — для фильтрации по организации
- `status` — для фильтрации по статусу

---

### 4. Изменения в Employee

**Файл:** `directory/models/employee.py`

Добавляется поле email для сотрудников (особенно для ответственных за ОТ).

```python
# Добавить в модель Employee:

email = models.EmailField(
    verbose_name="Email",
    blank=True,
    default='',
    help_text="Email сотрудника для уведомлений (если ответственный за ОТ)"
)
```

---

## Логика сбора получателей

### Функция collect_recipients_for_subdivision()

**Файл:** `directory/utils/email_recipients.py`

```python
def collect_recipients_for_subdivision(subdivision, organization):
    """
    Собирает всех получателей для подразделения.

    Логика приоритетов:
    1. Email из SubdivisionEmail (если есть subdivision и активные email)
    2. Email ответственных за ОТ в этом подразделении (активные сотрудники)
    3. Email из EmailSettings организации (общие получатели)

    Args:
        subdivision: Объект StructuralSubdivision или None
        organization: Объект Organization

    Returns:
        list: Уникальный список email-адресов (без дубликатов)
    """
    from directory.models import Employee

    recipients = set()  # Используем set для автоматического удаления дубликатов

    # 1. Email подразделения (если есть)
    if subdivision:
        subdivision_emails = subdivision.notification_emails.filter(
            is_active=True
        ).values_list('email', flat=True)
        recipients.update(subdivision_emails)

        # 2. Email ответственных за ОТ в подразделении
        responsible_employees = Employee.objects.filter(
            subdivision=subdivision,
            status='active',
            position__is_responsible_for_safety=True,
            email__isnull=False
        ).exclude(email='').values_list('email', flat=True)
        recipients.update(responsible_employees)

    # 3. Email из EmailSettings организации
    try:
        email_settings = organization.email_settings
        if email_settings.is_active:
            org_emails = email_settings.get_recipient_list()
            recipients.update(org_emails)
    except Exception as e:
        logger.warning(f"Не удалось получить EmailSettings для {organization}: {e}")

    return list(recipients)
```

### Диаграмма сбора получателей

```
Подразделение "Производственный цех"
Organization: ООО "БиоМилк"
    │
    ├─► 1. SubdivisionEmail
    │   ├─ engineer@biomilk.com (Главный инженер)
    │   └─ safety@biomilk.com (Служба ОТ)
    │
    ├─► 2. Ответственные за ОТ
    │   └─ ivanov@biomilk.com (Иванов И.И., position.is_responsible_for_safety=True)
    │
    └─► 3. EmailSettings (Организация)
        ├─ hr@biomilk.com
        └─ director@biomilk.com

Результат: [
    "engineer@biomilk.com",
    "safety@biomilk.com",
    "ivanov@biomilk.com",
    "hr@biomilk.com",
    "director@biomilk.com"
]
```

---

## Интерфейс пользователя

### Страница рассылки

**URL:** `/directory/instruction-journal/mailing/`

**Шаблон:** `directory/templates/directory/documents/instruction_journal_mailing.html`

#### Структура страницы

```
┌──────────────────────────────────────────────────────────┐
│ 📧 Рассылка образцов журналов инструктажей               │
├──────────────────────────────────────────────────────────┤
│                                                          │
│ 1️⃣ ПАРАМЕТРЫ ИНСТРУКТАЖА                                │
│   ┌─────────────────┬──────────────────┬──────────────┐ │
│   │ 📅 Дата         │ 📋 Вид           │ 📝 Причина   │ │
│   │ [__________]    │ [Повторный ▼]    │ [__________] │ │
│   └─────────────────┴──────────────────┴──────────────┘ │
│                                                          │
│ 2️⃣ НАСТРОЙКА ПИСЬМА                                     │
│   ┌────────────────────────────────────────────────────┐│
│   │ 💡 Доступные заглушки:                             ││
│   │ • {{ organization }} — Название организации        ││
│   │ • {{ subdivision }} — Название подразделения       ││
│   │ • {{ date }} — Текущая дата                        ││
│   │ • {{ employee_count }} — Количество сотрудников    ││
│   │ • {{ instruction_date }} — Дата инструктажа        ││
│   └────────────────────────────────────────────────────┘│
│                                                          │
│   Тема письма:                                          │
│   [________________________________________________]     │
│                                                          │
│   Текст письма:                                         │
│   ┌────────────────────────────────────────────────┐   │
│   │                                                │   │
│   │                                                │   │
│   │                                                │   │
│   └────────────────────────────────────────────────┘   │
│                                                          │
│ 3️⃣ ВЫБОР СОТРУДНИКОВ                                    │
│   ┌────────────────────────────────────────────────┐   │
│   │ 🔍 Поиск... [___________]  [Развернуть все]   │   │
│   ├────────────────────────────────────────────────┤   │
│   │ ☑ 🏢 ООО "БиоМилк"                             │   │
│   │   ☑ 🏭 Производственный цех (15 сотр.)         │   │
│   │     ☑ 👤 Иванов И.И. - Мастер участка         │   │
│   │     ☐ 👑 Петров П.П. - Инженер по ОТ          │   │
│   │   ☑ 🏭 Административный корпус (8 сотр.)       │   │
│   └────────────────────────────────────────────────┘   │
│                                                          │
│   Выбрано: 23 сотрудника                                │
│                                                          │
│   [ 📧 Отправить рассылку ]  [ 📋 История рассылок ]   │
│                                                          │
└──────────────────────────────────────────────────────────┘
```

#### Элементы интерфейса

**1. Параметры инструктажа:**
- Поле даты инструктажа (обязательное)
- Выпадающий список вида инструктажа (Повторный/Внеплановый/Целевой)
- Поле причины (появляется для внеплановых/целевых)

**2. Настройка письма:**
- Информационный блок с доступными заглушками
- Текстовое поле "Тема письма" (предзаполнено из шаблона)
- Текстовая область "Текст письма" (предзаполнена из шаблона)

**3. Выбор сотрудников:**
- Древовидный список (переиспользование из instruction_journal_tree.html)
- Чекбоксы для выбора
- Поиск по ФИО
- Кнопки "Развернуть все" / "Свернуть все"
- Счётчик выбранных сотрудников

**4. Кнопки действий:**
- "Отправить рассылку" — основное действие
- "История рассылок" — переход к истории

---

### Страница истории рассылок

**URL:** `/directory/instruction-journal/mailing/history/`

**Шаблон:** `directory/templates/directory/documents/mailing_history.html`

#### Структура страницы

```
┌──────────────────────────────────────────────────────────────────────┐
│ 📜 История рассылок образцов журналов инструктажей                   │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ Фильтры: [Организация ▼] [Подразделение ▼] [Статус ▼] [Период]    │
│                                                                      │
│ ┌──────┬──────────┬─────────────┬──────┬────────┬─────────┬────────┐│
│ │ Дата │ Организ. │ Подраздел.  │ Тема │ Получ. │ Статус  │ Действ.││
│ ├──────┼──────────┼─────────────┼──────┼────────┼─────────┼────────┤│
│ │01.12 │ БиоМилк  │ Произв. цех │ Обр..│ 5 адр. │✅ Отпр. │ 👁 👤 ││
│ │30.11 │ БиоМилк  │ Админ. корп.│ Обр..│ 3 адр. │✅ Отпр. │ 👁 👤 ││
│ │29.11 │ БезопПлюс│ —           │ Обр..│ 2 адр. │❌ Ошиб. │ 👁 👤 ││
│ └──────┴──────────┴─────────────┴──────┴────────┴─────────┴────────┘│
│                                                                      │
│ Показано: 1-20 из 156          [←] [1] [2] [3] ... [8] [→]         │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘
```

#### Колонки таблицы

1. **Дата отправки** — дата и время отправки
2. **Организация** — краткое название
3. **Подразделение** — название или "—"
4. **Тема письма** — усечённая до 50 символов
5. **Получатели** — количество адресов
6. **Статус** — цветной бейдж (Отправлено/Ошибка/и т.д.)
7. **Действия**:
   - 👁 Просмотр деталей (модальное окно)
   - 👤 Информация о пользователе

#### Модальное окно деталей

```
┌─────────────────────────────────────────────────────┐
│ 📧 Детали рассылки                          [×]     │
├─────────────────────────────────────────────────────┤
│                                                     │
│ Организация: ООО "БиоМилк"                          │
│ Подразделение: Производственный цех                 │
│ Дата создания: 01.12.2025 14:35                     │
│ Дата отправки: 01.12.2025 14:36                     │
│ Пользователь: Иванова А.С.                          │
│                                                     │
│ ─────────────────────────────────────────────────   │
│                                                     │
│ Тема: Образец журнала - Производственный цех        │
│                                                     │
│ Текст письма:                                       │
│ ┌─────────────────────────────────────────────┐     │
│ │ Уважаемые коллеги!                          │     │
│ │                                             │     │
│ │ Направляем образец заполнения...            │     │
│ └─────────────────────────────────────────────┘     │
│                                                     │
│ Получатели (5):                                     │
│ • engineer@biomilk.com (Главный инженер)            │
│ • safety@biomilk.com (Служба ОТ)                    │
│ • ivanov@biomilk.com (Иванов И.И.)                  │
│ • hr@biomilk.com                                    │
│ • director@biomilk.com                              │
│                                                     │
│ Прикреплённый файл:                                 │
│ 📄 Образец_журнала_Производственный цех.docx        │
│                                                     │
│ Параметры инструктажа:                              │
│ • Дата: 15.12.2025                                  │
│ • Вид: Повторный                                    │
│ • Сотрудников: 15 чел.                              │
│                                                     │
│                              [ Закрыть ]            │
└─────────────────────────────────────────────────────┘
```

---

## Шаблоны email-писем

### Создание шаблона в админке

**Путь:** Админка → Справочник → Шаблоны email-писем → Добавить

**Поля формы:**
1. **Организация** — выбрать организацию или оставить пустым для общего шаблона
2. **Тип шаблона** — "Образец журнала инструктажей"
3. **Тема письма** — с заглушками
4. **Текст письма** — с заглушками
5. **Шаблон по умолчанию** — ☑ (один на организацию)

### Пример шаблона по умолчанию

**Тема:**
```
Образец журнала повторных инструктажей - {{ subdivision }} - {{ date }}
```

**Текст:**
```
Уважаемые коллеги!

Направляем образец заполнения журнала повторных инструктажей для подразделения "{{ subdivision }}".

Параметры инструктажа:
• Дата проведения: {{ instruction_date }}
• Вид инструктажа: Повторный
• Количество сотрудников: {{ employee_count }} чел.

Пожалуйста, ознакомьтесь с прикреплённым документом и проведите инструктаж в установленный срок.

В документе указаны:
✓ ФИО сотрудников и их должности
✓ Номера инструкций по охране труда
✓ Шаблонные поля для заполнения

Если у вас возникнут вопросы, обращайтесь в службу охраны труда.

---
С уважением,
Служба охраны труда {{ organization }}

Это автоматическое уведомление из системы OT_online
```

### Загрузка шаблона при первом использовании

При отсутствии шаблона система использует встроенный дефолтный шаблон (hardcoded в коде).

**Файл:** `directory/views/documents/instruction_journal_mailing.py`

```python
def get_default_email_body(self):
    """Возвращает дефолтный текст письма"""
    return """Уважаемые коллеги!

Направляем образец заполнения журнала повторных инструктажей для подразделения "{{ subdivision }}".

Параметры инструктажа:
• Дата проведения: {{ instruction_date }}
• Количество сотрудников: {{ employee_count }} чел.

Пожалуйста, ознакомьтесь с прикреплённым документом.

---
С уважением,
Служба охраны труда {{ organization }}"""
```

---

## История рассылок

### Сохранение записи в истории

Запись создаётся **перед отправкой** каждого письма:

```python
# Создаём запись в истории
history = MailingHistory.objects.create(
    organization=organization,
    subdivision=subdivision,
    user=request.user,
    subject=final_subject,
    body=final_body,
    instruction_date=date_povtorny,
    instruction_type=instruction_type,
    instruction_reason=instruction_reason,
    employee_count=len(employees_list),
    attachment_filename=doc['filename'],
    status='sending'
)
history.set_recipients_list(recipients)

try:
    # Отправка письма...
    email.send(fail_silently=False)

    # Обновляем статус на успешный
    history.status = 'sent'
    history.sent_at = timezone.now()
    history.save()

except Exception as e:
    # Сохраняем ошибку
    history.status = 'failed'
    history.error_message = str(e)
    history.save()
    logger.error(f"Ошибка отправки для {subdivision_key}: {e}")
```

### Статусы рассылки

| Статус | Описание | Бейдж |
|--------|----------|-------|
| `pending` | Ожидает отправки (не используется) | 🔘 Серый |
| `sending` | В процессе отправки | 🔵 Синий |
| `sent` | Успешно отправлено | ✅ Зелёный |
| `failed` | Ошибка при отправке | ❌ Красный |
| `partial` | Частично отправлено (резерв) | ⚠️ Жёлтый |

### Аудит и отчётность

**Доступные фильтры в истории:**
- По организации
- По подразделению
- По статусу
- По дате (диапазон)
- По пользователю

**Экспорт данных:**
Админка MailingHistory поддерживает экспорт в CSV/XLSX через django-import-export.

---

## Последовательность реализации

### Этап 1: Модели и база данных (2-3 часа)

1. **Создать модель SubdivisionEmail**
   - Файл: `directory/models/subdivision_email.py`
   - Связь: ForeignKey к StructuralSubdivision

2. **Создать модель EmailTemplate**
   - Файл: `directory/models/email_template.py`
   - Поддержка заглушек

3. **Создать модель MailingHistory**
   - Файл: `directory/models/mailing_history.py`
   - JSON для получателей

4. **Добавить поле email в Employee**
   - Файл: `directory/models/employee.py`
   - EmailField с blank=True

5. **Обновить __init__.py**
   - Импорт новых моделей

6. **Создать миграции**
   ```bash
   py manage.py makemigrations directory --name add_email_mailing_models
   ```

7. **Применить миграции**
   ```bash
   py manage.py migrate
   ```

### Этап 2: Админка (1-2 часа)

8. **Создать inline SubdivisionEmailInline**
   - Файл: `directory/admin/subdivision.py`
   - TabularInline с 1 extra

9. **Создать EmailTemplateAdmin**
   - Файл: `directory/admin/email_template.py`
   - Фильтры по организации, типу
   - Поиск по теме, тексту

10. **Создать MailingHistoryAdmin**
    - Файл: `directory/admin/mailing_history.py`
    - Read-only (только просмотр)
    - Фильтры по статусу, датам, организации
    - Кастомные колонки с бейджами
    - Экспорт в CSV/XLSX

### Этап 3: Утилиты (1 час)

11. **Создать функцию collect_recipients_for_subdivision()**
    - Файл: `directory/utils/email_recipients.py`
    - Логика сбора из 3 источников
    - Удаление дубликатов

12. **Создать функцию render_template()**
    - Файл: `directory/utils/email_recipients.py`
    - Замена заглушек на значения
    - Использование простого str.replace() или Jinja2

### Этап 4: Представления (3-4 часа)

13. **Создать InstructionJournalMailingView**
    - Файл: `directory/views/documents/instruction_journal_mailing.py`
    - GET: показ формы с деревом сотрудников
    - POST: обработка отправки
    - Методы:
      - `get_user_organization()` — определение организации пользователя
      - `get_email_template()` — получение шаблона письма
      - `get_employees_queryset()` — базовый queryset сотрудников
      - `build_tree_structure()` — построение дерева (переиспользование)
      - `group_by_subdivision()` — группировка по подразделениям
      - `send_emails()` — отправка писем
      - `render_template()` — замена заглушек

14. **Создать MailingHistoryView**
    - Файл: `directory/views/documents/mailing_history.py`
    - ListView с пагинацией
    - Фильтры через GET-параметры
    - Детали в модальном окне (AJAX)

15. **Интегрировать сохранение истории**
    - В метод `send_emails()` добавить создание MailingHistory
    - Обновление статуса после отправки

### Этап 5: Шаблоны (2-3 часа)

16. **Создать instruction_journal_mailing.html**
    - Файл: `directory/templates/directory/documents/instruction_journal_mailing.html`
    - Секции: параметры, письмо, сотрудники
    - Информация о заглушках
    - Переиспользование древовидного списка

17. **Создать mailing_history.html**
    - Файл: `directory/templates/directory/documents/mailing_history.html`
    - Таблица с историей
    - Фильтры
    - Модальное окно деталей

18. **Добавить кнопку на instruction_journal_tree.html**
    - Кнопка "Перейти к рассылке"
    - Рядом с существующими кнопками скачивания

### Этап 6: URL и навигация (30 мин)

19. **Добавить URL-маршруты**
    - Файл: `directory/urls.py`
    - `instruction-journal/mailing/`
    - `instruction-journal/mailing/history/`

20. **Добавить пункты меню**
    - Файл: `templates/base.html`
    - "Рассылка журналов инструктажей"
    - "История рассылок"

### Этап 7: Тестирование (2-3 часа)

21. **Создать тестовые данные**
    - Подразделение с email
    - Сотрудники (обычные + ответственные за ОТ)
    - Email в EmailSettings

22. **Протестировать сбор получателей**
    - Проверить все 3 источника
    - Проверить удаление дубликатов

23. **Протестировать отправку писем**
    - Реальная отправка через SMTP
    - Проверка вложений

24. **Проверить заглушки**
    - Все заглушки корректно заменяются

25. **Проверить сохранение истории**
    - Статусы сохраняются правильно
    - Ошибки логируются

26. **Проверить интерфейс истории**
    - Фильтры работают
    - Детали отображаются

### Этап 8: Документация (1 час)

27. **Создать инструкцию для пользователей**
    - Файл: `docs/INSTRUCTION_JOURNAL_MAILING_USER_GUIDE.md`
    - Как настроить email
    - Как отправить рассылку
    - Как посмотреть историю

28. **Обновить CLAUDE.md**
    - Описание новой функциональности
    - Структура моделей
    - Примеры использования

---

## Примеры использования

### Пример 1: Настройка email для подразделения

**Шаг 1:** Открыть админку → Справочник → Структурные подразделения

**Шаг 2:** Выбрать подразделение "Производственный цех"

**Шаг 3:** В секции "Email для уведомлений" добавить:
```
Email: engineer@biomilk.com
Описание: Главный инженер
Активен: ☑
```

**Шаг 4:** Сохранить

### Пример 2: Создание шаблона письма

**Шаг 1:** Открыть админку → Справочник → Шаблоны email-писем → Добавить

**Шаг 2:** Заполнить:
```
Организация: ООО "БиоМилк" (или пустое для общего)
Тип шаблона: Образец журнала инструктажей
Шаблон по умолчанию: ☑

Тема письма:
Журнал инструктажей - {{ subdivision }} от {{ date }}

Текст письма:
Добрый день!

Направляем образец журнала для {{ subdivision }}.

Дата инструктажа: {{ instruction_date }}
Сотрудников: {{ employee_count }}

С уважением,
{{ organization }}
```

**Шаг 3:** Сохранить

### Пример 3: Отправка рассылки

**Шаг 1:** Открыть "Рассылка журналов инструктажей"

**Шаг 2:** Заполнить параметры:
```
Дата инструктажа: 15.12.2025
Вид инструктажа: Повторный
```

**Шаг 3:** Проверить/отредактировать тему и текст письма

**Шаг 4:** Выбрать сотрудников в дереве (или оставить всех выбранными)

**Шаг 5:** Нажать "Отправить рассылку"

**Результат:**
```
✅ Отправлено писем: 3
   • Производственный цех: 5 получателей
   • Административный корпус: 3 получателя
   • Складское хозяйство: 2 получателя
```

### Пример 4: Просмотр истории

**Шаг 1:** Открыть "История рассылок"

**Шаг 2:** Применить фильтры:
```
Организация: ООО "БиоМилк"
Период: Последние 30 дней
Статус: Отправлено
```

**Шаг 3:** Кликнуть 👁 на интересующей рассылке

**Результат:** Модальное окно с деталями рассылки

---

## Безопасность

### Проверка прав доступа

1. **Уровень представления:**
   - `LoginRequiredMixin` — только для авторизованных
   - `AccessControlHelper.filter_queryset()` — фильтрация по организациям пользователя

2. **Уровень данных:**
   - Пользователи видят только свои организации
   - История фильтруется по доступным организациям

### Валидация email

- Django `EmailField` с автоматической валидацией
- Проверка существования получателей перед отправкой
- Логирование всех попыток отправки

### Защита от спама

- Нет публичного API (только для авторизованных пользователей)
- Опционально: rate limiting (можно добавить в будущем)

### Безопасность SMTP

- Использование существующей `EmailSettings`
- Поддержка TLS/SSL
- Пароли хранятся в БД (рекомендуется шифрование)

---

## Мониторинг и отладка

### Логирование

Все действия логируются в файл `logs/mailing.log`:

```python
# Примеры логов
[INFO] Начало рассылки для Производственный цех: 15 сотрудников
[INFO] Собрано получателей: ['engineer@biomilk.com', 'safety@biomilk.com']
[INFO] Письмо отправлено для Производственный цех на 5 адресов
[ERROR] Ошибка отправки для Складское хозяйство: SMTPAuthenticationError
```

### Метрики

Из модели `MailingHistory` можно получить:
- Общее количество рассылок
- Процент успешных отправок
- Средн ее количество получателей
- Частота использования по дням/неделям

### Типичные ошибки и решения

| Ошибка | Причина | Решение |
|--------|---------|---------|
| `SMTPAuthenticationError` | Неверный пароль SMTP | Проверить EmailSettings |
| `NoRecipientsFound` | Нет email у подразделения | Добавить SubdivisionEmail или email ответственных |
| `TemplateNotFound` | Нет шаблона письма | Создать EmailTemplate в админке |
| `DocumentGenerationError` | Ошибка генерации DOCX | Проверить шаблон документа |

---

## Расширение функциональности

### Возможные улучшения в будущем

1. **HTML-письма:**
   - Rich-text редактор для тела письма
   - Поддержка HTML-шаблонов с CSS

2. **Планировщик рассылок:**
   - Отложенная отправка (указать дату/время)
   - Периодические рассылки (каждый месяц)

3. **Множественные вложения:**
   - Прикрепление дополнительных файлов
   - Инструкции, правила ОТ и т.д.

4. **Уведомления:**
   - Push-уведомления при отправке
   - Email пользователю о результате

5. **Аналитика:**
   - Dashboard с графиками отправок
   - Статистика по подразделениям

6. **Интеграция:**
   - Webhook для внешних систем
   - API для отправки через внешние сервисы

---

## Заключение

Система рассылки образцов журналов инструктажей — это комплексное решение, интегрированное с существующей инфраструктурой проекта OT_online.

**Ключевые преимущества:**
- ✅ Автоматизация рутинных задач
- ✅ Гибкая настройка получателей
- ✅ Полная история и аудит
- ✅ Простой и понятный интерфейс
- ✅ Использование существующих компонентов (EmailSettings, древовидный список)

**Готовность к внедрению:**
После завершения всех этапов реализации система готова к продакшн-использованию.

---

**Дата создания:** 02.12.2025
**Версия документа:** 1.0
**Автор:** Claude Code (Anthropic)
