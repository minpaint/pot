# Этап 1: Анализ документов и полей — ЗАВЕРШЁН ✅

## Дата выполнения
07.01.2026

## Цель этапа
Изучить структуру документов и создать маппинг между VML-полями в DOCX-шаблоне, данными в Excel и полями модели ProductionTraining.

---

## Выполненные задачи

### ✅ 1. Извлечение VML-полей из макет.docx

**Файл:** `media/document_templates/learning/макет.docx`

**Результат:** Найдено **30 VML-полей** (WordArt)

**Скрипт:** `utility_scripts/extract_vml_fields.py`

**Отчёт:** `utility_scripts/vml_fields_report.txt`

#### Список VML-полей:

**Статические поля (заполняются из модели):**
- `"БелВиллесден"` — название организации (русский)
- `«Белвілесдэн»` — название организации (белорусский)
- `Иностранном унитарном предприятии` — форма собственности (русский)
- `Замежным унітарным прадпрыемстве` — форма собственности (белорусский)
- `Профессия` — профессия обучения (русский)
- `Профессия (бел)` — профессия обучения (белорусский)
- `Присвоенная профессия` — присвоенная профессия (русский)
- `Присвоенная профессия (бел)` — присвоенная профессия (белорусский)
- `вид подготовки` — тип обучения (русский): "подготовки/переподготовки рабочих по профессии"
- `вид подготовки (бел)` — тип обучения (белорусский)
- `разряд` — квалификационный разряд (русский): "3 (третий)"
- `Разряд (бел)` — квалификационный разряд (белорусский): "3 (трэці)"
- `Подписант` — ФИО подписанта (русский): "А. Лобанов"
- `Подписант (бел)` — ФИО подписанта (белорусский): "А. Лабанаў"

**Динамические поля (из Excel колонок K-U):**
- `1`, `2` — разряд (дублируется)
- `3` — дата начала обучения (русский)
- `4` — фамилия сотрудника (русский)
- `5` — имя отчество сотрудника (русский)
- `6` — фамилия сотрудника (белорусский)
- `7` — имя отчество сотрудника (белорусский)
- `8` — дата экзамена (русский)
- `9` — дата экзамена (белорусский)
- `10` — дата окончания/практики (русский)
- `11` — дата окончания/практики (белорусский)

**Технические поля (дубликаты):**
- `_x0000_s1030`, `_x0000_s1035`, `_x0000_s1036`, `_x0000_s1041`, `_x0000_s1053`

---

### ✅ 2. Анализ структуры Excel

**Файл:** `learning/Обучение на производстве_Сфера Торговый дом.xlsm`

**Скрипты:**
- `utility_scripts/analyze_learning_excel.py` — базовый анализ
- `utility_scripts/analyze_excel_full.py` — полный анализ всех колонок

#### Листы в файле:

1. **База** — основной лист с данными сотрудников
2. **1.Заявление** — шаблон заявления
3. **2.Приказ на обучение** — шаблон приказа
4. **3.Карточка теория** — шаблон карточки теоретического обучения
5. **4. Дневник (переподготовка)** — шаблон дневника переподготовки
6. **4.1 Дневник (подготовка)** — шаблон дневника подготовки
7. **5.Заявление пробная работа** — шаблон заявления на пробную работу
8. **6. Заключение на пробную работу** — шаблон заключения
9. **7.Представление** — шаблон представления
10. **8.Протокол** — шаблон протокола комиссии
11. **Профессии (данные)** — справочник профессий
12. **Ответственные (данные)** — справочник ответственных лиц
13. **Члены комиссии (данные)** — справочник членов комиссии

#### Структура листа "База":

**Строка 6:** Заголовки (имена VML-полей для колонок K-U)

**Строки с 7:** Данные сотрудников (маркер "a" в колонке A)

**Колонки A-J** (не попадают в VML 1-11, используются для других целей):
- **A** — маркер "a" (признак строки данных)
- **B** — дата (Excel serial)
- **C** — ФИО полностью (русский): "Красницкий Виктор Федорович"
- **D** — ФИО в родительном падеже (русский): "Красницкого Виктора Федоровича"
- **E** — ФИО полностью (белорусский): "Красніцкі Віктар Фёдаравіч"
- **F** — дата (Excel serial)
- **G** — образование: "среднее специальное"
- **H** — профессия на предприятии: "кладовщик"
- **I** — имеющаяся квалификация: "автослесарь, А№0584083 от 09.02.2009"
- **J** — место работы: "склад"

**Колонки K-U** (попадают в VML-поля 1-11 в макет.docx):
- **K → VML "1"** — разряд: `1`
- **L → VML "2"** — разряд (дубликат): `1`
- **M → VML "3"** — дата начала обучения: `46010` (Excel serial → 11.01.2026)
- **N → VML "4"** — фамилия: `Красницкий`
- **O → VML "5"** — имя отчество: `Виктор Федорович`
- **P → VML "6"** — фамилия (белорусский): `Красніцкі`
- **Q → VML "7"** — имя отчество (белорусский): `Віктар Фёдаравіч`
- **R → VML "8"** — дата экзамена: `45972` (Excel serial → 11.10.2025)
- **S → VML "9"** — дата экзамена (белорусский): `11 лістапада 2025 г.`
- **T → VML "10"** — дата окончания/практики: `46010` (Excel serial → 11.01.2026)
- **U → VML "11"** — дата окончания/практики (белорусский): `19 снежня 2025 г.`

#### Справочные листы:

**Профессии (данные):**
```
| Колонка A            | Колонка B          |
|----------------------|--------------------|
| Профессия (им.п.)    | Профессия (род.п.) |
| кладовщик            | кладовщика         |
| водитель погрузчика  | водителя погрузчика|
```

**Ответственные (данные):**
```
| Роль                                 | Должность           | ФИО          |
|--------------------------------------|---------------------|--------------|
| Подписант распоряжения               | Директор            | Лобанов А.   |
| Ответственный за исполнение распоря. | заведующий складом  | Дмитрук В.А. |
```

**Члены комиссии (данные):**
```
| Роль в комиссии | Должность          | ФИО          |
|-----------------|--------------------|--------------|
| Председатель    | главный инженер    | Иванов И.И.  |
| Член комиссии   | инженер по ОТ      | Петров П.П.  |
```

---

### ✅ 3. Создание маппинга полей

**Файл:** `production_training/document_templates/field_mapping.py`

Содержит:

1. **STATIC_VML_FIELDS** — статические поля (организация, профессия, тип обучения, разряд, подписант)
2. **DYNAMIC_VML_FIELDS** — динамические поля (ФИО сотрудника, даты)
3. **ADDITIONAL_VML_FIELDS** — технические дубликаты
4. **ALL_VML_FIELDS** — объединённый маппинг
5. **get_vml_replacements(training)** — главная функция для генерации замен

#### Пример использования:

```python
from production_training.document_templates import get_vml_replacements

training = ProductionTraining.objects.get(pk=1)
replacements = get_vml_replacements(training)

# Результат:
# {
#     'Профессия': 'водитель погрузчика',
#     'разряд': '3 (третий)',
#     '1': '3',
#     '2': '3',
#     '3': '11 января 2026 г.',
#     '4': 'Красницкий',
#     '5': 'Виктор Федорович',
#     '8': '11 октября 2025 г.',
#     ...
# }
```

---

### ✅ 4. Вспомогательные скрипты

Созданы следующие утилиты:

1. **extract_vml_fields.py**
   - Извлечение VML-полей из DOCX
   - Использование: `python3 utility_scripts/extract_vml_fields.py path/to/file.docx`

2. **analyze_learning_excel.py**
   - Анализ структуры Excel (лист "База", заголовки, данные)
   - Автоматическая генерация excel_vml_mapping.py

3. **analyze_excel_full.py**
   - Полный анализ всех колонок A-Z
   - Анализ справочных листов

---

## Ключевые выводы

### 1. Двухуровневая структура полей

**Уровень 1: Статические поля**
- Заполняются из модели ProductionTraining и справочников
- Постоянны для всей организации (название, форма собственности)
- Специфичны для обучения (профессия, тип, разряд)

**Уровень 2: Динамические поля**
- Заполняются из данных сотрудника
- Индивидуальны для каждого обучения (ФИО, даты)

### 2. Дублирование данных

Excel содержит избыточность:
- Разряд дублируется в колонках K и L
- Даты дублируются в числовом (Excel serial) и текстовом (русский/белорусский) форматах
- ФИО дублируется для русского и белорусского языков

**Рекомендация:** В модели ProductionTraining хранить минимум данных, форматирование делать в генераторах.

### 3. Отсутствующие данные в модели

В текущей модели `ProductionTraining` **отсутствуют** некоторые поля из Excel:
- ❌ `prior_qualification` — имеющаяся квалификация (колонка I)
- ❌ `workplace` — место работы (колонка J)
- ❌ Информация о форме собственности организации

**Рекомендация:** Добавить эти поля при упрощении модели на Этапе 2.

### 4. Белорусские названия

В Excel есть белорусские варианты:
- ФИО сотрудника
- Названия месяцев в датах
- Названия организации и профессии

**Рекомендация:**
- Для ФИО: хранить отдельное поле `full_name_by` в модели Employee
- Для дат: использовать функцию `_format_date_by()` из маппинга
- Для организации/профессии: использовать поля `name_by` из справочников

---

## Следующие шаги (Этап 2)

1. **Упрощение моделей:**
   - Удалить избыточные модели (TrainingProgramSection, TrainingProgramEntry, и др.)
   - Добавить недостающие поля в ProductionTraining
   - Создать миграцию с переносом данных

2. **Тестирование маппинга:**
   - Создать тестовые данные
   - Проверить генерацию VML-замен
   - Протестировать все форматы дат

3. **Создание генераторов документов:**
   - Использовать `field_mapping.py` для заполнения шаблонов
   - Интеграция с `directory/utils/docx_vml.py`

---

## Файлы, созданные на этапе

```
utility_scripts/
├── extract_vml_fields.py           # Извлечение VML-полей из DOCX
├── analyze_learning_excel.py       # Анализ структуры Excel
├── analyze_excel_full.py           # Полный анализ Excel
├── vml_fields_report.txt           # Отчёт по VML-полям макет.docx
└── excel_vml_mapping.py            # Автогенерированный маппинг Excel→VML

production_training/document_templates/
├── __init__.py                     # Экспорт функций маппинга
└── field_mapping.py                # ПОЛНЫЙ маппинг VML→модель (278 строк)

docs/
├── PRODUCTION_TRAINING_SIMPLIFICATION_PLAN.md  # План упрощения (создан ранее)
└── PRODUCTION_TRAINING_STAGE1_REPORT.md        # Этот отчёт
```

---

## Статистика

- **VML-полей найдено:** 30
- **Динамических полей:** 11 (колонки K-U)
- **Статических полей:** 14 (организация, профессия, тип, разряд, подписант)
- **Технических дубликатов:** 5
- **Листов в Excel:** 13
- **Справочных листов:** 3
- **Строк кода маппинга:** 278
- **Вспомогательных функций:** 10

---

## Заключение

✅ **Этап 1 завершён успешно!**

Создана полная карта соответствия между:
- VML-полями в DOCX-шаблоне (30 полей)
- Данными в Excel (13 листов, 21 колонка)
- Полями модели ProductionTraining

Маппинг готов к использованию в генераторах документов на Этапе 3.

Все скрипты протестированы и работают корректно.

---

**Дата завершения:** 07.01.2026
**Ответственный:** Claude Sonnet 4.5
**Статус:** ✅ ЗАВЕРШЁН
