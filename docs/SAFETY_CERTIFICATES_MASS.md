# Массовая выдача удостоверений по ОТ (periodic-protocol)

## Назначение
Функция формирует удостоверения по охране труда на странице периодического протокола:
`/directory/documents/periodic-protocol/`.
Результат — один `docx` на организацию/подразделение/отдел либо `zip` при группировке по подразделениям.

## Кнопки и поведение
Кнопки расположены в строке **Признак** для каждой строки дерева:
- Организация: две кнопки `Протокол` и `Удостоверения`.
- Подразделение: две кнопки `Протокол` и `Удостоверения`.
- Отдел: две кнопки `Протокол` и `Удостоверения`.

При нажатии кнопки в строке формируется документ **только для выбранного узла**:
- Организация → все сотрудники организации, попадающие в фильтр страницы.
- Подразделение → все сотрудники подразделения.
- Отдел → все сотрудники отдела.

Кнопки общего уровня вверху страницы:
- `Протокол` (по отмеченным сотрудникам).
- `Протокол по подразделениям` (zip).
- `Удостоверения` (на всю организацию).
- `Удостоверения по подразделениям` (zip).

## Источник данных
Контекст формируется из карточки сотрудника и комиссии:
- ФИО в дательном падеже.
- Должность (именительный).
- Инициалы председателя комиссии.
- Наименование подразделения/организации в родительном падеже (если есть комиссия).

Используются функции:
- `prepare_employee_context` (базовые данные сотрудника).
- `find_appropriate_commission`, `get_commission_members_formatted`.

## Шаблон удостоверения
Базовый шаблон:  
`/home/django/webapps/potby/media/document_templates/etalon/udostoverenie_final.docx`

Структура:
- На **каждой странице** размещено **4 удостоверения**.
- **1-я страница** — лицевая сторона.
- **2-я страница** — оборотная сторона.
- Для двухсторонней печати страницы идут парами.

Если сотрудников меньше 4 — лишние строки в таблицах удаляются.

## Алгоритм генерации
Файл генератора:  
`directory/document_generators/certificate_generator.py`

1) Сотрудники разбиваются на группы по 4.  
2) Для каждой группы:
   - Шаблон `udostoverenie_final.docx` рендерится через `docxtpl` с массивом `employees`.
   - Если сотрудников меньше 4 — лишние строки в таблицах удаляются (и на лицевой, и на оборотной стороне).
3) Все группы объединяются в один docx через `docxcompose.Composer`.

### Заполняемые поля
Для каждой записи `employees[i]`:
- `fio_dative`
- `position_nominative`
- `chairman_name_initials`
- `binding_or_org_genitive`
- `organization_name`
- `workplace`

Поле `binding_or_org_genitive` выбирается так:
- Если комиссия привязана к отделу/подразделению — берется это название в родительном падеже.
- Иначе берется название организации в родительном падеже.

Поле `workplace`:
- Отдел (если есть).
- Иначе подразделение.

## Где подключено
Представление:  
`directory/views/documents/protocol.py` → `PeriodicProtocolView.post`

Обрабатывает:
- `scope_protocol` / `scope_certificates` — для кнопок в строках.
- `certificates_org` / `certificates_by_subdivision` — для кнопок наверху.

## Формат выдачи
- При обычной генерации: `docx`.
- При «по подразделениям»: `zip` с отдельными `docx`.

## Проверка, если скачивание не начинается
1) JS отменил отправку формы:
   - Если нажата верхняя кнопка — нужны отмеченные сотрудники.
   - Для кнопок в строках (организация/подразделение/отдел) галочки **не требуются**.

2) Генератор вернул `None`:
   - Шаблон не найден или некорректен.
   - Ошибка рендера docx (смотреть `django.log`).

3) Ответ вернулся не как файл:
   - Проверить в `Network` → `Response` (в браузере) — не HTML ли это.

## Логи и диагностика
Логирование ошибок: `django.log`.
Ищите сообщение:
- `Ошибка формирования удостоверений`
- `Шаблон удостоверений не найден`
- `Шаблон удостоверений должен содержать две таблицы`

## Контрольные точки
- Шаблон существует и доступен для чтения.
- В шаблоне **две таблицы** (лицевая/оборотная).
- В каждой таблице ровно **4 строки** с заполнителями.
- В представлении возвращается `HttpResponse` с content-type docx.
