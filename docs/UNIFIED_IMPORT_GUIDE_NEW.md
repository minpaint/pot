``# Единый импорт справочников (админка)

Черновик видения единого экрана импорта через Django Admin. Цель — связать существующие `Resource` классы и их предпросмотр, не дублируя логику импорта, и дать один маршрут для загрузки многостраничного Excel.

## 1. Принципы
- Используем `django-import-export` + `tablib`, без pandas.
- Переиспользуем текущие ресурсы: `OrganizationStructureResource`, `EmployeeResource`, `EquipmentResource`, `SIZNormResource` и др.
- Предпросмотр обязателен: `dry_run=True` + транзакция, без реальных записей в БД.
- Импорт атомарный на файл: если критический лист (структура) падает, остальные не коммитятся.
- Один экран в админке, права как у разделов Position/Employee/Equipment (ограничение по организациям профиля).

## 2. Структура Excel
- Имя листа → ресурс (минимальный набор):
  - `Структура` → `OrganizationStructureResource`
  - `Сотрудники` → `EmployeeResource`
  - `СИЗ нормы` → `SIZNormResource` (опционально)
  - `Оборудование` → `deadline_control.resources.EquipmentResource`
- Порядок обработки: `Структура`, `Сотрудники`, `СИЗ нормы`, `Оборудование`.
- Колонки каждого листа — как в `IMPORT_EXPORT.md` и самих ресурсах. Для сотрудников используем `full_name_nominative` и `hire_date`, а не `last_name/first_name/patronymic`.

## 3. UI (админка)
- Размещение: пункт меню в корне админки "Единый импорт" (доступ по правам на модели).
- Шаги:
  1. Форма загрузки: выбор файла (`.xlsx/.xls`), выбор организации-ограничения (select).
  2. Кнопка "Предпросмотр".
  3. Экран предпросмотра:
     - Сводка по файлу: размер, найденные листы, выбранная организация (или "без ограничений").
     - Таблица по листам: статус (`ok/warn/error`), количество строк, количество ошибок, список первых N ошибок.
     - Для листов, которых нет в файле, показываем "не найден" (не ошибка).
     - Кнопка "Импортировать" активна только если критические листы без ошибок.
  4. После импорта: флеш-статусы + таблица итогов (создано/обновлено/ошибок по листам).
- UX мелочи:
  - Прогресс/спиннер на время чтения/предпросмотра/импорта.
  - Кнопка "Скачать лог" (JSON/CSV) с ошибками предпросмотра/импорта.
  - Ограничение размера файла (см. раздел 5) с дружелюбной подсказкой.
  - Подсветка ошибок по строкам с номерами строк файла.

## 4. Оркестратор
- Разместить сервис `directory/services/global_import.py` с функциями:
  - `parse_workbook(file)` → словарь `sheet_name -> Dataset` с валидацией имён листов.
  - `dry_run(datasets, organization=None)` → прогон ресурсов с `dry_run=True` и сбор ошибок, без побочных эффектов.
  - `commit(datasets, organization=None)` → `transaction.atomic()`; прогон ресурсов в порядке, сбор статистики; при ошибке критического листа откат всей транзакции.
- Словарь ресурсов:
  ```python
  RESOURCE_MAPPING = {
      'Структура': OrganizationStructureResource,
      'Сотрудники': EmployeeResource,
      'СИЗ нормы': SIZNormResource,
      'Оборудование': EquipmentResource,
  }
  CRITICAL_SHEETS = {'Структура'}
  PROCESSING_ORDER = ['Структура', 'Сотрудники', 'СИЗ нормы', 'Оборудование']
  ```
- В ресурсы добавить безопасное поведение в `dry_run`: не создавать объекты в `before_import_row`. Если невозможно — оборачивать `dry_run` в `transaction.atomic()` с откатом.

## 5. Валидация перед импортом
- Файл: расширение (xlsx/xls), размер (лимит 10 МБ по умолчанию, настраиваемый), не пустой.
- Листы: наличие хотя бы одного поддерживаемого листа; неизвестные листы игнорируются с предупреждением.
- Колонки: проверка обязательных полей листа на основе `Resource.fields`; отсутствие — ошибка листа.
- Типы: базовая проверка дат/булевых (через виджеты ресурсов) — ошибки попадают в предпросмотр.
- Организация-ограничение:
  - Если выбрана, строки с другой организацией — ошибка листа.
  - Если поле пусто в строке — подставляем выбранную организацию.
  - При отсутствии ограничения — поведение ресурсов без изменений (создание/поиск по `org_short_name_ru`).

## 6. Отчёт и UX ошибок
- Для каждого листа: статус (`ok/warn/error`), количество успешных строк, количество ошибок, список ошибок вида `строка -> сообщение`.
- Общий статус файла: `готов к импорту` только если все критические листы без ошибок.
- При импорте — флеш-сообщения в админке + ссылка на логи (при необходимости).

## 7. Безопасность и права
- Доступ: пользователи с правами на модели Position/Employee/Equipment/SIZNorm (или superuser).
- Организационные ограничения: при наличии `profile.organizations` — жёсткая проверка, что импортируемые данные принадлежат доступным организациям.
- Аудит: логируем пользователя, время, имя файла, размер, хэштег с итогами по листам (created/updated/errors), сохраняем последние N логов в БД/файл.
- Защита от повторной отправки: csrf + блокировка кнопки на время выполнения.

## 8. Тесты
- Unit-тесты для сервисного слоя `global_import`: успешный кейс, отсутствие листа, ошибки в критическом листе, подмена организации.
- Интеграционные тесты админки: загрузка файла → предпросмотр → импорт.
- Моки для ресурсов, чтобы не трогать реальные модели при dry-run в тестах.

## 9. План внедрения (минимальный)
1) Добавить сервис `global_import.py` с оркестратором и валидацией листов.  
2) Исправить `Resource` классы, чтобы в `dry_run` не создавать объекты (или оборачивать в транзакцию).  
3) Админ-View + URL + шаблон предпросмотра/импорта (единый стиль с текущими import_preview).  
4) Документация: обновить `IMPORT_EXPORT.md` (ссылку на новый экран) и поддерживать этот файл.  
5) Логи аудита + лимиты размера/времени обработки.  
6) Тесты (юнит + интеграция админки).

## 10. Нерешённые вопросы
- Нужно ли допускать несколько организаций в одном файле при включённом ограничении? Если нет — жёсткая проверка и ошибка.
- Нужен ли лимит строк/листов для защиты от OOM? Предлагаю валидацию размера и, при необходимости, chunk-импорт.
- Добавлять ли другие справочники (квизы, вредные факторы) на первый релиз? Предлагаю начать с 4 листов выше и расширять по запросу.
