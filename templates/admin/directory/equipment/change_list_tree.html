{# templates/admin/directory/equipment/change_list_tree.html #}
{% extends "admin/change_list.html" %}
{% load static admin_urls %}

{% block content %}
<div id="content-main">
  <div class="object-tools">
    <a href="{% url 'admin:directory_equipment_add' %}" class="addlink">
      Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
    </a>
    <a href="{% url 'admin:directory_equipment_import' %}" class="addlink" style="background-position: 0 -96px;">
      ğŸ“¥ Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚
    </a>
    <a href="{% url 'admin:directory_equipment_export' %}" class="addlink" style="background-position: 0 -96px;">
      ğŸ“¤ Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚
    </a>
    <a href="{% url 'admin:global_import' %}" class="addlink" style="background-position: 0 -96px; background-color: #28a745; color: white;">
      ğŸ“Š Ğ•Ğ´Ğ¸Ğ½Ñ‹Ğ¹ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚/ÑĞºÑĞ¿Ğ¾Ñ€Ñ‚
    </a>
  </div>
  <form id="changelist-form" method="post"
        {% if cl.formset and cl.formset.is_multipart %}enctype="multipart/form-data"{% endif %}
        novalidate>
    {% csrf_token %}
    {% if action_form and actions_on_top and cl.show_admin_actions %}
      <div class="actions">
        {% for field in action_form %}
          {% if field.label %}<label>{{ field.label }}</label>{% endif %}
          {{ field }}
        {% endfor %}
        <button type="submit" class="button">Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ</button>
        <span class="action-counter" style="display: none;">0 Ğ¸Ğ· {{ cl.result_count }} Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ¾</span>
      </div>
    {% endif %}
    <div class="tree-controls">
      <button type="button" class="tree-btn expand-all">â†“ Ğ Ğ°Ğ·Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒ Ğ²ÑĞµ</button>
      <button type="button" class="tree-btn collapse-all">â†‘ Ğ¡Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒ Ğ²ÑĞµ</button>
      <div class="tree-search-container">
        <input type="text" class="tree-search" placeholder="ğŸ” ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ´ĞµÑ€ĞµĞ²Ñƒâ€¦">
      </div>
    </div>
    <div class="results">
      <table id="result_list" class="table table-bordered">
        <thead>
          <tr>
            <th></th>
            <th>ĞĞ°Ğ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ</th>
            <th>Ğ¡Ğ»ĞµĞ´. Ğ¢Ğ</th>
            <th>Ğ”Ğ½ĞµĞ¹ Ğ´Ğ¾ Ğ¢Ğ</th>
            <th>ĞŸÑ€Ğ¾Ğ²ĞµÑÑ‚Ğ¸ Ğ¢Ğ</th>
            <th>Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ</th>
          </tr>
        </thead>
        <tbody>
          {% for org, org_data in tree.items %}
            {# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ĞÑ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
            <tr class="tree-row" data-level="0" data-node-id="org_{{ org.id }}">
              <td></td>
              <td>
                <button class="toggle-btn" data-state="expanded">[-]</button>
                <span class="tree-icon">{{ tree_settings.icons.organization }}</span>
                <strong>{{ org_data.name }}</strong>
              </td>
              <td></td><td></td><td></td><td></td>
            </tr>
            {# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ±ĞµĞ· Ğ¿Ğ¾Ğ´Ñ€Ğ°Ğ·Ğ´ĞµĞ»ĞµĞ½Ğ¸Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
            {% for item in org_data.items %}
              <tr class="tree-row {% if item.maintenance_state == 'overdue' %}overdue-row{% elif item.maintenance_state == 'warning' %}warning-row{% endif %}" data-level="1" data-parent-id="org_{{ org.id }}">
                <td>
                  <input type="checkbox" name="_selected_action" value="{{ item.object.pk }}">
                </td>
                <td>
                  <span class="tree-icon">{{ tree_settings.icons.item }}</span>
                  <a href="{% url 'admin:directory_equipment_change' item.object.pk %}">
                    {{ item.name }}
                  </a>
                </td>
                <td class="date-cell {{ item.maintenance_state }}">{{ item.next_maintenance_date|default:"â€”" }}</td>
                <td class="days-cell {{ item.maintenance_state }}">{{ item.days_to_maintenance|default:"â€”" }}</td>
                <td>
                  <input type="date" name="maintenance_date_{{ item.object.pk }}"
                         value="{{ item.next_maintenance_date|date:'Y-m-d' }}" style="width: auto;">
                  <button type="submit" name="perform_maintenance" value="{{ item.object.pk }}"
                          class="button btn-sm btn-success">Ğ¢Ğ</button>
                </td>
                <td>
                  <a href="{% url 'admin:directory_equipment_change' item.object.pk %}" class="edit-link">âœï¸</a>
                  <a href="{% url 'admin:directory_equipment_delete' item.object.pk %}" class="delete-link">ğŸ—‘ï¸</a>
                </td>
              </tr>
            {% endfor %}
            {# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ĞŸĞ¾Ğ´Ñ€Ğ°Ğ·Ğ´ĞµĞ»ĞµĞ½Ğ¸Ñ Ğ¸ Ğ¸Ñ… Ğ¾Ğ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
            {% for sub, sub_data in org_data.subdivisions.items %}
              <tr class="tree-row" data-level="1" data-parent-id="org_{{ org.id }}" data-node-id="sub_{{ sub.id }}">
                <td></td>
                <td>
                  <button class="toggle-btn" data-state="expanded">[-]</button>
                  <span class="tree-icon">{{ tree_settings.icons.subdivision }}</span>
                  {{ sub_data.name }}
                </td>
                <td></td><td></td><td></td><td></td>
              </tr>
              {% for item in sub_data.items %}
                <tr class="tree-row {% if item.maintenance_state == 'overdue' %}overdue-row{% elif item.maintenance_state == 'warning' %}warning-row{% endif %}" data-level="2" data-parent-id="sub_{{ sub.id }}">
                  <td><input type="checkbox" name="_selected_action" value="{{ item.object.pk }}"></td>
                  <td>
                    <span class="tree-icon">{{ tree_settings.icons.item }}</span>
                    <a href="{% url 'admin:directory_equipment_change' item.object.pk %}">
                      {{ item.name }}
                    </a>
                  </td>
                  <td class="date-cell {{ item.maintenance_state }}">{{ item.next_maintenance_date|default:"â€”" }}</td>
                  <td class="days-cell {{ item.maintenance_state }}">{{ item.days_to_maintenance|default:"â€”" }}</td>
                  <td>
                    <input type="date" name="maintenance_date_{{ item.object.pk }}"
                           value="{{ item.next_maintenance_date|date:'Y-m-d' }}" style="width: auto;">
                    <button type="submit" name="perform_maintenance" value="{{ item.object.pk }}"
                            class="button btn-sm btn-success">Ğ¢Ğ</button>
                  </td>
                  <td>
                    <a href="{% url 'admin:directory_equipment_change' item.object.pk %}" class="edit-link">âœï¸</a>
                    <a href="{% url 'admin:directory_equipment_delete' item.object.pk %}" class="delete-link">ğŸ—‘ï¸</a>
                  </td>
                </tr>
              {% endfor %}
              {# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ĞÑ‚Ğ´ĞµĞ»Ñ‹ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ Ğ¿Ğ¾Ğ´Ñ€Ğ°Ğ·Ğ´ĞµĞ»ĞµĞ½Ğ¸Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
              {% for dept, dept_data in sub_data.departments.items %}
                <tr class="tree-row" data-level="2" data-parent-id="sub_{{ sub.id }}" data-node-id="dept_{{ dept.id }}">
                  <td></td>
                  <td>
                    <button class="toggle-btn" data-state="expanded">[-]</button>
                    <span class="tree-icon">{{ tree_settings.icons.department }}</span>
                    {{ dept_data.name }}
                  </td>
                  <td></td><td></td><td></td><td></td>
                </tr>
                {% for item in dept_data.items %}
                  <tr class="tree-row {% if item.maintenance_state == 'overdue' %}overdue-row{% elif item.maintenance_state == 'warning' %}warning-row{% endif %}" data-level="3" data-parent-id="dept_{{ dept.id }}">
                    <td><input type="checkbox" name="_selected_action" value="{{ item.object.pk }}"></td>
                    <td>
                      <span class="tree-icon">{{ tree_settings.icons.item }}</span>
                      <a href="{% url 'admin:directory_equipment_change' item.object.pk %}">
                        {{ item.name }}
                      </a>
                    </td>
                    <td class="date-cell {{ item.maintenance_state }}">{{ item.next_maintenance_date|default:"â€”" }}</td>
                    <td class="days-cell {{ item.maintenance_state }}">{{ item.days_to_maintenance|default:"â€”" }}</td>
                    <td>
                      <input type="date" name="maintenance_date_{{ item.object.pk }}"
                             value="{{ item.next_maintenance_date|date:'Y-m-d' }}" style="width: auto;">
                      <button type="submit" name="perform_maintenance" value="{{ item.object.pk }}"
                              class="button btn-sm btn-success">Ğ¢Ğ</button>
                    </td>
                    <td>
                      <a href="{% url 'admin:directory_equipment_change' item.object.pk %}" class="edit-link">âœï¸</a>
                      <a href="{% url 'admin:directory_equipment_delete' item.object.pk %}" class="delete-link">ğŸ—‘ï¸</a>
                    </td>
                  </tr>
                {% endfor %}
              {% endfor %}
            {% endfor %}
          {% endfor %}
        </tbody>
      </table>
    </div>
  </form>
</div>
{% endblock %}

{% block extrahead %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'admin/css/tree_view.css' %}">
  <script src="{% static 'admin/js/tree_view.js' %}"></script>
  <script src="{% static 'admin/js/tree_search.js' %}"></script>
{% endblock %}