{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extrahead %}
{{ block.super }}
{{ formset.media }}
<style>
    .formset-row {
        background-color: #f9f9f9;
        padding: 15px;
        margin-bottom: 10px;
        border-left: 3px solid #417690;
        border-radius: 4px;
    }
    .formset-row:hover {
        background-color: #f0f0f0;
    }
    .delete-row {
        color: #ba2121;
        cursor: pointer;
        font-weight: bold;
    }
    .add-row {
        background-color: #417690;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 10px;
    }
    .add-row:hover {
        background-color: #2d5468;
    }
    .form-row {
        margin-bottom: 15px;
    }
    .form-row label {
        display: block;
        font-weight: bold;
        margin-bottom: 5px;
    }
    .help {
        background-color: #e7f3ff;
        padding: 15px;
        border-left: 4px solid #2196F3;
        margin: 20px 0;
    }
    .remove-row {
        background-color: #ba2121;
        color: white;
        border: none;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        cursor: pointer;
        font-size: 14px;
        line-height: 1;
    }
    .remove-row:hover {
        background-color: #9a1b1b;
    }
</style>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">–ì–ª–∞–≤–Ω–∞—è</a>
    &rsaquo; <a href="{% url 'admin:app_list' app_label='deadline_control' %}">–ö–æ–Ω—Ç—Ä–æ–ª—å —Å—Ä–æ–∫–æ–≤</a>
    &rsaquo; <a href="{% url 'admin:deadline_control_medicalexaminationnorm_changelist' %}">–ù–æ—Ä–º—ã –º–µ–¥–æ—Å–º–æ—Ç—Ä–æ–≤</a>
    &rsaquo; {{ title }}
</div>
{% endblock %}

{% block content %}
<div class="module">
    <h1>üìã {{ title }}</h1>

    <div class="help">
        <h3>‚ÑπÔ∏è –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</h3>
        <ol>
            <li>–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏—é (–¥–æ–ª–∂–Ω–æ—Å—Ç—å) –∏–∑ —Å–ø–∏—Å–∫–∞</li>
            <li>–î–æ–±–∞–≤—å—Ç–µ –æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–¥–Ω—ã—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤</li>
            <li>–ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –ø–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–∫—Ç–æ—Ä–∞</li>
            <li>–ù–∞–∂–º–∏—Ç–µ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ—Ä–º</li>
        </ol>
    </div>

    <form method="post">
        {% csrf_token %}

        <!-- –§–æ—Ä–º–∞ –≤—ã–±–æ—Ä–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏ -->
        <fieldset class="module aligned">
            <h2>1. –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏—é (–¥–æ–ª–∂–Ω–æ—Å—Ç—å)</h2>
            <div class="form-row">
                {{ position_form.position_name.errors }}
                <div>
                    <label for="{{ position_form.position_name.id_for_label }}" class="required">
                        {{ position_form.position_name.label }}:
                    </label>
                    {{ position_form.position_name }}
                    {% if position_form.position_name.help_text %}
                    <p class="help">{{ position_form.position_name.help_text }}</p>
                    {% endif %}
                </div>
            </div>
        </fieldset>

        <!-- Formset —Å –≤—Ä–µ–¥–Ω—ã–º–∏ —Ñ–∞–∫—Ç–æ—Ä–∞–º–∏ -->
        <fieldset class="module aligned">
            <h2>2. –î–æ–±–∞–≤—å—Ç–µ –≤—Ä–µ–¥–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã</h2>

            {{ formset.management_form }}
            {{ formset.non_form_errors }}

            <div id="formset-container">
                {% for form in formset %}
                <div class="formset-row" data-form-index="{{ forloop.counter0 }}">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin-top: 0;">–í—Ä–µ–¥–Ω—ã–π —Ñ–∞–∫—Ç–æ—Ä #{{ forloop.counter }}</h3>
                        <button type="button" class="remove-row" onclick="removeForm(this)" title="–£–¥–∞–ª–∏—Ç—å —Ñ–∞–∫—Ç–æ—Ä">‚úñ</button>
                    </div>

                    {{ form.non_field_errors }}

                    <div class="form-row">
                        {{ form.harmful_factor.errors }}
                        <label for="{{ form.harmful_factor.id_for_label }}" class="required">
                            {{ form.harmful_factor.label }}:
                        </label>
                        {{ form.harmful_factor }}
                    </div>

                    <div class="form-row">
                        {{ form.periodicity_override.errors }}
                        <label for="{{ form.periodicity_override.id_for_label }}">
                            {{ form.periodicity_override.label }}:
                        </label>
                        {{ form.periodicity_override }}
                        <p class="help">{{ form.periodicity_override.widget.attrs.placeholder }}</p>
                    </div>

                    <div class="form-row">
                        {{ form.notes.errors }}
                        <label for="{{ form.notes.id_for_label }}">
                            {{ form.notes.label }}:
                        </label>
                        {{ form.notes }}
                    </div>

                    {% if formset.can_delete %}
                    <div class="form-row" style="display: none;">
                        {{ form.DELETE }}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>

            <!-- –°–∫—Ä—ã—Ç—ã–π —à–∞–±–ª–æ–Ω –ø—É—Å—Ç–æ–π —Ñ–æ—Ä–º—ã –¥–ª—è –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
            <div id="empty-form-template" style="display: none;">
                <div class="formset-row" data-form-index="__prefix__">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin-top: 0;">–í—Ä–µ–¥–Ω—ã–π —Ñ–∞–∫—Ç–æ—Ä #<span class="form-number"></span></h3>
                        <button type="button" class="remove-row" onclick="removeForm(this)" title="–£–¥–∞–ª–∏—Ç—å —Ñ–∞–∫—Ç–æ—Ä">‚úñ</button>
                    </div>

                    {{ formset.empty_form.non_field_errors }}

                    <div class="form-row">
                        {{ formset.empty_form.harmful_factor.errors }}
                        <label for="{{ formset.empty_form.harmful_factor.id_for_label }}" class="required">
                            {{ formset.empty_form.harmful_factor.label }}:
                        </label>
                        {{ formset.empty_form.harmful_factor }}
                    </div>

                    <div class="form-row">
                        {{ formset.empty_form.periodicity_override.errors }}
                        <label for="{{ formset.empty_form.periodicity_override.id_for_label }}">
                            {{ formset.empty_form.periodicity_override.label }}:
                        </label>
                        {{ formset.empty_form.periodicity_override }}
                        <p class="help">{{ formset.empty_form.periodicity_override.widget.attrs.placeholder }}</p>
                    </div>

                    <div class="form-row">
                        {{ formset.empty_form.notes.errors }}
                        <label for="{{ formset.empty_form.notes.id_for_label }}">
                            {{ formset.empty_form.notes.label }}:
                        </label>
                        {{ formset.empty_form.notes }}
                    </div>

                    {% if formset.can_delete %}
                    <div class="form-row" style="display: none;">
                        {{ formset.empty_form.DELETE }}
                    </div>
                    {% endif %}
                </div>
            </div>

            <button type="button" class="add-row" onclick="addForm()">
                ‚ûï –î–æ–±–∞–≤–∏—Ç—å –µ—â—ë –æ–¥–∏–Ω –≤—Ä–µ–¥–Ω—ã–π —Ñ–∞–∫—Ç–æ—Ä
            </button>
        </fieldset>

        <div class="submit-row">
            <input type="submit" value="üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å" class="default">
            <a href="{% url 'admin:deadline_control_medicalexaminationnorm_changelist' %}" class="button cancel-link">–û—Ç–º–µ–Ω–∞</a>
        </div>
    </form>
</div>

<script>
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π —Ñ–æ—Ä–º—ã –≤ formset
    function addForm() {
        console.log('üîß –§—É–Ω–∫—Ü–∏—è addForm() –≤—ã–∑–≤–∞–Ω–∞');

        const container = document.getElementById('formset-container');
        const totalForms = document.getElementById('id_form-TOTAL_FORMS');
        const template = document.getElementById('empty-form-template');
        const currentFormCount = parseInt(totalForms.value);

        console.log('üìä Current form count:', currentFormCount);
        console.log('üìã Template found:', template);

        if (!template) {
            alert('–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω —à–∞–±–ª–æ–Ω —Ñ–æ—Ä–º—ã');
            console.error('‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω —à–∞–±–ª–æ–Ω —Ñ–æ—Ä–º—ã');
            return;
        }

        // –ö–ª–æ–Ω–∏—Ä—É–µ–º –≤–µ—Å—å template div
        console.log('üîÑ –ù–∞—á–∏–Ω–∞—é –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º—ã –∏–∑ —à–∞–±–ª–æ–Ω–∞...');
        const templateClone = template.cloneNode(true);
        // –ë–µ—Ä–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π div.formset-row
        const newForm = templateClone.querySelector('.formset-row');
        console.log('‚úÖ –§–æ—Ä–º–∞ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∞ –∏–∑ —à–∞–±–ª–æ–Ω–∞');

        // –ó–∞–º–µ–Ω—è–µ–º __prefix__ –Ω–∞ —Ç–µ–∫—É—â–∏–π –∏–Ω–¥–µ–∫—Å
        console.log('üîç –ó–∞–º–µ–Ω—è—é __prefix__ ‚Üí form-' + currentFormCount);
        newForm.innerHTML = newForm.innerHTML.replace(/__prefix__/g, 'form-' + currentFormCount);
        console.log('‚úÖ –ò–Ω–¥–µ–∫—Å—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã');

        // –û–±–Ω–æ–≤–ª—è–µ–º data-form-index
        newForm.setAttribute('data-form-index', currentFormCount);

        // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–æ–º–µ—Ä –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
        const formNumber = newForm.querySelector('.form-number');
        if (formNumber) {
            formNumber.textContent = currentFormCount + 1;
            console.log('‚úÖ –ù–æ–º–µ—Ä —Ñ–æ—Ä–º—ã –æ–±–Ω–æ–≤–ª–µ–Ω:', currentFormCount + 1);
        }

        // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        console.log('‚ûï –î–æ–±–∞–≤–ª—è—é —Ñ–æ—Ä–º—É –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä...');
        container.appendChild(newForm);
        console.log('‚úÖ –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ DOM');

        // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫ —Ñ–æ—Ä–º
        totalForms.value = currentFormCount + 1;
        console.log('‚úÖ –°—á—ë—Ç—á–∏–∫ —Ñ–æ—Ä–º –æ–±–Ω–æ–≤–ª–µ–Ω:', totalForms.value);

        // –û–±–Ω–æ–≤–ª—è–µ–º –Ω—É–º–µ—Ä–∞—Ü–∏—é
        console.log('üî¢ –û–±–Ω–æ–≤–ª—è—é –Ω—É–º–µ—Ä–∞—Ü–∏—é...');
        updateFormNumbers();
        console.log('‚úÖ –ù—É–º–µ—Ä–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞');

        console.log('üéâ –§—É–Ω–∫—Ü–∏—è addForm() –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ');
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ñ–æ—Ä–º—ã
    function removeForm(button) {
        const container = document.getElementById('formset-container');
        const formRow = button.closest('.formset-row');
        const totalForms = document.getElementById('id_form-TOTAL_FORMS');

        // –ù–µ —É–¥–∞–ª—è–µ–º, –µ—Å–ª–∏ –æ—Å—Ç–∞–ª–∞—Å—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ —Ñ–æ—Ä–º–∞
        if (container.querySelectorAll('.formset-row').length <= 1) {
            alert('–î–æ–ª–∂–µ–Ω –æ—Å—Ç–∞—Ç—å—Å—è —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤—Ä–µ–¥–Ω—ã–π —Ñ–∞–∫—Ç–æ—Ä');
            return;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ DELETE —á–µ–∫–±–æ–∫—Å (–¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–æ—Ä–º)
        const deleteCheckbox = formRow.querySelector('input[type="checkbox"][name$="-DELETE"]');
        if (deleteCheckbox) {
            // –≠—Ç–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Ñ–æ—Ä–º–∞ - –ø–æ–º–µ—á–∞–µ–º –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ –∏ —Å–∫—Ä—ã–≤–∞–µ–º
            deleteCheckbox.checked = true;
            formRow.style.display = 'none';
        } else {
            // –≠—Ç–æ –Ω–æ–≤–∞—è —Ñ–æ—Ä–º–∞ - –ø—Ä–æ—Å—Ç–æ —É–¥–∞–ª—è–µ–º –∏–∑ DOM
            formRow.remove();
            // –£–º–µ–Ω—å—à–∞–µ–º —Å—á—ë—Ç—á–∏–∫ —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö —Ñ–æ—Ä–º
            totalForms.value = parseInt(totalForms.value) - 1;
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –Ω—É–º–µ—Ä–∞—Ü–∏—é –≤–∏–¥–∏–º—ã—Ö —Ñ–æ—Ä–º
        updateFormNumbers();
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω—É–º–µ—Ä–∞—Ü–∏–∏ —Ñ–æ—Ä–º
    function updateFormNumbers() {
        const container = document.getElementById('formset-container');
        const visibleForms = container.querySelectorAll('.formset-row:not([style*="display: none"])');

        visibleForms.forEach((form, index) => {
            const header = form.querySelector('h3');
            if (header) {
                header.textContent = '–í—Ä–µ–¥–Ω—ã–π —Ñ–∞–∫—Ç–æ—Ä #' + (index + 1);
            }
        });
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üìã –°—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤—Ä–µ–¥–Ω—ã—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
        const addButton = document.querySelector('.add-row');
        const container = document.getElementById('formset-container');
        const totalForms = document.getElementById('id_form-TOTAL_FORMS');

        console.log('–ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è:', addButton);
        console.log('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ñ–æ—Ä–º:', container);
        console.log('Total forms:', totalForms ? totalForms.value : '–Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
        console.log('–§–æ—Ä–º –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ:', container ? container.querySelectorAll('.formset-row').length : 0);

        if (!addButton) {
            console.error('‚ùå –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
        }
        if (!container) {
            console.error('‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ñ–æ—Ä–º –Ω–µ –Ω–∞–π–¥–µ–Ω!');
        }
        if (!totalForms) {
            console.error('‚ùå –ü–æ–ª–µ TOTAL_FORMS –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!');
        }
    });
</script>
{% endblock %}
