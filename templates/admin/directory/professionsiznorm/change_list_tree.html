{% extends "admin/change_list.html" %}
{#
    –®–∞–±–ª–æ–Ω –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥—Ä–µ–≤–æ–≤–∏–¥–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ —ç—Ç–∞–ª–æ–Ω–Ω—ã—Ö –Ω–æ—Ä–º –°–ò–ó –ø—Ä–æ—Ñ–µ—Å—Å–∏–π.
    –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞: –ø—Ä–æ—Ñ–µ—Å—Å–∏—è ‚Üí –≥—Ä—É–ø–ø—ã –Ω–æ—Ä–º ‚Üí —Å–∞–º–∏ –Ω–æ—Ä–º—ã.
    –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —ç—Ç–∞–ª–æ–Ω–Ω—ã–µ –Ω–æ—Ä–º—ã –¥–ª—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–π (–Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –¥–æ–ª–∂–Ω–æ—Å—Ç—è–º).
#}

{% load static %}

{% block content %}
<div id="content-main">
    <div class="object-tools">
        <a href="{% url 'admin:directory_professionsiznorm_add' %}" class="addlink">
            –î–æ–±–∞–≤–∏—Ç—å —ç—Ç–∞–ª–æ–Ω–Ω—É—é –Ω–æ—Ä–º—É –°–ò–ó
        </a>
        <a href="{% url 'admin:directory_siz_add' %}" class="addlink">
            –î–æ–±–∞–≤–∏—Ç—å –°–ò–ó
        </a>
        <a href="{% url 'admin:directory_professionsiznorm_import' %}" class="addlink" style="background-position: 0 -96px;">
            –ò–º–ø–æ—Ä—Ç —ç—Ç–∞–ª–æ–Ω–Ω—ã—Ö –Ω–æ—Ä–º
        </a>
    </div>

    <form id="changelist-form" method="post"
        {% if cl.formset and cl.formset.is_multipart %} enctype="multipart/form-data"{% endif %}
        novalidate>
        {% csrf_token %}
        {% if action_form and actions_on_top and cl.show_admin_actions %}
        <div class="actions">
            {% for field in action_form %}
                {% if field.label %}<label>{{ field.label }}</label>{% endif %}
                {{ field }}
            {% endfor %}
            <button type="submit" class="button" title="–í—ã–ø–æ–ª–Ω–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ">–í—ã–ø–æ–ª–Ω–∏—Ç—å</button>
            <span class="action-counter" style="display: none;">0 –∏–∑ {{ cl.result_count }} –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö</span>
        </div>
        {% endif %}

        <div class="tree-controls">
            <button type="button" class="tree-btn expand-all">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ</button>
            <button type="button" class="tree-btn collapse-all">–°–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ</button>
            <div class="tree-search-container">
                <input type="text" class="tree-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—é –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏...">
            </div>
        </div>

        <div class="results">
            <table id="result_list">
                <thead>
                    <tr>
                        <th class="column-checkbox"><input type="checkbox" id="select-all"></th>
                        <th class="column-name">–ü—Ä–æ—Ñ–µ—Å—Å–∏—è</th>
                        <th class="column-roles">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ—Å—Ç–µ–π</th>
                        <th class="column-actions">–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                {% for profession in professions %}
                    <tr class="tree-row" data-level="0" data-node-id="profession_{{ forloop.counter }}">
                        <td class="field-checkbox">
                            <input type="checkbox" class="profession-checkbox"
                                   data-profession-id="profession_{{ forloop.counter }}"
                                   title="–í—ã–¥–µ–ª–∏—Ç—å –≤—Å–µ –Ω–æ—Ä–º—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏">
                        </td>
                        <td class="field-name">
                            <button type="button" class="toggle-btn" data-state="expanded">[-]</button>
                            <span class="tree-icon">üìñ</span>
                            <strong>{{ profession.name }}</strong>
                        </td>
                        <td class="field-roles">{{ profession.positions_count }} –¥–æ–ª–∂–Ω–æ—Å—Ç–µ–π</td>
                        <td class="field-actions">
                            <a href="{% url 'admin:directory_professionsiznorm_add' %}?profession_name={{ profession.name|urlencode }}"
                               class="add-link" title="–î–æ–±–∞–≤–∏—Ç—å —ç—Ç–∞–ª–æ–Ω–Ω—É—é –Ω–æ—Ä–º—É –°–ò–ó">+</a>
                        </td>
                    </tr>

                    {% if profession.base_norms or profession.group_norms %}
                    {# –ï–¥–∏–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è –≤—Å–µ—Ö —ç—Ç–∞–ª–æ–Ω–Ω—ã—Ö –Ω–æ—Ä–º –°–ò–ó –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏ #}
                    <tr class="tree-row" data-level="1" data-parent-id="profession_{{ forloop.counter }}">
                        <td colspan="4" style="padding:0">
                            <table class="table table-bordered table-striped" style="width:100%">
                                <thead>
                                    <tr>
                                        <th style="width: 30px;"></th>
                                        <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–π –∑–∞—â–∏—Ç—ã</th>
                                        <th>–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è (–º–∞—Ä–∫–∏—Ä–æ–≤–∫–∞)</th>
                                        <th>–ï–¥. –∏–∑–º.</th>
                                        <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                                        <th>–°—Ä–æ–∫ –Ω–æ—Å–∫–∏</th>
                                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if profession.base_norms %}
                                        {# –ë–∞–∑–æ–≤—ã–µ –Ω–æ—Ä–º—ã (–±–µ–∑ —É—Å–ª–æ–≤–∏–π) #}
                                        {% for norm in profession.base_norms %}
                                        <tr class="norm-row" data-profession-id="profession_{{ forloop.parentloop.counter }}">
                                            <td>
                                                <input type="checkbox" name="_selected_action" value="{{ norm.id }}"
                                                       class="action-select norm-checkbox"
                                                       data-profession-id="profession_{{ forloop.parentloop.counter }}">
                                            </td>
                                            <td>{{ norm.siz.name }}</td>
                                            <td>{{ norm.siz.classification }}</td>
                                            <td>{{ norm.siz.unit }}</td>
                                            <td>{{ norm.quantity }}</td>
                                            <td>{% if norm.siz.wear_period == 0 %}{% if norm.siz.wear_type %}{{ norm.siz.wear_type }}{% else %}–î–æ –∏–∑–Ω–æ—Å–∞{% endif %}{% else %}{{ norm.siz.wear_period }} –º–µ—Å.{% endif %}</td>
                                            <td>
                                                <a href="{% url 'admin:directory_professionsiznorm_change' norm.id %}" class="edit-link">–ò–∑–º–µ–Ω–∏—Ç—å</a>
                                                <a href="{% url 'admin:directory_professionsiznorm_delete' norm.id %}" class="delete-link">–£–¥–∞–ª–∏—Ç—å</a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    {% endif %}

                                    {# –ù–æ—Ä–º—ã –ø–æ —É—Å–ª–æ–≤–∏—è–º #}
                                    {% for group in profession.group_norms %}
                                        {# –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É—Å–ª–æ–≤–∏—è #}
                                        <tr class="condition-header">
                                            <td colspan="7" class="condition-name">
                                                <span class="tree-icon">‚öô</span>
                                                <strong>{{ group.name }}</strong>
                                            </td>
                                        </tr>
                                        {# –ù–æ—Ä–º—ã –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ —É—Å–ª–æ–≤–∏—è #}
                                        {% for norm in group.norms %}
                                        <tr class="norm-row" data-profession-id="profession_{{ forloop.parentloop.parentloop.counter }}">
                                            <td>
                                                <input type="checkbox" name="_selected_action" value="{{ norm.id }}"
                                                       class="action-select norm-checkbox"
                                                       data-profession-id="profession_{{ forloop.parentloop.parentloop.counter }}">
                                            </td>
                                            <td>{{ norm.siz.name }}</td>
                                            <td>{{ norm.siz.classification }}</td>
                                            <td>{{ norm.siz.unit }}</td>
                                            <td>{{ norm.quantity }}</td>
                                            <td>{% if norm.siz.wear_period == 0 %}{% if norm.siz.wear_type %}{{ norm.siz.wear_type }}{% else %}–î–æ –∏–∑–Ω–æ—Å–∞{% endif %}{% else %}{{ norm.siz.wear_period }} –º–µ—Å.{% endif %}</td>
                                            <td>
                                                <a href="{% url 'admin:directory_professionsiznorm_change' norm.id %}" class="edit-link">–ò–∑–º–µ–Ω–∏—Ç—å</a>
                                                <a href="{% url 'admin:directory_professionsiznorm_delete' norm.id %}" class="delete-link">–£–¥–∞–ª–∏—Ç—å</a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    {% endfor %}
                                </tbody>
                            </table>
                        </td>
                    </tr>
                    {% endif %}
                {% endfor %}
                </tbody>
            </table>
        </div>
    </form>
</div>

<style>
    .condition-header {
        background-color: #f8f9fa !important;
    }
    .condition-name {
        padding: 8px !important;
        font-weight: bold;
        color: #0d6efd;
    }
    .tree-icon {
        margin-right: 5px;
    }
</style>

{% endblock %}

{% block extrahead %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'admin/css/tree_view.css' %}">
    <script src="{% static 'admin/js/tree_view.js' %}"></script>
    <script src="{% static 'admin/js/tree_search.js' %}"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —á–µ–∫–±–æ–∫—Å–æ–≤ –ø—Ä–æ—Ñ–µ—Å—Å–∏–π
        const professionCheckboxes = document.querySelectorAll('.profession-checkbox');

        professionCheckboxes.forEach(function(professionCheckbox) {
            professionCheckbox.addEventListener('change', function() {
                const professionId = this.getAttribute('data-profession-id');
                const isChecked = this.checked;

                // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —á–µ–∫–±–æ–∫—Å—ã –Ω–æ—Ä–º —ç—Ç–æ–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏
                const normCheckboxes = document.querySelectorAll(
                    '.norm-checkbox[data-profession-id="' + professionId + '"]'
                );

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—Å–µ—Ö —á–µ–∫–±–æ–∫—Å–æ–≤ –Ω–æ—Ä–º
                normCheckboxes.forEach(function(checkbox) {
                    checkbox.checked = isChecked;
                });

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
                updateActionCounter();
            });
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —á–µ–∫–±–æ–∫—Å–æ–≤ –Ω–æ—Ä–º
        const normCheckboxes = document.querySelectorAll('.norm-checkbox');
        normCheckboxes.forEach(function(checkbox) {
            checkbox.addEventListener('change', function() {
                updateActionCounter();

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏
                const professionId = this.getAttribute('data-profession-id');
                const allNormCheckboxes = document.querySelectorAll(
                    '.norm-checkbox[data-profession-id="' + professionId + '"]'
                );
                const professionCheckbox = document.querySelector(
                    '.profession-checkbox[data-profession-id="' + professionId + '"]'
                );

                if (professionCheckbox) {
                    // –ï—Å–ª–∏ –≤—Å–µ –Ω–æ—Ä–º—ã –≤—ã–±—Ä–∞–Ω—ã - —Å—Ç–∞–≤–∏–º –≥–∞–ª–æ—á–∫—É —É –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏
                    const allChecked = Array.from(allNormCheckboxes).every(cb => cb.checked);
                    const noneChecked = Array.from(allNormCheckboxes).every(cb => !cb.checked);

                    if (allChecked) {
                        professionCheckbox.checked = true;
                        professionCheckbox.indeterminate = false;
                    } else if (noneChecked) {
                        professionCheckbox.checked = false;
                        professionCheckbox.indeterminate = false;
                    } else {
                        professionCheckbox.checked = false;
                        professionCheckbox.indeterminate = true;
                    }
                }
            });
        });

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        function updateActionCounter() {
            const counter = document.querySelector('.action-counter');
            if (counter) {
                const checkedCount = document.querySelectorAll('.norm-checkbox:checked').length;
                const totalCount = document.querySelectorAll('.norm-checkbox').length;

                if (checkedCount > 0) {
                    counter.textContent = checkedCount + ' –∏–∑ ' + totalCount + ' –≤—ã–±—Ä–∞–Ω–æ';
                    counter.style.display = '';
                } else {
                    counter.style.display = 'none';
                }
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ"
        const selectAllCheckbox = document.getElementById('select-all');
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function() {
                const isChecked = this.checked;

                // –í—ã–±–∏—Ä–∞–µ–º –≤—Å–µ —á–µ–∫–±–æ–∫—Å—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–π
                professionCheckboxes.forEach(function(cb) {
                    cb.checked = isChecked;
                    cb.dispatchEvent(new Event('change'));
                });
            });
        }
    });
    </script>
{% endblock %}
