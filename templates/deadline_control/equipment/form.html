{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block title %}{% if object %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ{% else %}–î–æ–±–∞–≤–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ{% endif %}{% endblock %}

{% block extra_css %}
    {{ form.media.css }}
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>{% if object %}‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ{% else %}‚ûï –î–æ–±–∞–≤–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ{% endif %}</h2>

    <form method="post" class="mt-4" id="equipment-form">
        {% csrf_token %}
        {{ form|crispy }}

        <div class="mt-3">
            <button type="submit" class="btn btn-primary">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <a href="{% url 'deadline_control:equipment:list' %}" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
    {# –ü–æ–¥–∫–ª—é—á–∞–µ–º JavaScript –º–µ–¥–∏–∞-—Ñ–∞–π–ª—ã –¥–ª—è autocomplete –≤–∏–¥–∂–µ—Ç–æ–≤ #}
    {{ form.media.js }}

    {# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç –¥–∞—Ç—ã —Å–ª–µ–¥—É—é—â–µ–≥–æ –¢–û #}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // –§–æ–ª–ª–±–µ–∫-–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è select2/dal, –µ—Å–ª–∏ –ø–æ –∫–∞–∫–æ–π-—Ç–æ –ø—Ä–∏—á–∏–Ω–µ –Ω–µ –ø–æ–¥–Ω—è–ª–∏—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        if (window.jQuery && typeof jQuery.fn.select2 === 'function') {
            jQuery('.select2-basic').each(function() {
                const $el = jQuery(this);
                if (!$el.hasClass('select2-hidden-accessible')) {
                    $el.select2({ width: '100%' });
                }
            });
        }

        const equipmentTypeField = document.getElementById('id_equipment_type');
        const lastMaintenanceField = document.getElementById('id_last_maintenance_date');
        const maintenancePeriodField = document.getElementById('id_maintenance_period_months');
        const nextMaintenanceField = document.getElementById('id_next_maintenance_date');
        const loadCapacityField = document.getElementById('id_load_capacity_kg');
        const loadCapacityRow = document.getElementById('div_id_load_capacity_kg');

        function toggleLoadCapacity(typeName) {
            if (!loadCapacityRow || !loadCapacityField) {
                return;
            }
            if (typeName === '–ì—Ä—É–∑–æ–≤–∞—è —Ç–µ–ª–µ–∂–∫–∞') {
                loadCapacityRow.style.display = '';
                if (!loadCapacityField.value) {
                    loadCapacityField.value = '2500';
                }
            } else {
                loadCapacityRow.style.display = 'none';
                loadCapacityField.value = '';
            }
        }

        // ========== –ê–í–¢–û–ü–û–î–°–¢–ê–ù–û–í–ö–ê –ü–ï–†–ò–û–î–ò–ß–ù–û–°–¢–ò –¢–û –ü–†–ò –í–´–ë–û–†–ï –¢–ò–ü–ê ==========
        if (equipmentTypeField) {
            equipmentTypeField.addEventListener('change', function() {
                const typeId = this.value;

                if (typeId) {
                    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Ç–∏–ø–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ API
                    fetch(`/deadline-control/equipment/type/${typeId}/api/`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å –¢–û
                                maintenancePeriodField.value = data.default_maintenance_period_months;

                                // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–∞—Ç—É —Å–ª–µ–¥—É—é—â–µ–≥–æ –¢–û
                                calculateNextMaintenanceDate();
                                toggleLoadCapacity(data.name);
                            }
                        })
                        .catch(error => {
                            console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ —Ç–∏–ø–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è:', error);
                        });
                }
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ—Å—è—Ü–µ–≤ –∫ –¥–∞—Ç–µ (–∫–∞–∫ –≤ Python –º–æ–¥–µ–ª–∏)
        function addMonths(date, months) {
            const result = new Date(date);
            const targetMonth = result.getMonth() + months;
            const targetYear = result.getFullYear() + Math.floor(targetMonth / 12);
            const adjustedMonth = targetMonth % 12;

            result.setFullYear(targetYear);
            result.setMonth(adjustedMonth);

            // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –¥–µ–Ω—å, –µ—Å–ª–∏ –æ–Ω –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –ø—Ä–µ–¥–µ–ª—ã –º–µ—Å—è—Ü–∞
            const lastDayOfMonth = new Date(targetYear, adjustedMonth + 1, 0).getDate();
            if (result.getDate() > lastDayOfMonth) {
                result.setDate(lastDayOfMonth);
            }

            return result;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–ª–µ–¥—É—é—â–µ–π –¥–∞—Ç—ã –¢–û
        function calculateNextMaintenanceDate() {
            if (!lastMaintenanceField || !maintenancePeriodField || !nextMaintenanceField) {
                return;
            }

            const lastDate = lastMaintenanceField.value;
            const periodMonths = parseInt(maintenancePeriodField.value);

            if (lastDate && periodMonths > 0) {
                const lastMaintenanceDate = new Date(lastDate);
                const nextDate = addMonths(lastMaintenanceDate, periodMonths);

                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –≤ YYYY-MM-DD
                const year = nextDate.getFullYear();
                const month = String(nextDate.getMonth() + 1).padStart(2, '0');
                const day = String(nextDate.getDate()).padStart(2, '0');
                nextMaintenanceField.value = `${year}-${month}-${day}`;
            } else {
                nextMaintenanceField.value = '';
            }
        }

        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞—Ç—ã –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¢–û –∏–ª–∏ –ø–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç–∏
        if (lastMaintenanceField && maintenancePeriodField) {
            lastMaintenanceField.addEventListener('change', calculateNextMaintenanceDate);
            maintenancePeriodField.addEventListener('change', calculateNextMaintenanceDate);
            maintenancePeriodField.addEventListener('input', calculateNextMaintenanceDate);

            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
            calculateNextMaintenanceDate();
        }

        if (equipmentTypeField) {
            const selectedOption = equipmentTypeField.options[equipmentTypeField.selectedIndex];
            const initialName = selectedOption ? selectedOption.text.trim() : '';
            toggleLoadCapacity(initialName);
        }
    });
    </script>
{% endblock %}
