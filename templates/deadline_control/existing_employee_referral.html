{% extends "base.html" %}
{% load static %}

{% block title %}üè• –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –º–µ–¥–æ—Å–º–æ—Ç—Ä - {{ employee.full_name_nominative }}{% endblock %}

{% block extra_css %}
<style>
    .referral-card {
        max-width: 900px;
        margin: 0 auto;
        background: #fff;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .factors-list {
        list-style: none;
        padding: 0;
    }
    .factors-list li {
        padding: 10px;
        background: #e9ecef;
        margin-bottom: 5px;
        border-radius: 3px;
        display: flex;
        align-items: center;
    }
    .factors-list li::before {
        content: "‚ö†Ô∏è";
        margin-right: 10px;
    }
    .alert-info {
        background-color: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
    }
    .form-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 5px;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="referral-card">
        <h2>üè• –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –º–µ–¥–æ—Å–º–æ—Ç—Ä</h2>
        <p class="text-muted mb-4">–í—ã–¥–∞—á–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É</p>

        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}

        <div class="alert alert-info">
            <strong>‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong> –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –ø–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è. –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å - –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –∏—Ö –Ω–∏–∂–µ. –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –∫–∞—Ä—Ç–æ—á–∫–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞.
        </div>

        <form id="referralForm">
            {% csrf_token %}

            <div class="form-section">
                <h5 class="mb-3">–î–∞–Ω–Ω—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</h5>

                <!-- –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è -->
                <div class="mb-3">
                    <label for="organization" class="form-label">
                        <i class="fas fa-building"></i> –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è
                    </label>
                    <input type="text" class="form-control" id="organization"
                           value="{{ employee.organization.short_name_ru }}" readonly>
                    <div class="form-text">–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∞ —á–µ—Ä–µ–∑ —ç—Ç—É —Ñ–æ—Ä–º—É</div>
                </div>

                <!-- –§–ò–û -->
                <div class="mb-3">
                    <label for="fullName" class="form-label">
                        <i class="fas fa-user"></i> –§–ò–û <span class="text-danger">*</span>
                    </label>
                    <input type="text" class="form-control" id="fullName"
                           value="{{ employee.full_name_nominative }}" required>
                    <div class="form-text">–ú–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å, –µ—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∞ –≤ –Ω–∞–ø–∏—Å–∞–Ω–∏–∏</div>
                </div>

                <!-- –ü—Ä–æ—Ñ–µ—Å—Å–∏—è (–¥–æ–ª–∂–Ω–æ—Å—Ç—å) -->
                <div class="mb-3">
                    <label for="position" class="form-label">
                        <i class="fas fa-briefcase"></i> –ü—Ä–æ—Ñ–µ—Å—Å–∏—è (–¥–æ–ª–∂–Ω–æ—Å—Ç—å)
                    </label>
                    <input type="text" class="form-control" id="position"
                           value="{{ employee.position.position_name }}" readonly>
                    <div class="form-text">–î–æ–ª–∂–Ω–æ—Å—Ç—å –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∞ —á–µ—Ä–µ–∑ —ç—Ç—É —Ñ–æ—Ä–º—É</div>
                </div>

                <!-- –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è -->
                <div class="mb-3">
                    <label for="birthDate" class="form-label">
                        <i class="fas fa-calendar-alt"></i> –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è <span class="text-danger">*</span>
                    </label>
                    <input type="date" class="form-control" id="birthDate"
                           value="{{ employee.date_of_birth|date:'Y-m-d' }}" required>
                    <div class="form-text">–ï—Å–ª–∏ –¥–∞—Ç–∞ –Ω–µ–≤–µ—Ä–Ω–∞ - –∏—Å–ø—Ä–∞–≤—å—Ç–µ, –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –∫–∞—Ä—Ç–æ—á–∫–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</div>
                </div>

                <!-- –ú–µ—Å—Ç–æ –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è -->
                <div class="mb-3">
                    <label for="address" class="form-label">
                        <i class="fas fa-home"></i> –ú–µ—Å—Ç–æ –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è <span class="text-danger">*</span>
                    </label>
                    <textarea class="form-control" id="address" rows="2" required
                              placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è">{{ employee.place_of_residence }}</textarea>
                    <div class="form-text">–ï—Å–ª–∏ –∞–¥—Ä–µ—Å –∏–∑–º–µ–Ω–∏–ª—Å—è - –æ–±–Ω–æ–≤–∏—Ç–µ, –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –∫–∞—Ä—Ç–æ—á–∫–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</div>
                </div>
            </div>

            <!-- –í—Ä–µ–¥–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã -->
            {% if harmful_factors %}
            <div class="form-section">
                <h5 class="mb-3">
                    <i class="fas fa-exclamation-triangle text-warning"></i> –í—Ä–µ–¥–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã ({{ harmful_factors|length }})
                </h5>
                <ul class="factors-list">
                    {% for factor in harmful_factors %}
                    <li>
                        <strong>{{ factor.short_name }}</strong> - {{ factor.full_name }}
                        <small class="text-muted ms-2">(–ø–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å: {{ factor.periodicity }} –º–µ—Å.)</small>
                    </li>
                    {% endfor %}
                </ul>
                <div class="form-text">–≠—Ç–∏ –≤—Ä–µ–¥–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã –±—É–¥—É—Ç —É–∫–∞–∑–∞–Ω—ã –≤ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏</div>
            </div>
            {% else %}
            <div class="alert alert-warning">
                <strong>‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ:</strong> –î–ª—è –¥–∞–Ω–Ω–æ–π –¥–æ–ª–∂–Ω–æ—Å—Ç–∏ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤—Ä–µ–¥–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã. –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω–æ.
            </div>
            {% endif %}

            <!-- –ö–Ω–æ–ø–∫–∏ -->
            <div class="d-flex justify-content-between mt-4">
                <a href="{% url 'deadline_control:medical:list' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É
                </a>
                {% if harmful_factors %}
                <button type="submit" id="generateReferralBtn" class="btn btn-primary">
                    <i class="fas fa-file-medical"></i> –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                </button>
                {% endif %}
            </div>

            <div id="loading" class="alert alert-info mt-3" style="display: none;">
                <i class="fas fa-spinner fa-spin"></i> –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è...
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('referralForm');
    const generateBtn = document.getElementById('generateReferralBtn');
    const loading = document.getElementById('loading');

    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();

            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            const birthDate = document.getElementById('birthDate').value;
            const address = document.getElementById('address').value.trim();
            const fullName = document.getElementById('fullName').value.trim();

            if (!birthDate) {
                alert('‚ùå –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è');
                return;
            }

            if (!address) {
                alert('‚ùå –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –º–µ—Å—Ç–æ –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è');
                return;
            }

            if (!fullName) {
                alert('‚ùå –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –§–ò–û');
                return;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            loading.style.display = 'block';
            generateBtn.disabled = true;

            // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            const data = {
                employee_id: {{ employee.id }},
                full_name: fullName,
                birth_date: birthDate,
                address: address
            };

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            fetch('{% url "deadline_control:medical:referral_generate" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.document_url) {
                        // –°–∫–∞—á–∏–≤–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç
                        window.location.href = data.document_url;
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                        alert('‚úÖ –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ –∏ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!\n\n' +
                              'üìù –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –∫–∞—Ä—Ç–æ—á–∫–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞.');
                        // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –æ–±—Ä–∞—Ç–Ω–æ –∫ —Å–ø–∏—Å–∫—É
                        setTimeout(() => {
                            window.location.href = '{% url "deadline_control:medical:list" %}';
                        }, 1500);
                    } else {
                        alert('‚ö†Ô∏è –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ, –Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —à–∞–±–ª–æ–Ω–∞.');
                        loading.style.display = 'none';
                        generateBtn.disabled = false;
                    }
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    loading.style.display = 'none';
                    generateBtn.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è: ' + error);
                loading.style.display = 'none';
                generateBtn.disabled = false;
            });
        });
    }
});
</script>
{% endblock %}
