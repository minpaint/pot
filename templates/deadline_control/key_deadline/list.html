{% extends "base.html" %}

{% block title %}üìÖ –ö–ª—é—á–µ–≤—ã–µ —Å—Ä–æ–∫–∏{% endblock %}

{% block extra_css %}
<style>
@media (max-width: 767px) {
    /* –ú–æ–±–∏–ª—å–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏: –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ + –°—Ç–∞—Ç—É—Å */
    .key-deadline-table thead {
        display: none;
    }

    .key-deadline-table tbody tr {
        display: block;
        background: #fff;
        border: 1px solid #dee2e6;
        border-radius: 12px;
        padding: 0.75rem 0.75rem 0.35rem;
        margin-bottom: 0.75rem;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
    }

    .key-deadline-table td {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
        padding: 0.35rem 0 0.2rem;
        font-size: 0.95rem;
        line-height: 1.35;
        word-break: break-word;
        overflow-wrap: anywhere;
    }

    /* –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å—Ç–æ–ª–±—Ü—ã, –∫—Ä–æ–º–µ –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è (1) –∏ –°—Ç–∞—Ç—É—Å–∞ (5) */
    .key-deadline-table td:not(:nth-child(1)):not(:nth-child(5)) {
        display: none;
    }

    /* –ü–æ–¥–ø–∏—Å–∏ –∫–æ–ª–æ–Ω–æ–∫ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞ –º–æ–±–∏–ª–∫–∞—Ö */
    .key-deadline-table td::before {
        content: none;
    }

    .key-deadline-table .name-cell {
        flex: 1;
    }

    .key-deadline-table .status-cell {
        justify-content: flex-end;
        min-width: 90px;
        text-align: right;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-3">
        <div class="col-md-12">
            <h2>üìÖ –ö–ª—é—á–µ–≤—ã–µ —Å—Ä–æ–∫–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</h2>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-12">
            <a href="{% url 'deadline_control:key_deadline:category_create' %}" class="btn btn-primary">
                ‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é
            </a>
            <a href="{% url 'deadline_control:key_deadline:item_create' %}" class="btn btn-success">
                ‚ûï –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ
            </a>
        </div>
    </div>

    {% if items_by_organization %}
        {% for organization, categories_with_items in items_by_organization %}
        <!-- –ë–ª–æ–∫ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ -->
        <div class="card mb-4 border-primary">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">üè¢ {{ organization.short_name_ru|default:organization.full_name_ru }}</h4>
            </div>
            <div class="card-body">
                {% for category, items in categories_with_items %}
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center bg-light">
                        <h5 class="mb-0">üìã {{ category.name }}</h5>
                    </div>
                    <div class="card-body">
                        {% if items %}
                        <table class="table table-sm key-deadline-table">
                            <thead>
                                <tr>
                                    <th>–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</th>
                                    <th>–ü–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å</th>
                                    <th>–¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞</th>
                                    <th>–°–ª–µ–¥—É—é—â–∞—è –¥–∞—Ç–∞</th>
                                    <th>–°—Ç–∞—Ç—É—Å</th>
                                    <th>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in items %}
                                <tr {% if item.is_overdue %}class="table-danger"{% elif item.is_upcoming %}class="table-warning"{% endif %}>
                                    <td class="name-cell" data-label="–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ">{{ item.name }}</td>
                                    <td data-label="–ü–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å">
                                        {% if item.periodicity_months %}
                                            {{ item.periodicity_months }} –º–µ—Å.
                                        {% else %}
                                            {{ item.category.periodicity_months }} –º–µ—Å.
                                        {% endif %}
                                    </td>
                                    <td data-label="–¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞">{{ item.current_date|date:"d.m.Y" }}</td>
                                    <td data-label="–°–ª–µ–¥—É—é—â–∞—è –¥–∞—Ç–∞">{{ item.next_date|date:"d.m.Y"|default:"-" }}</td>
                                    <td class="status-cell" data-label="–°—Ç–∞—Ç—É—Å">
                                        {% if item.is_overdue %}
                                            <span class="badge bg-danger">üö® –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ –Ω–∞ {{ item.days_overdue }} –¥–Ω.</span>
                                        {% elif item.is_upcoming %}
                                            <span class="badge bg-warning text-dark">‚è∞ –û—Å—Ç–∞–ª–æ—Å—å {{ item.days_until_next }} –¥–Ω.</span>
                                        {% else %}
                                            <span class="badge bg-success">‚úÖ –í –Ω–æ—Ä–º–µ</span>
                                        {% endif %}
                                    </td>
                                    <td data-label="–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π">{{ item.responsible_person|default:"-" }}</td>
                                    <td data-label="–î–µ–π—Å—Ç–≤–∏—è">
                                        <a href="{% url 'deadline_control:key_deadline:item_update' item.pk %}" class="btn btn-sm btn-info">‚úèÔ∏è</a>
                                        <a href="{% url 'deadline_control:key_deadline:item_delete' item.pk %}" class="btn btn-sm btn-danger">üóëÔ∏è</a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% else %}
                        <p class="text-muted">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</p>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    {% else %}
    <div class="alert alert-info">
        –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π. <a href="{% url 'deadline_control:key_deadline:item_create' %}">–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</a>
    </div>
    {% endif %}
</div>
{% endblock %}
