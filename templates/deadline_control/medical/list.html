{% extends "base.html" %}
{% load static %}
{% load medical_filters %}

{% block title %}üè• –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –æ—Å–º–æ—Ç—Ä—ã{% endblock %}

{% block extra_css %}
<style>
    .fab-container {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        z-index: 1050;
    }
    .fab-container .btn {
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        min-width: 250px;
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
    @media (max-width: 768px) {
        .fab-container {
            bottom: 1rem;
            right: 1rem;
            left: 1rem;
        }
        .fab-container .btn {
            width: 100%;
            min-width: auto;
        }

        /* –°–∫—Ä—ã–≤–∞–µ–º –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –Ω–∞ –º–∞–ª—ã—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
        .table th:nth-child(3),
        .table td:nth-child(3),
        .table th:nth-child(4),
        .table td:nth-child(4) {
            display: none;
        }

        /* –£–º–µ–Ω—å—à–∞–µ–º —Ä–∞–∑–º–µ—Ä –∫–Ω–æ–ø–æ–∫ */
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
    }

    @media (max-width: 576px) {
        /* –ù–∞ –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω–æ–µ */
        .table th:nth-child(5),
        .table td:nth-child(5),
        .table th:nth-child(6),
        .table td:nth-child(6) {
            display: none;
        }
    }

    /* –£–ª—É—á—à–∞–µ–º —á–∏—Ç–∞–µ–º–æ—Å—Ç—å badge */
    .badge {
        margin: 2px;
        display: inline-block;
    }
</style>
{% endblock %}


{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-3">
        <div class="col-md-12">
            <h2>üè• –ö–æ–Ω—Ç—Ä–æ–ª—å —Å—Ä–æ–∫–æ–≤ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –æ—Å–º–æ—Ç—Ä–æ–≤</h2>
            <p>–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–Ω–æ–≥–æ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤, —á—Ç–æ–±—ã –≤–Ω–µ—Å—Ç–∏ –¥–∞—Ç—É –º–µ–¥–æ—Å–º–æ—Ç—Ä–∞.</p>
        </div>
    </div>

    <form id="massUpdateForm">
    {% csrf_token %}

    <!-- 1. –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ (–∫—Ä–∞—Å–Ω—ã–π) -->
    {% if overdue %}
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">üö® –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –º–µ–¥–æ—Å–º–æ—Ç—Ä—ã ({{ overdue|length }})</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th style="width: 3%;"><input type="checkbox" class="select-all-checkbox"></th>
                                    <th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
                                    <th>–î–æ–ª–∂–Ω–æ—Å—Ç—å</th>
                                    <th>–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</th>
                                    <th>–í—Ä–µ–¥–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã</th>
                                    <th>–î–µ–π—Å—Ç–≤—É—é—â–∏–π –ú–û</th>
                                    <th>–°–ª–µ–¥—É—é—â–∏–π –æ—Å–º–æ—Ç—Ä</th>
                                    <th>–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ –¥–Ω–µ–π</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for employee in overdue %}
                                <tr>
                                    <td><input type="checkbox" class="employee-checkbox" name="employee_ids" value="{{ employee.id }}"></td>
                                    <td><strong>{{ employee.full_name_nominative }}</strong></td>
                                    <td>{{ employee.position.position_name|default:"-" }}</td>
                                    <td>{{ employee.organization.short_name_ru }}</td>
                                    <td>
                                        {% for factor in employee.medical_status_info.factors %}
                                            <span class="badge bg-warning text-dark">{{ factor.short_name }}</span>
                                        {% endfor %}
                                    </td>
                                    <td>
                                        {{ employee.medical_status_info.date_completed|date:"d.m.Y"|default:"-" }}
                                        <button type="button" class="btn btn-sm btn-warning perform-exam-btn" data-employee-id="{{ employee.id }}" title="–ò–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—É" style="margin-left: 5px;">
                                            üìÖ
                                        </button>
                                    </td>
                                    <td>{{ employee.medical_status_info.next_date|date:"d.m.Y" }}</td>
                                    <td><span class="badge bg-danger">{{ employee.medical_status_info.days_until|abs_value }}</span></td>
                                    <td>
                                        <a href="{% url 'deadline_control:medical:referral_existing_employee' employee.id %}" class="btn btn-sm btn-primary">
                                            –í—ã–¥–∞—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- 2. –ë–µ–∑ –¥–∞—Ç—ã (—Å–µ—Ä—ã–π) -->
    {% if no_date %}
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card border-secondary">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">üìã –¢—Ä–µ–±—É–µ—Ç—Å—è –≤–Ω–µ—Å—Ç–∏ –¥–∞—Ç—É –º–µ–¥–æ—Å–º–æ—Ç—Ä–∞ ({{ no_date|length }})</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th style="width: 3%;"><input type="checkbox" class="select-all-checkbox"></th>
                                    <th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
                                    <th>–î–æ–ª–∂–Ω–æ—Å—Ç—å</th>
                                    <th>–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</th>
                                    <th>–í—Ä–µ–¥–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã</th>
                                    <th>–ü–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å (–º–∏–Ω.)</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for employee in no_date %}
                                <tr class="table-secondary">
                                    <td><input type="checkbox" class="employee-checkbox" name="employee_ids" value="{{ employee.id }}"></td>
                                    <td><strong>{{ employee.full_name_nominative }}</strong></td>
                                    <td>{{ employee.position.position_name|default:"-" }}</td>
                                    <td>{{ employee.organization.short_name_ru }}</td>
                                    <td>
                                        {% for factor in employee.medical_status_info.factors %}
                                            <span class="badge bg-info text-dark">{{ factor.short_name }}</span>
                                        {% endfor %}
                                    </td>
                                    <td>{{ employee.medical_status_info.min_periodicity }} –º–µ—Å.</td>
                                    <td>
                                        <a href="{% url 'deadline_control:medical:referral_existing_employee' employee.id %}" class="btn btn-sm btn-primary">
                                            –í—ã–¥–∞—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- 3. –ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ (–æ—Ä–∞–Ω–∂–µ–≤—ã–π) -->
    {% if upcoming %}
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">‚ö†Ô∏è –ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ –º–µ–¥–æ—Å–º–æ—Ç—Ä—ã ({{ upcoming|length }})</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th style="width: 3%;"><input type="checkbox" class="select-all-checkbox"></th>
                                    <th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
                                    <th>–î–æ–ª–∂–Ω–æ—Å—Ç—å</th>
                                    <th>–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</th>
                                    <th>–í—Ä–µ–¥–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã</th>
                                    <th>–î–µ–π—Å—Ç–≤—É—é—â–∏–π –ú–û</th>
                                    <th>–°–ª–µ–¥—É—é—â–∏–π –æ—Å–º–æ—Ç—Ä</th>
                                    <th>–û—Å—Ç–∞–ª–æ—Å—å –¥–Ω–µ–π</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for employee in upcoming %}
                                <tr>
                                    <td><input type="checkbox" class="employee-checkbox" name="employee_ids" value="{{ employee.id }}"></td>
                                    <td><strong>{{ employee.full_name_nominative }}</strong></td>
                                    <td>{{ employee.position.position_name|default:"-" }}</td>
                                    <td>{{ employee.organization.short_name_ru }}</td>
                                    <td>
                                        {% for factor in employee.medical_status_info.factors %}
                                            <span class="badge bg-warning text-dark">{{ factor.short_name }}</span>
                                        {% endfor %}
                                    </td>
                                    <td>
                                        {{ employee.medical_status_info.date_completed|date:"d.m.Y"|default:"-" }}
                                        <button type="button" class="btn btn-sm btn-info perform-exam-btn" data-employee-id="{{ employee.id }}" title="–ò–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—É" style="margin-left: 5px;">
                                            üìÖ
                                        </button>
                                    </td>
                                    <td>{{ employee.medical_status_info.next_date|date:"d.m.Y" }}</td>
                                    <td><span class="badge bg-warning text-dark">{{ employee.medical_status_info.days_until }}</span></td>
                                    <td>
                                        <a href="{% url 'deadline_control:medical:referral_existing_employee' employee.id %}" class="btn btn-sm btn-primary">
                                            –í—ã–¥–∞—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- 4. –ü–ª–∞–Ω–æ–≤—ã–µ (–∑–µ–ª–µ–Ω—ã–π) -->
    {% if normal %}
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">‚úÖ –ü–ª–∞–Ω–æ–≤—ã–µ –º–µ–¥–æ—Å–º–æ—Ç—Ä—ã ({{ normal|length }})</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0">
                            <thead>
                                <tr>
                                    <th style="width: 3%;"><input type="checkbox" class="select-all-checkbox"></th>
                                    <th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
                                    <th>–î–æ–ª–∂–Ω–æ—Å—Ç—å</th>
                                    <th>–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</th>
                                    <th>–í—Ä–µ–¥–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã</th>
                                    <th>–î–µ–π—Å—Ç–≤—É—é—â–∏–π –ú–û</th>
                                    <th>–°–ª–µ–¥—É—é—â–∏–π –æ—Å–º–æ—Ç—Ä</th>
                                    <th>–î–Ω–µ–π –¥–æ –æ—Å–º–æ—Ç—Ä–∞</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for employee in normal %}
                                <tr>
                                    <td><input type="checkbox" class="employee-checkbox" name="employee_ids" value="{{ employee.id }}"></td>
                                    <td>{{ employee.full_name_nominative }}</td>
                                    <td>{{ employee.position.position_name|default:"-" }}</td>
                                    <td>{{ employee.organization.short_name_ru }}</td>
                                    <td>
                                        {% for factor in employee.medical_status_info.factors %}
                                            <span class="badge bg-success">{{ factor.short_name }}</span>
                                        {% endfor %}
                                    </td>
                                    <td>
                                        {{ employee.medical_status_info.date_completed|date:"d.m.Y"|default:"-" }}
                                        <button type="button" class="btn btn-sm btn-secondary perform-exam-btn" data-employee-id="{{ employee.id }}" title="–ò–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—É" style="margin-left: 5px;">
                                            üìÖ
                                        </button>
                                    </td>
                                    <td>{{ employee.medical_status_info.next_date|date:"d.m.Y"|default:"-" }}</td>
                                    <td>
                                        {% if employee.medical_status_info.days_until is not None %}
                                            {{ employee.medical_status_info.days_until }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{% url 'deadline_control:medical:referral_existing_employee' employee.id %}" class="btn btn-sm btn-primary">
                                            –í—ã–¥–∞—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    </form>

    {% if not no_date and not overdue and not upcoming and not normal %}
    <div class="alert alert-info">
        –ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –æ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –æ—Å–º–æ—Ç—Ä–∞—Ö.
    </div>
    {% endif %}
</div>

<!-- –ü–ª–∞–≤–∞—é—â–∞—è –∫–Ω–æ–ø–∫–∞ -->
<div class="fab-container" id="fab-mass-update" style="display: none;">
    <button class="btn btn-lg btn-success" id="mass-update-btn">
        –í–Ω–µ—Å—Ç–∏ –¥–∞—Ç—É –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö (<span id="selected-count">0</span>)
    </button>
</div>


<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞—Ç—ã –º–µ–¥–æ—Å–º–æ—Ç—Ä–∞ -->
<div class="modal fade" id="performExamModal" tabindex="-1" aria-labelledby="performExamModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="performExamModalLabel">–ò–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—É –º–µ–¥–æ—Å–º–æ—Ç—Ä–∞</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="performExamForm" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="alert alert-info">
                        <strong>üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong> –£–∫–∞–∑–∞–Ω–Ω–∞—è –¥–∞—Ç–∞ –±—É–¥–µ—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –∫–æ –≤—Å–µ–º –º–µ–¥–æ—Å–º–æ—Ç—Ä–∞–º –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤. –°–ª–µ–¥—É—é—â–∞—è –¥–∞—Ç–∞ –±—É–¥–µ—Ç —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
                    </div>
                    <div class="mb-3">
                        <label for="examination_date" class="form-label">–î–∞—Ç–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –º–µ–¥–æ—Å–º–æ—Ç—Ä–∞</label>
                        <input type="date" class="form-control" id="examination_date" name="examination_date" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
try {
    console.log("Script start: DOMContentLoaded event fired.");

    document.addEventListener('DOMContentLoaded', function() {
        console.log("Inside DOMContentLoaded listener.");

        // --- –õ–æ–≥–∏–∫–∞ –¥–ª—è –æ–¥–∏–Ω–æ—á–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–æ—Å—Ç–∞–µ—Ç—Å—è) ---
        const performModalElement = document.getElementById('performExamModal');
        if (!performModalElement) console.error("Modal element #performExamModal not found!");

        const performModal = new bootstrap.Modal(performModalElement);
        const performForm = document.getElementById('performExamForm');
        const examinationDateInput = document.getElementById('examination_date');
        console.log("Modal and form elements initialized.");

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        const today = new Date().toISOString().split('T')[0];
        examinationDateInput.value = today;

        const singleUpdateButtons = document.querySelectorAll('.perform-exam-btn');
        console.log(`Found ${singleUpdateButtons.length} single update buttons.`);
        singleUpdateButtons.forEach(button => {
            button.addEventListener('click', function() {
                console.log("Single update button clicked.");
                const employeeId = this.dataset.employeeId;
                performForm.setAttribute('data-action-type', 'single');
                performForm.setAttribute('data-employee-id', employeeId);
                document.getElementById('performExamModalLabel').textContent = '–ò–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—É –º–µ–¥–æ—Å–º–æ—Ç—Ä–∞';
                performModal.show();
            });
        });


        // --- –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ---
        const fab = document.getElementById('fab-mass-update');
        if (!fab) console.error("Floating button #fab-mass-update not found!");

        const massUpdateBtn = document.getElementById('mass-update-btn');
        if (!massUpdateBtn) console.error("Mass update button #mass-update-btn not found!");

        const selectedCountSpan = document.getElementById('selected-count');
        if (!selectedCountSpan) console.error("Selected count span #selected-count not found!");

        const allCheckboxes = document.querySelectorAll('.employee-checkbox');
        console.log(`Found ${allCheckboxes.length} employee checkboxes.`);

        const selectAllCheckboxes = document.querySelectorAll('.select-all-checkbox');
        console.log(`Found ${selectAllCheckboxes.length} 'select all' checkboxes.`);


        function updateFabVisibility() {
            console.log("updateFabVisibility function called.");
            const selectedCheckboxes = document.querySelectorAll('.employee-checkbox:checked');
            const count = selectedCheckboxes.length;
            console.log(`Selected checkboxes count: ${count}`);
            selectedCountSpan.textContent = count;
            if (count > 0) {
                fab.style.display = 'block';
                console.log("FAB display set to 'block'");
            } else {
                fab.style.display = 'none';
                console.log("FAB display set to 'none'");
            }
        }

        allCheckboxes.forEach((checkbox, index) => {
            checkbox.addEventListener('change', updateFabVisibility);
            // console.log(`Attached 'change' listener to checkbox #${index}`);
        });

        selectAllCheckboxes.forEach((headerCheckbox, index) => {
            headerCheckbox.addEventListener('change', function() {
                console.log(`'Select all' checkbox #${index} changed.`);
                const table = this.closest('table');
                const rowCheckboxes = table.querySelectorAll('tbody .employee-checkbox');
                rowCheckboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
                updateFabVisibility();
            });
        });

        if (massUpdateBtn) {
            massUpdateBtn.addEventListener('click', function() {
                console.log("Mass update FAB clicked.");
                performForm.setAttribute('data-action-type', 'mass');
                performForm.removeAttribute('data-employee-id');
                const selectedCount = document.querySelectorAll('.employee-checkbox:checked').length;
                document.getElementById('performExamModalLabel').textContent = `–í–Ω–µ—Å—Ç–∏ –¥–∞—Ç—É –¥–ª—è ${selectedCount} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤`;
                performModal.show();
            });
        }


        // --- –û–±—â–∞—è –ª–æ–≥–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ ---
        if (performForm) {
            performForm.addEventListener('submit', function(e) {
                e.preventDefault();
                console.log("Perform form submitted.");

                const actionType = performForm.getAttribute('data-action-type');
                const date = examinationDateInput.value;
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                console.log(`Action type: ${actionType}, Date: ${date}`);

                let url;
                let body;
                const headers = {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken,
                };

                if (actionType === 'single') {
                    const employeeId = performForm.getAttribute('data-employee-id');
                    url = `/deadline-control/medical/employee/${employeeId}/update-examinations/`;
                    const formData = new FormData();
                    formData.append('examination_date', date);
                    body = formData;
                    // For FormData, browser sets Content-Type automatically. Do not set it manually.
                } else { // mass
                    url = `/deadline-control/medical/update-multiple/`;
                    const selectedIds = Array.from(document.querySelectorAll('.employee-checkbox:checked')).map(cb => cb.value);
                    body = JSON.stringify({
                        employee_ids: selectedIds,
                        examination_date: date
                    });
                    headers['Content-Type'] = 'application/json';
                    console.log(`Mass update for IDs: ${selectedIds.join(', ')}`);
                }

                fetch(url, {
                    method: 'POST',
                    headers: headers,
                    body: body
                })
                .then(response => response.json())
                .then(data => {
                    console.log("Received response from server:", data);
                    if (data.success) {
                        performModal.hide();
                        const updatedCount = data.updated_count || 1;
                        alert(`‚úÖ –î–∞—Ç–∞ –º–µ–¥–æ—Å–º–æ—Ç—Ä–∞ —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –∫ ${updatedCount} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º.`);
                        window.location.reload();
                    } else {
                        alert('‚ùå –û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –º–µ–¥–æ—Å–º–æ—Ç—Ä—ã.'));
                    }
                })
                .catch(error => {
                    console.error('Fetch Error:', error);
                    alert('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞.');
                });
            });
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ –∫–Ω–æ–ø–∫–µ
        document.querySelectorAll('.modal .btn-close, .modal [data-bs-dismiss="modal"]').forEach(el => {
            el.addEventListener('click', (e) => {
                e.preventDefault();
                console.log("Modal close button clicked.");
                performModal.hide();
            });
        });

        console.log("Script finished initialization.");
    });
} catch (e) {
    console.error("A critical error occurred in the script:", e);
    alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ (F12).");
}
</script>
{% endblock %}

