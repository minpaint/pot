{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }} - OT Online{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'admin/css/tree_view.css' %}">
<style>
    .ot-card-container { padding: 20px; }
    .page-header { margin-bottom: 20px; }
    .page-description { color: #666; font-size: 14px; margin-bottom: 15px; }

    /* –°–∏–Ω–∏–π –±–ª–æ–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–∞ */
    .date-input-section {
        background: #e7f3ff;
        border: 2px solid #0066cc;
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 20px;
    }
    .date-input-section label {
        font-weight: 600; font-size: 15px; color: #0066cc;
        display: block; margin-bottom: 8px;
    }
    .date-input-section input[type="date"] {
        padding: 8px 12px; border: 1px solid #ced4da;
        border-radius: 4px; font-size: 14px; width: 200px;
    }
    .date-input-section input[type="date"]:focus {
        outline: none; border-color: #0066cc;
        box-shadow: 0 0 0 0.2rem rgba(0,102,204,.25);
    }

    /* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
    .action-buttons {
        display: flex; gap: 10px; margin-bottom: 15px;
        flex-wrap: wrap; align-items: center;
    }
    .selected-info { color: #666; font-size: 14px; margin-left: auto; }

    /* –¢–∞–±–ª–∏—Ü–∞ –¥–µ—Ä–µ–≤–∞ */
    #result_list {
        width: 100%; background: white;
        border: 1px solid #ddd; border-radius: 4px;
        table-layout: fixed;
    }
    #result_list th {
        background: #f8f9fa; padding: 8px 6px;
        border-bottom: 2px solid #dee2e6;
        font-weight: 600; font-size: 13px;
        text-transform: uppercase; color: #495057;
    }
    #result_list td {
        padding: 4px 6px; border-bottom: 1px solid #f0f0f0;
        vertical-align: middle; overflow: hidden; text-overflow: ellipsis;
    }
    .tree-row:hover td { background-color: #f8f9fa; }

    .column-checkbox { width: 22px !important; text-align: center; padding: 2px 0 !important; }
    .column-name { }
    .column-position { width: 25%; }

    /* –ß–µ–∫–±–æ–∫—Å—ã */
    .form-check-input { cursor: pointer; }
    .column-checkbox .form-check-input {
        margin: 0;
        width: 16px;
        height: 16px;
    }
    .tree-row.selected { background-color: #e7f3ff; }

    /* –ò–∫–æ–Ω–∫–∏ */
    .tree-icon { margin-right: 4px; font-size: 14px; }

    /* –ö–Ω–æ–ø–∫–∏ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è */
    .toggle-btn {
        display: inline-block; margin-right: 4px;
        padding: 1px 5px; border: 1px solid #dee2e6;
        background: white; border-radius: 2px;
        cursor: pointer; font-size: 11px;
        font-family: monospace; transition: all 0.2s;
        min-width: 22px; text-align: center;
    }
    .toggle-btn:hover { background: #f8f9fa; border-color: #adb5bd; }

    /* –û—Ç—Å—Ç—É–ø—ã –¥–ª—è —É—Ä–æ–≤–Ω–µ–π */
    .tree-row[data-level="0"] .field-name { padding-left: 6px; font-weight: 600; }
    .tree-row[data-level="1"] .field-name { padding-left: 20px; font-weight: 500; }
    .tree-row[data-level="2"] .field-name { padding-left: 34px; }
    .tree-row[data-level="3"] .field-name { padding-left: 48px; }

    .tree-row-hidden { display: none !important; }
    .hidden-by-search { display: none !important; }
    .highlight-search td { background-color: #fff3cd !important; }

    /* –ö–æ–Ω—Ç—Ä–æ–ª—ã –¥–µ—Ä–µ–≤–∞ */
    .tree-controls {
        padding: 10px; background: #f8f9fa;
        border: 1px solid #dee2e6; border-bottom: none;
        border-radius: 4px 4px 0 0;
        display: flex; gap: 10px; align-items: center; flex-wrap: wrap;
    }
    .tree-btn {
        padding: 6px 12px; background: white;
        border: 1px solid #ced4da; border-radius: 4px;
        cursor: pointer; font-size: 13px; transition: all 0.2s;
    }
    .tree-btn:hover { background: #e9ecef; border-color: #adb5bd; }
    .tree-search-container { flex: 1; max-width: 300px; }
    .tree-search {
        width: 100%; padding: 6px 12px;
        border: 1px solid #ced4da; border-radius: 4px; font-size: 13px;
    }
    .tree-search:focus {
        outline: none; border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }

    /* –ì—Ä—É–ø–ø–æ–≤–æ–π —á–µ–∫–±–æ–∫—Å –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è/–æ—Ç–¥–µ–ª–∞ */
    .group-checkbox {
        cursor: pointer; width: 16px; height: 16px;
    }

    /* –ö–Ω–æ–ø–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ –≥—Ä—É–ø–ø—ã */
    .group-generate-btn {
        padding: 2px 8px; font-size: 11px;
        background: #28a745; color: white; border: none;
        border-radius: 3px; cursor: pointer; margin-left: 6px;
        white-space: nowrap; vertical-align: middle;
        display: inline-block;
    }
    .group-generate-btn:hover { background: #218838; }
</style>
{% endblock %}

{% block content %}
<div class="ot-card-container">
    <div class="page-header">
        <h4 class="mb-2">{{ title }}</h4>
        <p class="page-description">
            –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –¥–ª—è –º–∞—Å—Å–æ–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ª–∏—á–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ –ø–æ –æ—Ö—Ä–∞–Ω–µ —Ç—Ä—É–¥–∞.
            –ú–æ–∂–Ω–æ –≤—ã–±–∏—Ä–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏–ª–∏ —Ü–µ–ª—ã–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è/–æ—Ç–¥–µ–ª—ã.
        </p>
    </div>

    <!-- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–∞ -->
    <div class="date-input-section">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 10px;">
            <div>
                <label for="date_povtorny">üìÖ –î–∞—Ç–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–∞:</label>
                <input type="date" id="date_povtorny" name="date_povtorny"
                       value="{{ default_date }}" required style="width: 100%;">
            </div>
            <div>
                <label for="instruction_type">üìã –í–∏–¥ –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–∞:</label>
                <select id="instruction_type" name="instruction_type" required
                        style="width: 100%; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px;">
                    {% for value, label in instruction_types %}
                    <option value="{{ value }}" {% if value == '–ü–æ–≤—Ç–æ—Ä–Ω—ã–π' %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div id="reasonField" style="display: none;">
            <label for="instruction_reason">üìù –ü—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –≤–Ω–µ–ø–ª–∞–Ω–æ–≤–æ–≥–æ/—Ü–µ–ª–µ–≤–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–∞:</label>
            <input type="text" id="instruction_reason" name="instruction_reason"
                   placeholder="–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–∞"
                   style="width: 100%; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px;">
        </div>
    </div>

    <!-- –§–∏–ª—å—Ç—Ä –ø–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ -->
    {% if org_options|length >= 1 %}
    <div class="card mb-3">
        <div class="card-body">
            <form method="GET" action="" class="row g-2 align-items-end">
                <div class="col-md-8 col-lg-6">
                    <label for="orgSelect" class="form-label fw-bold">
                        üè¢ {% if org_options|length == 1 %}–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è:{% else %}–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é:{% endif %}
                    </label>
                    <select name="org" id="orgSelect" class="form-select"
                            {% if org_options|length > 1 %}required{% endif %}
                            {% if org_options|length == 1 %}disabled{% endif %}>
                        {% if org_options|length > 1 %}
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é --</option>
                        {% endif %}
                        {% for org in org_options %}
                        <option value="{{ org.id }}" {% if org.id == selected_org_id %}selected{% endif %}>
                            {{ org.short_name_ru }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                {% if org_options|length > 1 %}
                <div class="col-md-4 col-lg-2">
                    <button type="submit" class="btn btn-primary w-100">–ü–æ–∫–∞–∑–∞—Ç—å</button>
                </div>
                {% endif %}
            </form>
        </div>
    </div>
    {% endif %}

    {% if not show_tree %}
    <div class="alert alert-info" role="alert">
        <h5 class="alert-heading">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
        {% if org_options|length == 0 %}
        <p class="mb-0">–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏.</p>
        {% elif org_options|length > 1 %}
        <p class="mb-0">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ.</p>
        {% endif %}
    </div>
    {% else %}

    <form method="post" action="{% url 'directory:ot_card:mass_generation_generate' %}" id="mass-generation-form">
        {% csrf_token %}

        <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
        <div class="action-buttons">
            <button type="submit" class="btn btn-success" id="generate-btn">
                –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏
            </button>
            <div class="form-check form-check-inline ms-3">
                <input class="form-check-input" type="checkbox" id="selectAll">
                <label class="form-check-label" for="selectAll">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ—Ö</label>
            </div>
            <span class="selected-info">–í—ã–±—Ä–∞–Ω–æ: <strong><span id="selectedCount">0</span></strong>{% if employees_count %} –∏–∑ {{ employees_count }}{% endif %}</span>
        </div>

        <!-- –ö–æ–Ω—Ç—Ä–æ–ª—ã –¥–µ—Ä–µ–≤–∞ -->
        <div class="tree-controls">
            <button type="button" class="tree-btn expand-all">‚Üì –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ</button>
            <button type="button" class="tree-btn collapse-all">‚Üë –°–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ</button>
            <div class="tree-search-container">
                <input type="text" class="tree-search" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º...">
            </div>
        </div>

        <!-- –î—Ä–µ–≤–æ–≤–∏–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ -->
        <div class="table-responsive">
            <table id="result_list" style="table-layout: fixed; width: 100%;">
                <colgroup>
                    <col style="width: 30px;">
                    <col style="width: 55%;">
                    <col style="width: auto;">
                </colgroup>
                <thead>
                    <tr>
                        <th class="column-checkbox" style="width: 30px; padding: 4px 2px;"></th>
                        <th class="column-name">–§–ò–û / –°—Ç—Ä—É–∫—Ç—É—Ä–∞</th>
                        <th class="column-position">–î–æ–ª–∂–Ω–æ—Å—Ç—å</th>
                    </tr>
                </thead>
                <tbody>
                    {% for org, org_data in tree.items %}
                        {# –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è #}
                        <tr class="tree-row" data-level="0" data-node-id="org_{{ org.id }}">
                            <td class="column-checkbox">
                                <input type="checkbox" class="form-check-input group-checkbox"
                                       data-group="org_{{ org.id }}">
                            </td>
                            <td class="field-name">
                                <button type="button" class="toggle-btn" data-state="expanded">[-]</button>
                                <span class="tree-icon">{{ tree_settings.icons.organization }}</span>
                                <strong>{{ org_data.name }}</strong>
                                <button type="button" class="group-generate-btn" data-generate-group="org_{{ org.id }}">üìã –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
                            </td>
                            <td></td>
                        </tr>

                        {# –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –±–µ–∑ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è #}
                        {% for employee in org_data.items %}
                            <tr class="tree-row" data-level="1" data-parent-id="org_{{ org.id }}">
                                <td class="column-checkbox">
                                    <input type="checkbox" class="form-check-input employee-checkbox"
                                           name="employee_ids" value="{{ employee.id }}"
                                           data-groups="org_{{ org.id }}">
                                </td>
                                <td class="field-name">
                                    <span class="tree-icon">{{ tree_settings.icons.employee }}</span>
                                    {{ employee.full_name_nominative }}
                                </td>
                                <td>{{ employee.position.position_name }}</td>
                            </tr>
                        {% endfor %}

                        {# –ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è #}
                        {% for sub, sub_data in org_data.subdivisions.items %}
                            <tr class="tree-row" data-level="1" data-parent-id="org_{{ org.id }}" data-node-id="sub_{{ sub.id }}">
                                <td class="column-checkbox">
                                    <input type="checkbox" class="form-check-input group-checkbox"
                                           data-group="sub_{{ sub.id }}"
                                           data-parent-group="org_{{ org.id }}">
                                </td>
                                <td class="field-name">
                                    <button type="button" class="toggle-btn" data-state="expanded">[-]</button>
                                    <span class="tree-icon">{{ tree_settings.icons.subdivision }}</span>
                                    {{ sub_data.name }}
                                    <button type="button" class="group-generate-btn" data-generate-group="sub_{{ sub.id }}">üìã –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
                                </td>
                                <td></td>
                            </tr>

                            {# –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –±–µ–∑ –æ—Ç–¥–µ–ª–∞ #}
                            {% for employee in sub_data.items %}
                                <tr class="tree-row" data-level="2" data-parent-id="sub_{{ sub.id }}">
                                    <td class="column-checkbox">
                                        <input type="checkbox" class="form-check-input employee-checkbox"
                                               name="employee_ids" value="{{ employee.id }}"
                                               data-groups="org_{{ org.id }} sub_{{ sub.id }}">
                                    </td>
                                    <td class="field-name">
                                        <span class="tree-icon">{{ tree_settings.icons.employee }}</span>
                                        {{ employee.full_name_nominative }}
                                    </td>
                                    <td>{{ employee.position.position_name }}</td>
                                </tr>
                            {% endfor %}

                            {# –û—Ç–¥–µ–ª—ã #}
                            {% for dept, dept_data in sub_data.departments.items %}
                                <tr class="tree-row" data-level="2" data-parent-id="sub_{{ sub.id }}" data-node-id="dept_{{ dept.id }}">
                                    <td class="column-checkbox">
                                        <input type="checkbox" class="form-check-input group-checkbox"
                                               data-group="dept_{{ dept.id }}"
                                               data-parent-group="sub_{{ sub.id }}">
                                    </td>
                                    <td class="field-name">
                                        <button type="button" class="toggle-btn" data-state="expanded">[-]</button>
                                        <span class="tree-icon">{{ tree_settings.icons.department }}</span>
                                        {{ dept_data.name }}
                                    </td>
                                    <td></td>
                                </tr>

                                {# –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –≤ –æ—Ç–¥–µ–ª–µ #}
                                {% for employee in dept_data.items %}
                                    <tr class="tree-row" data-level="3" data-parent-id="dept_{{ dept.id }}">
                                        <td class="column-checkbox">
                                            <input type="checkbox" class="form-check-input employee-checkbox"
                                                   name="employee_ids" value="{{ employee.id }}"
                                                   data-groups="org_{{ org.id }} sub_{{ sub.id }} dept_{{ dept.id }}">
                                        </td>
                                        <td class="field-name">
                                            <span class="tree-icon">{{ tree_settings.icons.employee }}</span>
                                            {{ employee.full_name_nominative }}
                                        </td>
                                        <td>{{ employee.position.position_name }}</td>
                                    </tr>
                                {% endfor %}
                            {% endfor %}
                        {% endfor %}
                    {% empty %}
                        <tr>
                            <td colspan="3" class="text-center text-muted">
                                –ù–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–∞—Ä—Ç–æ—á–µ–∫.
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="row mt-3">
            <div class="col">
                <button type="submit" class="btn btn-success">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏</button>
                <a href="{% url 'directory:employee_home' %}" class="btn btn-secondary ms-2">–ù–∞–∑–∞–¥</a>
            </div>
        </div>
    </form>

    {% endif %}
</div>

<!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
<div id="loading-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
        <div class="spinner-border text-light" role="status" style="width: 4rem; height: 4rem;">
            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        </div>
        <p class="text-light mt-3 fs-5">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫...</p>
        <p class="text-light">–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'admin/js/tree_view.js' %}"></script>
<script src="{% static 'admin/js/tree_search.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('mass-generation-form');
    if (!form) return;

    const allEmployeeCheckboxes = Array.from(document.querySelectorAll('.employee-checkbox'));
    const allGroupCheckboxes = Array.from(document.querySelectorAll('.group-checkbox'));
    const selectAll = document.getElementById('selectAll');
    const counter = document.getElementById('selectedCount');
    const loadingOverlay = document.getElementById('loading-overlay');
    const submitButtons = form.querySelectorAll('button[type="submit"]');

    // –ü–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç–∏–µ –ø–æ–ª—è –ø—Ä–∏—á–∏–Ω—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–∏–¥–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–∞
    const instructionTypeSelect = document.getElementById('instruction_type');
    const reasonField = document.getElementById('reasonField');

    function toggleReasonField() {
        const selectedType = instructionTypeSelect.value;
        reasonField.style.display =
            (selectedType === '–í–Ω–µ–ø–ª–∞–Ω–æ–≤—ã–π' || selectedType === '–¶–µ–ª–µ–≤–æ–π') ? 'block' : 'none';
    }

    if (instructionTypeSelect) {
        instructionTypeSelect.addEventListener('change', toggleReasonField);
        toggleReasonField();
    }

    // === –õ–æ–≥–∏–∫–∞ —á–µ–∫–±–æ–∫—Å–æ–≤ ===

    function updateCounter() {
        const selected = allEmployeeCheckboxes.filter(cb => cb.checked).length;
        counter.textContent = selected;
    }

    // –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ employee-—á–µ–∫–±–æ–∫—Å—ã, –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—â–∏–µ –≥—Ä—É–ø–ø–µ
    function getEmployeesInGroup(groupId) {
        return allEmployeeCheckboxes.filter(cb => {
            const groups = cb.getAttribute('data-groups') || '';
            return groups.split(' ').includes(groupId);
        });
    }

    // –ü–æ–ª—É—á–∏—Ç—å –¥–æ—á–µ—Ä–Ω–∏–µ group-—á–µ–∫–±–æ–∫—Å—ã
    function getChildGroups(groupId) {
        return allGroupCheckboxes.filter(cb => cb.getAttribute('data-parent-group') === groupId);
    }

    // –û–±–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥—Ä—É–ø–ø–æ–≤–æ–≥–æ —á–µ–∫–±–æ–∫—Å–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –µ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
    function updateGroupState(groupCheckbox) {
        const groupId = groupCheckbox.getAttribute('data-group');
        const employees = getEmployeesInGroup(groupId);

        if (employees.length === 0) {
            groupCheckbox.checked = false;
            groupCheckbox.indeterminate = false;
            return;
        }

        const checkedCount = employees.filter(cb => cb.checked).length;

        if (checkedCount === 0) {
            groupCheckbox.checked = false;
            groupCheckbox.indeterminate = false;
        } else if (checkedCount === employees.length) {
            groupCheckbox.checked = true;
            groupCheckbox.indeterminate = false;
        } else {
            groupCheckbox.checked = false;
            groupCheckbox.indeterminate = true;
        }
    }

    // –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ –≥—Ä—É–ø–ø–æ–≤—ã–µ —á–µ–∫–±–æ–∫—Å—ã —Å–Ω–∏–∑—É –≤–≤–µ—Ä—Ö
    function updateAllGroupStates() {
        // –°–Ω–∞—á–∞–ª–∞ –æ—Ç–¥–µ–ª—ã (–Ω–∏–∂–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å), –ø–æ—Ç–æ–º –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è, –ø–æ—Ç–æ–º –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
        const deptGroups = allGroupCheckboxes.filter(cb => cb.getAttribute('data-group').startsWith('dept_'));
        const subGroups = allGroupCheckboxes.filter(cb => cb.getAttribute('data-group').startsWith('sub_'));
        const orgGroups = allGroupCheckboxes.filter(cb => cb.getAttribute('data-group').startsWith('org_'));

        deptGroups.forEach(updateGroupState);
        subGroups.forEach(updateGroupState);
        orgGroups.forEach(updateGroupState);

        updateCounter();

        // –û–±–Ω–æ–≤–∏—Ç—å selectAll
        if (selectAll) {
            const total = allEmployeeCheckboxes.length;
            const checked = allEmployeeCheckboxes.filter(cb => cb.checked).length;
            if (checked === 0) {
                selectAll.checked = false;
                selectAll.indeterminate = false;
            } else if (checked === total) {
                selectAll.checked = true;
                selectAll.indeterminate = false;
            } else {
                selectAll.checked = false;
                selectAll.indeterminate = true;
            }
        }
    }

    // –ö–ª–∏–∫ –ø–æ –≥—Ä—É–ø–ø–æ–≤–æ–º—É —á–µ–∫–±–æ–∫—Å—É ‚Äî –≤—ã–±—Ä–∞—Ç—å/—Å–Ω—è—Ç—å –≤—Å–µ—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –≤ –≥—Ä—É–ø–ø–µ
    allGroupCheckboxes.forEach(function(groupCb) {
        groupCb.addEventListener('change', function() {
            const groupId = this.getAttribute('data-group');
            const checked = this.checked;

            // –í—ã–±—Ä–∞—Ç—å –≤—Å–µ—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –≤ —ç—Ç–æ–π –≥—Ä—É–ø–ø–µ
            getEmployeesInGroup(groupId).forEach(cb => { cb.checked = checked; });

            // –í—ã–±—Ä–∞—Ç—å –¥–æ—á–µ—Ä–Ω–∏–µ –≥—Ä—É–ø–ø–æ–≤—ã–µ —á–µ–∫–±–æ–∫—Å—ã
            getChildGroups(groupId).forEach(childGroup => {
                childGroup.checked = checked;
                childGroup.indeterminate = false;
            });

            updateAllGroupStates();
        });
    });

    // –ö–ª–∏–∫ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–µ –≥—Ä—É–ø–ø—ã
    allEmployeeCheckboxes.forEach(function(empCb) {
        empCb.addEventListener('change', function() {
            updateAllGroupStates();
        });
    });

    // –í—ã–±—Ä–∞—Ç—å –≤—Å–µ—Ö
    if (selectAll) {
        selectAll.addEventListener('change', function() {
            const checked = this.checked;
            allEmployeeCheckboxes.forEach(cb => { cb.checked = checked; });
            allGroupCheckboxes.forEach(cb => {
                cb.checked = checked;
                cb.indeterminate = false;
            });
            updateCounter();
        });
    }

    // –ù–∞—á–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    updateAllGroupStates();

    // === –ö–Ω–æ–ø–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ –≥—Ä—É–ø–ø—ã ===
    document.querySelectorAll('.group-generate-btn').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const groupId = this.getAttribute('data-generate-group');

            // –°–Ω–∏–º–∞–µ–º –≤—Å–µ —á–µ–∫–±–æ–∫—Å—ã
            allEmployeeCheckboxes.forEach(cb => { cb.checked = false; });
            allGroupCheckboxes.forEach(cb => { cb.checked = false; cb.indeterminate = false; });

            // –í—ã–±–∏—Ä–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ —ç—Ç–æ–π –≥—Ä—É–ø–ø—ã
            const groupEmployees = getEmployeesInGroup(groupId);
            if (groupEmployees.length === 0) {
                alert('–í —ç—Ç–æ–π –≥—Ä—É–ø–ø–µ –Ω–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤.');
                return;
            }
            groupEmployees.forEach(cb => { cb.checked = true; });

            updateAllGroupStates();

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É
            form.dispatchEvent(new Event('submit', { cancelable: true }));
        });
    });

    // === –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã (async fetch –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è ZIP) ===
    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        const checked = allEmployeeCheckboxes.filter(cb => cb.checked);
        if (checked.length === 0) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞.');
            return;
        }

        loadingOverlay.style.display = 'block';
        submitButtons.forEach(btn => { btn.disabled = true; });

        try {
            // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã + –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–∞ (–æ–Ω–∏ –≤–Ω–µ —Ñ–æ—Ä–º—ã)
            const formData = new FormData(form);

            // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–∞ (–æ–Ω–∏ –≤ date-input-section, –≤–Ω–µ <form>)
            const datePovtorny = document.getElementById('date_povtorny');
            const instructionType = document.getElementById('instruction_type');
            const instructionReason = document.getElementById('instruction_reason');

            if (datePovtorny) formData.set('date_povtorny', datePovtorny.value);
            if (instructionType) formData.set('instruction_type', instructionType.value);
            if (instructionReason) formData.set('instruction_reason', instructionReason.value);

            const response = await fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' + response.status);
            }

            const blob = await response.blob();
            const contentDisposition = response.headers.get('Content-Disposition') || '';
            const filenameMatch = contentDisposition.match(/filename\*=UTF-8''([^;]+)/i)
                || contentDisposition.match(/filename="([^"]+)"/i);
            const filename = filenameMatch ? decodeURIComponent(filenameMatch[1]) : '–õ–∏—á–Ω—ã–µ_–∫–∞—Ä—Ç–æ—á–∫–∏_–û–¢.zip';

            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);
        } catch (err) {
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å –∞—Ä—Ö–∏–≤: ' + err.message);
        } finally {
            loadingOverlay.style.display = 'none';
            submitButtons.forEach(btn => { btn.disabled = false; });
        }
    });
});
</script>
{% endblock %}
