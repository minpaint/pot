{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }} - OT Online{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col">
            <h2>{{ title }}</h2>
            <p class="text-muted">–ú–∞—Å—Å–æ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ª–∏—á–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ –ø–æ –æ—Ö—Ä–∞–Ω–µ —Ç—Ä—É–¥–∞ –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</p>
        </div>
    </div>

    {% if subdivisions or orgs_no_subdivision %}
    <form method="post" action="{% url 'directory:ot_card:mass_generation_generate' %}" id="mass-generation-form">
        {% csrf_token %}

        <!-- –°–∏–Ω–∏–π –±–ª–æ–∫: –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–∞ (–∫–∞–∫ –≤ –∂—É—Ä–Ω–∞–ª–µ –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–µ–π) -->
        <div class="date-input-section">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 10px;">
                <div>
                    <label for="date_povtorny">üìÖ –î–∞—Ç–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–∞:</label>
                    <input type="date" id="date_povtorny" name="date_povtorny"
                           value="{{ default_date }}" required style="width: 100%;">
                </div>
                <div>
                    <label for="instruction_type">üìã –í–∏–¥ –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–∞:</label>
                    <select id="instruction_type" name="instruction_type" required
                            style="width: 100%; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px;">
                        {% for value, label in instruction_types %}
                        <option value="{{ value }}" {% if value == '–ü–æ–≤—Ç–æ—Ä–Ω—ã–π' %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div id="reasonField" style="display: none;">
                <label for="instruction_reason">üìù –ü—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –≤–Ω–µ–ø–ª–∞–Ω–æ–≤–æ–≥–æ/—Ü–µ–ª–µ–≤–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–∞:</label>
                <input type="text" id="instruction_reason" name="instruction_reason"
                       placeholder="–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–∞"
                       style="width: 100%; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px;">
            </div>
        </div>

        <!-- –§–∏–ª—å—Ç—Ä –ø–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ -->
        <div class="row mb-3">
            <div class="col-md-4 mb-3 mb-md-0">
                <label for="organization-filter" class="form-label">–§–∏–ª—å—Ç—Ä –ø–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</label>
                <select id="organization-filter" class="form-select">
                    <option value="">–í—Å–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</option>
                    {% for org in all_organizations %}
                    <option value="{{ org.id }}">{{ org.full_name_ru }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
        <div class="row mb-3">
            <div class="col">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm btn-outline-primary" id="select-all">
                        –í—ã–±—Ä–∞—Ç—å –≤—Å–µ
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="deselect-all">
                        –°–Ω—è—Ç—å –≤—Å–µ
                    </button>
                </div>
                <button type="submit" class="btn btn-success ms-3" id="generate-btn">
                    –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏
                </button>
                <span class="ms-3 text-muted" id="selected-count">–í—ã–±—Ä–∞–Ω–æ: 0</span>
            </div>
        </div>

        <!-- –¢–∞–±–ª–∏—Ü–∞ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π -->
        <div class="card">
            <div class="card-body">
                <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–≥–¥–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è -->
                <div id="no-organization-message" class="alert alert-info text-center" style="display: none;">
                    –í—ã–±–µ—Ä–∏—Ç–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è
                </div>

                <div class="table-responsive">
                    <table class="table table-hover table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th style="width: 50px;">
                                    <input type="checkbox" id="select-all-checkbox" class="form-check-input">
                                </th>
                                <th>–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</th>
                                <th>–°—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ</th>
                                <th class="text-center">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</th>
                            </tr>
                        </thead>
                        <tbody id="subdivisions-tbody">
                            {% for subdivision in subdivisions %}
                            <tr class="subdivision-row" data-organization-id="{{ subdivision.organization.id }}">
                                <td>
                                    <input type="checkbox"
                                           name="subdivision_ids"
                                           value="{{ subdivision.id }}"
                                           class="form-check-input subdivision-checkbox"
                                           data-count="{{ subdivision.employees_count }}">
                                </td>
                                <td>{{ subdivision.organization.full_name_ru }}</td>
                                <td>
                                    <strong>{{ subdivision.name }}</strong>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-info">{{ subdivision.employees_count }}</span>
                                </td>
                            </tr>
                            {% endfor %}
                            {% for item in orgs_no_subdivision %}
                            <tr class="subdivision-row" data-organization-id="{{ item.organization.id }}">
                                <td>
                                    <input type="checkbox"
                                           name="organization_ids"
                                           value="{{ item.organization.id }}"
                                           class="form-check-input subdivision-checkbox"
                                           data-count="{{ item.employees_count }}">
                                </td>
                                <td>{{ item.organization.full_name_ru }}</td>
                                <td>
                                    <em class="text-muted">–ë–µ–∑ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è</em>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-info">{{ item.employees_count }}</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col">
                <button type="submit" class="btn btn-success">
                    –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏
                </button>
                <a href="{% url 'directory:employee_home' %}" class="btn btn-secondary">
                    –ù–∞–∑–∞–¥
                </a>
            </div>
        </div>
    </form>

    {% else %}
    <div class="alert alert-info">
        <h5>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</h5>
        <p>–ù–µ –Ω–∞–π–¥–µ–Ω–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã—Ö –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏.</p>
        <p>–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ:</p>
        <ul>
            <li>–ï—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ —Å –¥–æ–ª–∂–Ω–æ—Å—Ç—è–º–∏</li>
            <li>–£ –≤–∞—Å –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è–º</li>
        </ul>
        <a href="{% url 'directory:employee_home' %}" class="btn btn-primary mt-2">
            –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é
        </a>
    </div>
    {% endif %}
</div>

<!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
<div id="loading-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
        <div class="spinner-border text-light" role="status" style="width: 4rem; height: 4rem;">
            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        </div>
        <p class="text-light mt-3 fs-5">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫...</p>
        <p class="text-light">–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è</p>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('mass-generation-form');

    if (!form) return;

    const checkboxes = document.querySelectorAll('.subdivision-checkbox');
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const selectAllBtn = document.getElementById('select-all');
    const deselectAllBtn = document.getElementById('deselect-all');
    const selectedCountSpan = document.getElementById('selected-count');
    const loadingOverlay = document.getElementById('loading-overlay');
    const submitButtons = document.querySelectorAll('button[type="submit"]');
    const organizationFilter = document.getElementById('organization-filter');
    const subdivisionRows = document.querySelectorAll('.subdivision-row');
    const noOrgMessage = document.getElementById('no-organization-message');
    const subdivisionsTable = document.querySelector('.table-responsive');

    // –ü–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç–∏–µ –ø–æ–ª—è –ø—Ä–∏—á–∏–Ω—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–∏–¥–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–∞
    const instructionTypeSelect = document.getElementById('instruction_type');
    const reasonField = document.getElementById('reasonField');

    function toggleReasonField() {
        const selectedType = instructionTypeSelect.value;
        if (selectedType === '–í–Ω–µ–ø–ª–∞–Ω–æ–≤—ã–π' || selectedType === '–¶–µ–ª–µ–≤–æ–π') {
            reasonField.style.display = 'block';
        } else {
            reasonField.style.display = 'none';
        }
    }

    if (instructionTypeSelect) {
        instructionTypeSelect.addEventListener('change', toggleReasonField);
        toggleReasonField(); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    }

    // –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
    function applyOrganizationFilter() {
        const selectedOrgId = organizationFilter.value;

        subdivisionRows.forEach(row => {
            if (selectedOrgId === '' || row.dataset.organizationId === selectedOrgId) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
                // –°–Ω–∏–º–∞–µ–º –≥–∞–ª–æ—á–∫—É —Å —Å–∫—Ä—ã—Ç—ã—Ö –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π
                const checkbox = row.querySelector('.subdivision-checkbox');
                if (checkbox) {
                    checkbox.checked = false;
                }
            }
        });

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –∏ –∏—Ö –Ω–µ—Å–∫–æ–ª—å–∫–æ
        if (selectedOrgId === '' && organizationFilter.options.length > 2) {
            noOrgMessage.style.display = 'block';
            subdivisionsTable.style.display = 'none';
        } else {
            noOrgMessage.style.display = 'none';
            subdivisionsTable.style.display = 'block';
        }

        updateSelectedCount();
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞
    organizationFilter.addEventListener('change', applyOrganizationFilter);

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    const orgOptions = organizationFilter.querySelectorAll('option');
    const orgCount = orgOptions.length - 1;

    if (orgCount === 1) {
        organizationFilter.selectedIndex = 1;
        applyOrganizationFilter();
    } else if (orgCount > 1) {
        subdivisionRows.forEach(row => {
            row.style.display = 'none';
        });
        noOrgMessage.style.display = 'block';
        subdivisionsTable.style.display = 'none';
    } else {
        applyOrganizationFilter();
    }

    function getVisibleCheckboxes() {
        return Array.from(checkboxes).filter(cb => {
            const row = cb.closest('tr');
            return row && row.style.display !== 'none';
        });
    }

    function updateSelectedCount() {
        const checked = document.querySelectorAll('.subdivision-checkbox:checked');
        let totalEmployees = 0;
        checked.forEach(cb => {
            totalEmployees += parseInt(cb.dataset.count || 0);
        });
        selectedCountSpan.textContent = `–í—ã–±—Ä–∞–Ω–æ: ${checked.length} (~${totalEmployees} –∫–∞—Ä—Ç–æ—á–µ–∫)`;

        const visibleCheckboxes = getVisibleCheckboxes();
        const checkedVisible = visibleCheckboxes.filter(cb => cb.checked);

        if (checkedVisible.length === 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        } else if (checkedVisible.length === visibleCheckboxes.length) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
        } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true;
        }
    }

    checkboxes.forEach(cb => {
        cb.addEventListener('change', updateSelectedCount);
    });

    selectAllCheckbox.addEventListener('change', function() {
        const visibleCheckboxes = getVisibleCheckboxes();
        visibleCheckboxes.forEach(cb => {
            cb.checked = this.checked;
        });
        updateSelectedCount();
    });

    selectAllBtn.addEventListener('click', function() {
        const visibleCheckboxes = getVisibleCheckboxes();
        visibleCheckboxes.forEach(cb => {
            cb.checked = true;
        });
        updateSelectedCount();
    });

    deselectAllBtn.addEventListener('click', function() {
        const visibleCheckboxes = getVisibleCheckboxes();
        visibleCheckboxes.forEach(cb => {
            cb.checked = false;
        });
        updateSelectedCount();
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    form.addEventListener('submit', async function(e) {
        const checked = document.querySelectorAll('.subdivision-checkbox:checked');

        if (checked.length === 0) {
            e.preventDefault();
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É');
            return false;
        }

        e.preventDefault();

        loadingOverlay.style.display = 'block';
        submitButtons.forEach(btn => {
            btn.disabled = true;
        });

        try {
            const formData = new FormData(form);
            const response = await fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
            }

            const blob = await response.blob();
            const contentDisposition = response.headers.get('Content-Disposition') || '';
            const filenameMatch = contentDisposition.match(/filename\*=UTF-8''([^;]+)/i)
                || contentDisposition.match(/filename="([^"]+)"/i);
            const filename = filenameMatch ? decodeURIComponent(filenameMatch[1]) : '–õ–∏—á–Ω—ã–µ_–∫–∞—Ä—Ç–æ—á–∫–∏_–û–¢.zip';

            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);
        } catch (err) {
            alert(`–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å –∞—Ä—Ö–∏–≤: ${err.message}`);
        } finally {
            loadingOverlay.style.display = 'none';
            submitButtons.forEach(btn => {
                btn.disabled = false;
            });
        }
    });

    updateSelectedCount();
});
</script>

<style>
/* –°–∏–Ω–∏–π –±–ª–æ–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–∞ (–∫–∞–∫ –≤ –∂—É—Ä–Ω–∞–ª–µ –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–µ–π) */
.date-input-section {
    background: #e7f3ff;
    border: 2px solid #0066cc;
    border-radius: 6px;
    padding: 15px;
    margin-bottom: 20px;
}

.date-input-section label {
    font-weight: 600;
    font-size: 15px;
    color: #0066cc;
    display: block;
    margin-bottom: 8px;
}

.date-input-section input[type="date"] {
    padding: 8px 12px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 14px;
    width: 200px;
}

.date-input-section input[type="date"]:focus {
    outline: none;
    border-color: #0066cc;
    box-shadow: 0 0 0 0.2rem rgba(0,102,204,.25);
}

/* –¢–∞–±–ª–∏—Ü–∞ */
.table-hover tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.05);
}

.subdivision-checkbox,
#select-all-checkbox {
    cursor: pointer;
    width: 20px;
    height: 20px;
}
</style>
{% endblock %}
