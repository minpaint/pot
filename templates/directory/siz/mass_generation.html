{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }} - OT Online{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col">
            <h2>üõ°Ô∏è {{ title }}</h2>
            <p class="text-muted">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫ –°–ò–ó –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</p>
        </div>
    </div>

    <!-- ====== –ù–ê–í–ò–ì–ê–¶–ò–Ø –í–ö–õ–ê–î–û–ö ====== -->
    <ul class="nav nav-tabs mb-4" id="sizCardTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="by-employee-tab" data-bs-toggle="tab"
                    data-bs-target="#by-employee" type="button" role="tab">
                üë§ –ü–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="by-subdivision-tab" data-bs-toggle="tab"
                    data-bs-target="#by-subdivision" type="button" role="tab">
                üè¢ –ü–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è–º
            </button>
        </li>
    </ul>

    <div class="tab-content" id="sizCardTabsContent">
        <!-- ====== –í–ö–õ–ê–î–ö–ê 1: –ü–û –°–û–¢–†–£–î–ù–ò–ö–£ ====== -->
        <div class="tab-pane fade show active" id="by-employee" role="tabpanel">
            <div class="card">
                <div class="card-body">
                    <h5 class="mb-3">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–∞—Ä—Ç–æ—á–∫–æ–π –°–ò–ó</h5>

                    <!-- –§–æ—Ä–º–∞ –≤—ã–±–æ—Ä–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ -->
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <label for="employee-select" class="form-label">
                                –°–æ—Ç—Ä—É–¥–Ω–∏–∫ <span class="text-danger">*</span>
                            </label>
                            <select id="employee-select" class="form-control" style="width: 100%;">
                                <option value="">-- –ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –§–ò–û —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ --</option>
                            </select>
                            <small class="form-text text-muted">
                                –í–≤–µ–¥–∏—Ç–µ –Ω–µ –º–µ–Ω–µ–µ 3 —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
                            </small>
                        </div>
                    </div>

                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–µ (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                    <div id="employee-info" class="d-none">
                        <hr>
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h6 class="text-muted">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–µ:</h6>
                                <table class="table table-sm">
                                    <tr>
                                        <th style="width: 40%;">–§–ò–û:</th>
                                        <td id="employee-fio"></td>
                                    </tr>
                                    <tr>
                                        <th>–î–æ–ª–∂–Ω–æ—Å—Ç—å:</th>
                                        <td id="employee-position"></td>
                                    </tr>
                                    <tr>
                                        <th>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</th>
                                        <td id="employee-subdivision"></td>
                                    </tr>
                                    <tr>
                                        <th>–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è:</th>
                                        <td id="employee-organization"></td>
                                    </tr>
                                </table>
                            </div>
                        </div>

                        <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
                        <div class="d-flex gap-3">
                            <a href="#" id="btn-go-to-personal-card" class="btn btn-primary">
                                üìã –ü–µ—Ä–µ–π—Ç–∏ –∫ –≤—ã–¥–∞—á–µ –°–ò–ó
                            </a>
                            <a href="#" id="btn-download-card" class="btn btn-success">
                                üì• –°–∫–∞—á–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É –°–ò–ó
                            </a>
                        </div>
                    </div>

                    <!-- Placeholder –∫–æ–≥–¥–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –Ω–µ –≤—ã–±—Ä–∞–Ω -->
                    <div id="employee-placeholder" class="alert alert-info">
                        ‚ÑπÔ∏è –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –∏–∑ —Å–ø–∏—Å–∫–∞, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
                    </div>
                </div>
            </div>
        </div>

        <!-- ====== –í–ö–õ–ê–î–ö–ê 2: –ü–û –ü–û–î–†–ê–ó–î–ï–õ–ï–ù–ò–Ø–ú ====== -->
        <div class="tab-pane fade" id="by-subdivision" role="tabpanel">
            {% if subdivisions or orgs_no_subdivision %}
            <form method="post" action="{% url 'directory:siz:mass_generation_generate' %}" id="mass-generation-form">
                {% csrf_token %}

                <div class="row mb-3">
                    <div class="col-md-4 mb-3 mb-md-0">
                        <label for="organization-filter" class="form-label">–§–∏–ª—å—Ç—Ä –ø–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</label>
                        <select id="organization-filter" class="form-select">
                            <option value="">–í—Å–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</option>
                            {% for org in all_organizations %}
                            <option value="{{ org.id }}">{{ org.full_name_ru }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-sm btn-outline-primary" id="select-all">
                                ‚úì –í—ã–±—Ä–∞—Ç—å –≤—Å–µ
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="deselect-all">
                                ‚úó –°–Ω—è—Ç—å –≤—Å–µ
                            </button>
                        </div>
                        <div class="d-inline-flex align-items-center ms-3">
                            <label for="id_issue_date" class="me-2 mb-0 text-muted text-nowrap">–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏</label>
                            <input type="date" name="issue_date" id="id_issue_date" class="form-control form-control-sm w-auto">
                        </div>
                        <button type="submit" class="btn btn-success ms-3" id="generate-btn">
                            üì• –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏ –°–ò–ó
                        </button>
                        <span class="ms-3 text-muted" id="selected-count">–í—ã–±—Ä–∞–Ω–æ: 0</span>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–≥–¥–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è -->
                        <div id="no-organization-message" class="alert alert-info text-center" style="display: none;">
                            <i class="bi bi-info-circle"></i>
                            üëÜ –í—ã–±–µ—Ä–∏—Ç–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover table-striped">
                                <thead class="table-dark">
                                    <tr>
                                        <th style="width: 50px;">
                                            <input type="checkbox" id="select-all-checkbox" class="form-check-input">
                                        </th>
                                        <th>–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</th>
                                        <th>–°—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ</th>
                                        <th class="text-center">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ —Å –Ω–æ—Ä–º–∞–º–∏ –°–ò–ó</th>
                                    </tr>
                                </thead>
                                <tbody id="subdivisions-tbody">
                                    {% for subdivision in subdivisions %}
                                    <tr class="subdivision-row" data-organization-id="{{ subdivision.organization.id }}">
                                        <td>
                                            <input type="checkbox"
                                                   name="subdivision_ids"
                                                   value="{{ subdivision.id }}"
                                                   class="form-check-input subdivision-checkbox"
                                                   data-count="{{ subdivision.employees_with_norms_count }}">
                                        </td>
                                        <td>{{ subdivision.organization.full_name_ru }}</td>
                                        <td>
                                            <strong>{{ subdivision.name }}</strong>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-info">{{ subdivision.employees_with_norms_count }}</span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                    {% for item in orgs_no_subdivision %}
                                    <tr class="subdivision-row" data-organization-id="{{ item.organization.id }}">
                                        <td>
                                            <input type="checkbox"
                                                   name="organization_ids"
                                                   value="{{ item.organization.id }}"
                                                   class="form-check-input subdivision-checkbox"
                                                   data-count="{{ item.employees_count }}">
                                        </td>
                                        <td>{{ item.organization.full_name_ru }}</td>
                                        <td>
                                            <em class="text-muted">–ë–µ–∑ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è</em>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-info">{{ item.employees_count }}</span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col">
                        <button type="submit" class="btn btn-success">
                            üì• –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏ –°–ò–ó
                        </button>
                        <a href="{% url 'directory:employee_home' %}" class="btn btn-secondary">
                            ‚Üê –ù–∞–∑–∞–¥
                        </a>
                    </div>
                </div>
            </form>

            {% else %}
            <div class="alert alert-info">
                <h5>‚ÑπÔ∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</h5>
                <p>–ù–µ –Ω–∞–π–¥–µ–Ω–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã—Ö –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π —Å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏, –¥–ª—è –∫–æ—Ç–æ—Ä—ã—Ö —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –Ω–æ—Ä–º—ã –°–ò–ó.</p>
                <p>–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ:</p>
                <ul>
                    <li>–°–æ–∑–¥–∞–Ω—ã –Ω–æ—Ä–º—ã –°–ò–ó –¥–ª—è –¥–æ–ª–∂–Ω–æ—Å—Ç–µ–π</li>
                    <li>–ï—Å—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –Ω–∞ –¥–æ–ª–∂–Ω–æ—Å—Ç—è—Ö —Å –Ω–æ—Ä–º–∞–º–∏ –°–ò–ó</li>
                    <li>–£ –≤–∞—Å –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è–º</li>
                </ul>
                <a href="{% url 'directory:employee_home' %}" class="btn btn-primary mt-2">
                    ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ (–æ–±—â–∏–π –¥–ª—è –æ–±–µ–∏—Ö –≤–∫–ª–∞–¥–æ–∫) -->
<div id="loading-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
        <div class="spinner-border text-light" role="status" style="width: 4rem; height: 4rem;">
            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        </div>
        <p class="text-light mt-3 fs-5">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        <p class="text-light">–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è</p>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ========== –ö–û–î –î–õ–Ø –í–ö–õ–ê–î–ö–ò "–ü–û –ü–û–î–†–ê–ó–î–ï–õ–ï–ù–ò–Ø–ú" (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π) ==========
    const form = document.getElementById('mass-generation-form');

    if (form) {
        const checkboxes = document.querySelectorAll('.subdivision-checkbox');
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        const selectAllBtn = document.getElementById('select-all');
        const deselectAllBtn = document.getElementById('deselect-all');
        const selectedCountSpan = document.getElementById('selected-count');
        const loadingOverlay = document.getElementById('loading-overlay');
        const generateBtn = document.getElementById('generate-btn');
        const submitButtons = document.querySelectorAll('button[type="submit"]');
        const organizationFilter = document.getElementById('organization-filter');
        const subdivisionRows = document.querySelectorAll('.subdivision-row');
        const noOrgMessage = document.getElementById('no-organization-message');
        const subdivisionsTable = document.querySelector('.table-responsive');

        // –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        function applyOrganizationFilter() {
            const selectedOrgId = organizationFilter.value;
            let hasVisibleRows = false;

            subdivisionRows.forEach(row => {
                if (selectedOrgId === '' || row.dataset.organizationId === selectedOrgId) {
                    row.style.display = '';
                    if (selectedOrgId !== '') {
                        hasVisibleRows = true;
                    }
                } else {
                    row.style.display = 'none';
                    // –°–Ω–∏–º–∞–µ–º –≥–∞–ª–æ—á–∫—É —Å —Å–∫—Ä—ã—Ç—ã—Ö –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π
                    const checkbox = row.querySelector('.subdivision-checkbox');
                    if (checkbox) {
                        checkbox.checked = false;
                    }
                }
            });

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –∏ –∏—Ö –Ω–µ—Å–∫–æ–ª—å–∫–æ
            if (selectedOrgId === '' && organizationFilter.options.length > 2) {
                noOrgMessage.style.display = 'block';
                subdivisionsTable.style.display = 'none';
            } else {
                noOrgMessage.style.display = 'none';
                subdivisionsTable.style.display = 'block';
            }

            updateSelectedCount();
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞
        organizationFilter.addEventListener('change', applyOrganizationFilter);

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        const orgOptions = organizationFilter.querySelectorAll('option');
        const orgCount = orgOptions.length - 1; // –ú–∏–Ω—É—Å –æ–ø—Ü–∏—è "–í—Å–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏"

        if (orgCount === 1) {
            // –ï—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è - –≤—ã–±–∏—Ä–∞–µ–º –µ—ë –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
            organizationFilter.selectedIndex = 1; // –í—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—É—é (–Ω–µ "–í—Å–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏")
            applyOrganizationFilter();
        } else if (orgCount > 1) {
            // –ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π - —Å–∫—Ä—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            subdivisionRows.forEach(row => {
                row.style.display = 'none';
            });
            noOrgMessage.style.display = 'block';
            subdivisionsTable.style.display = 'none';
        } else {
            // –ï—Å–ª–∏ –Ω–µ—Ç –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π (–Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å), –ø—Ä–∏–º–µ–Ω—è–µ–º –æ–±—ã—á–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä
            applyOrganizationFilter();
        }

        function getVisibleCheckboxes() {
            return Array.from(checkboxes).filter(cb => {
                const row = cb.closest('tr');
                return row && row.style.display !== 'none';
            });
        }

        function updateSelectedCount() {
            const checked = document.querySelectorAll('.subdivision-checkbox:checked');
            let totalEmployees = 0;
            checked.forEach(cb => {
                totalEmployees += parseInt(cb.dataset.count || 0);
            });
            selectedCountSpan.textContent = `–í—ã–±—Ä–∞–Ω–æ: ${checked.length} (‚âà${totalEmployees} –∫–∞—Ä—Ç–æ—á–µ–∫)`;

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥–ª–∞–≤–Ω–æ–≥–æ —á–µ–∫–±–æ–∫—Å–∞ —Å —É—á–µ—Ç–æ–º –≤–∏–¥–∏–º—ã—Ö —Å—Ç—Ä–æ–∫
            const visibleCheckboxes = getVisibleCheckboxes();
            const checkedVisible = visibleCheckboxes.filter(cb => cb.checked);

            if (checkedVisible.length === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (checkedVisible.length === visibleCheckboxes.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –ø–æ —á–µ–∫–±–æ–∫—Å–∞–º
        checkboxes.forEach(cb => {
            cb.addEventListener('change', updateSelectedCount);
        });

        // –í—ã–±—Ä–∞—Ç—å –≤—Å–µ (—Ç–æ–ª—å–∫–æ –≤–∏–¥–∏–º—ã–µ)
        selectAllCheckbox.addEventListener('change', function() {
            const visibleCheckboxes = getVisibleCheckboxes();
            visibleCheckboxes.forEach(cb => {
                cb.checked = this.checked;
            });
            updateSelectedCount();
        });

        selectAllBtn.addEventListener('click', function() {
            const visibleCheckboxes = getVisibleCheckboxes();
            visibleCheckboxes.forEach(cb => {
                cb.checked = true;
            });
            updateSelectedCount();
        });

        // –°–Ω—è—Ç—å –≤—Å–µ (—Ç–æ–ª—å–∫–æ –≤–∏–¥–∏–º—ã–µ)
        deselectAllBtn.addEventListener('click', function() {
            const visibleCheckboxes = getVisibleCheckboxes();
            visibleCheckboxes.forEach(cb => {
                cb.checked = false;
            });
            updateSelectedCount();
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
        form.addEventListener('submit', async function(e) {
            const checked = document.querySelectorAll('.subdivision-checkbox:checked');

            if (checked.length === 0) {
                e.preventDefault();
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ');
                return false;
            }

            e.preventDefault();

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            loadingOverlay.style.display = 'block';
            submitButtons.forEach(btn => {
                btn.disabled = true;
            });

            try {
                const formData = new FormData(form);
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
                }

                const blob = await response.blob();
                const contentDisposition = response.headers.get('Content-Disposition') || '';
                const filenameMatch = contentDisposition.match(/filename\*=UTF-8''([^;]+)/i)
                    || contentDisposition.match(/filename="([^"]+)"/i);
                const filename = filenameMatch ? decodeURIComponent(filenameMatch[1]) : '–ö–∞—Ä—Ç–æ—á–∫–∏_–°–ò–ó.zip';

                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
            } catch (err) {
                alert(`–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å –∞—Ä—Ö–∏–≤: ${err.message}`);
            } finally {
                loadingOverlay.style.display = 'none';
                submitButtons.forEach(btn => {
                    btn.disabled = false;
                });
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        updateSelectedCount();
    }

    // ========== –ö–û–î –î–õ–Ø –í–ö–õ–ê–î–ö–ò "–ü–û –°–û–¢–†–£–î–ù–ò–ö–£" (–Ω–æ–≤—ã–π) ==========

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Select2 –¥–ª—è autocomplete —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
    $('#employee-select').select2({
        ajax: {
            url: '{% url "directory:employee-for-commission-autocomplete" %}',
            dataType: 'json',
            delay: 250,
            data: function (params) {
                return {
                    q: params.term, // –ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
                    page: params.page || 1
                };
            },
            processResults: function (data) {
                return {
                    results: data.results,
                    pagination: data.pagination
                };
            },
            cache: true
        },
        minimumInputLength: 3,
        placeholder: '-- –ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –§–ò–û —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ --',
        allowClear: true,
        language: {
            inputTooShort: function () {
                return '–í–≤–µ–¥–∏—Ç–µ –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞';
            },
            searching: function () {
                return '–ü–æ–∏—Å–∫...';
            },
            noResults: function () {
                return '–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
            }
        }
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
    $('#employee-select').on('select2:select', function (e) {
        const employeeId = e.params.data.id;
        const employeeText = e.params.data.text;

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        $('#loading-overlay').show();

        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–µ
        fetch(`/directory/api/employee/${employeeId}/info/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞');
                }
                return response.json();
            })
            .then(data => {
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–µ
                $('#employee-fio').text(data.full_name_nominative || '-');
                $('#employee-position').text(data.position_name || '-');
                $('#employee-subdivision').text(data.subdivision_name || '-');
                $('#employee-organization').text(data.organization_name || '-');

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ –∫–Ω–æ–ø–∫–∞—Ö
                $('#btn-go-to-personal-card').attr('href',
                    `/directory/siz/personal-card/${employeeId}/`);
                $('#btn-download-card').attr('href',
                    `/directory/siz/siz-card/${employeeId}/`);

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –∏ –∫–Ω–æ–ø–∫–∞–º–∏
                $('#employee-placeholder').addClass('d-none');
                $('#employee-info').removeClass('d-none');
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–µ');
            })
            .finally(() => {
                $('#loading-overlay').hide();
            });
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –≤—ã–±–æ—Ä–∞
    $('#employee-select').on('select2:clear', function (e) {
        $('#employee-info').addClass('d-none');
        $('#employee-placeholder').removeClass('d-none');
    });
});
</script>

<style>
/* –°—Ç–∏–ª–∏ –¥–ª—è –≤–∫–ª–∞–¥–æ–∫ */
.nav-tabs {
    border-bottom: 2px solid #dee2e6;
}

.nav-tabs .nav-link {
    color: #495057;
    font-weight: 500;
    border: none;
    border-bottom: 3px solid transparent;
    padding: 0.75rem 1.5rem;
    transition: all 0.3s ease;
}

.nav-tabs .nav-link:hover {
    color: #0d6efd;
    border-bottom-color: #0d6efd;
    background-color: rgba(13, 110, 253, 0.05);
}

.nav-tabs .nav-link.active {
    color: #0d6efd;
    font-weight: 600;
    border-bottom-color: #0d6efd;
    background-color: rgba(13, 110, 253, 0.05);
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ "–ü–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è–º" */
.table-hover tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.05);
}

.subdivision-checkbox {
    cursor: pointer;
    width: 20px;
    height: 20px;
}

#select-all-checkbox {
    cursor: pointer;
    width: 20px;
    height: 20px;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ "–ü–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É" */
#by-employee .select2-container {
    font-size: 1rem;
}

#by-employee .select2-selection--single {
    height: 42px !important;
    border: 1.5px solid #e2e8f0 !important;
}

#by-employee .select2-selection__rendered {
    line-height: 40px !important;
}

/* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ */
#by-employee .btn {
    padding: 0.625rem 1.25rem;
    font-weight: 500;
}

#by-employee .gap-3 {
    gap: 1rem !important;
}

/* –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ */
#employee-info table th {
    font-weight: 600;
    color: #6c757d;
}

#employee-info table td {
    color: #212529;
}
</style>
{% endblock %}
